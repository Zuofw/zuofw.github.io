<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zuofw.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="ä¸ªäººç½‘ç«™ï¼Œå­¦ä¹ è®°å½•ï¼Œé¢è¯•è®°å½•å’Œç»éªŒæ€»ç»“ã€äº’è”ç½‘ä¸­ä¸€å—å±äºè‡ªå·±çš„å°çª">
<meta property="og:type" content="website">
<meta property="og:title" content="QingQiu&#39;Blog">
<meta property="og:url" content="https://zuofw.github.io/index.html">
<meta property="og:site_name" content="QingQiu&#39;Blog">
<meta property="og:description" content="ä¸ªäººç½‘ç«™ï¼Œå­¦ä¹ è®°å½•ï¼Œé¢è¯•è®°å½•å’Œç»éªŒæ€»ç»“ã€äº’è”ç½‘ä¸­ä¸€å—å±äºè‡ªå·±çš„å°çª">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="QingQiu">
<meta property="article:tag" content="åšå®¢ï¼Œå­¦ä¹ ï¼Œæˆé•¿">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://zuofw.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>QingQiu'Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">QingQiu'Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">æ¸…ç§‹çš„åšå®¢</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-fa fa-home"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-fa fa-tags"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-fa fa-th"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-fa fa-archive"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-github">

    <a href="https://github.com/Zuofw" rel="noopener" target="_blank"><i class="fa fa-fw fa-fab fa-github"></i>Github</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zuofw.github.io/2024/09/02/00/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QingQiu">
      <meta itemprop="description" content="ä¸ªäººç½‘ç«™ï¼Œå­¦ä¹ è®°å½•ï¼Œé¢è¯•è®°å½•å’Œç»éªŒæ€»ç»“ã€äº’è”ç½‘ä¸­ä¸€å—å±äºè‡ªå·±çš„å°çª">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QingQiu'Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/02/00/" class="post-title-link" itemprop="url">æ‰‹å†™rpc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-09-02 11:08:00" itemprop="dateCreated datePublished" datetime="2024-09-02T11:08:00+08:00">2024-09-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-10-09 14:09:46" itemprop="dateModified" datetime="2024-10-09T14:09:46+08:00">2024-10-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">æ·±å…¥ç†è§£ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>38k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ä¸ªäººåšå®¢"><a href="#ä¸ªäººåšå®¢" class="headerlink" title="ä¸ªäººåšå®¢"></a>ä¸ªäººåšå®¢</h2><p><a href="https://zuofw.github.io/">https://zuofw.github.io/</a><br>æœ¬é¡¹ç›®è¯¦ç»†ä»‹ç»å’Œå®ç°ï¼š<br><a href="https://zuofw.github.io/2024/09/02/00/">æ‰‹å†™rpc | QingQiuâ€™Blog (zuofw.github.io)</a><br>æºç åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/Zuofw/zuofw-rpc">Zuofw/zuofw-rpc: ä¸€ä¸ªåºŸç‰©çš„æ‰‹å†™rpc (github.com)</a></p>
<h2 id="é¡¹ç›®ä»‹ç»"><a href="#é¡¹ç›®ä»‹ç»" class="headerlink" title="é¡¹ç›®ä»‹ç»"></a>é¡¹ç›®ä»‹ç»</h2><p>zuofw-rpcæ˜¯ä¸€æ¬¾åŸºäºJavaã€Nettyã€Zookeeperå®ç°çš„RPCé€šä¿¡æ¡†æ¶ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹æ ¸å¿ƒç‰¹æ€§ï¼š</p>
<ol>
<li>ä½¿ç”¨â€å¾®å†…æ ¸+å¯æ’æ‹”â€æ¶æ„ï¼Œé€šè¿‡è‡ªå®šä¹‰SPIåŠ è½½æœºåˆ¶ï¼Œæ”¯æŒç¼“å­˜ï¼ŒåŠ¨æ€æ›¿ä»£æ‰©å±•ç‚¹ç»„ä»¶</li>
<li>çµæ´»ä½¿ç”¨è®¾è®¡æ¨¡å¼æ¥æé«˜ç³»ç»Ÿå¯æ‰©å±•æ€§ï¼Œå¦‚å•ä¾‹æ¨¡å¼ã€å·¥å‚æ¨¡å¼ã€å»ºé€ è€…æ¨¡å¼</li>
<li>å®ç°æœåŠ¡è°ƒç”¨è´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œæ”¯æŒè½®è¯¢ã€éšæœºã€ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼Œä¼˜åŒ–è°ƒç”¨ä½“éªŒ</li>
<li>é€šè¿‡è‡ªå®šä¹‰é€šä¿¡åè®®ã€æ”¯æŒå¤šç§åºåˆ—åŒ–æ–¹å¼ï¼ŒåŒæ—¶å®ç°Gzipå‹ç¼©ï¼Œæé«˜ç½‘ç»œä¼ è¾“æ•ˆç‡ã€‚</li>
<li>å®ç°è‡ªå®šä¹‰request - responseæ¨¡å‹ï¼Œåœ¨å¼‚æ­¥é€šä¿¡æ¡ä»¶ä¸‹ç¡®ä¿æ¶ˆæ¯çš„è¯·æ±‚å’Œå“åº”æˆåŠŸ</li>
<li>åŸºäºè‡ªå®šä¹‰starterå®ç°ï¼Œä¼˜åŒ–SpringBootç¯å¢ƒä¸‹çš„ä½¿ç”¨ã€‚</li>
</ol>
<h2 id="åŸºæœ¬æ¶æ„"><a href="#åŸºæœ¬æ¶æ„" class="headerlink" title="åŸºæœ¬æ¶æ„"></a>åŸºæœ¬æ¶æ„</h2><p><img src="/2024/09/02/00/%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84.png"></p>
<ol>
<li>æ³¨å†Œä¸­å¿ƒï¼Œç”¨äºæœåŠ¡æ³¨å†Œå’Œè·å–</li>
<li>æœåŠ¡ç«¯ï¼šæä¾›æœåŠ¡çš„ä¸€æ–¹Provider</li>
<li>å®¢æˆ·ç«¯ï¼šè°ƒç”¨æœåŠ¡çš„ä¸€æ–¹Consumer<br>åŸºæœ¬æµç¨‹ï¼š</li>
<li>æœåŠ¡ç«¯æŠŠæœåŠ¡ä¿¡æ¯æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒä¸Šï¼Œä¸€èˆ¬åŒ…æ‹¬æœåŠ¡ç«¯åœ°å€ã€æ¥å£ç±»å’Œæ–¹æ³•</li>
<li>å®¢æˆ·ç«¯ä»æ³¨å†Œä¸­å¿ƒè·å–å¯¹åº”çš„æœåŠ¡ä¿¡æ¯</li>
<li>å®¢æˆ·ç«¯æ ¹æ®æœåŠ¡çš„ä¿¡æ¯ï¼Œé€šè¿‡ç½‘ç»œè°ƒç”¨æœåŠ¡ç«¯çš„æ¥å£</li></ol>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2024/09/02/00/#more" rel="contents">
                é˜…è¯»å…¨æ–‡ &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zuofw.github.io/2024/10/03/28/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QingQiu">
      <meta itemprop="description" content="ä¸ªäººç½‘ç«™ï¼Œå­¦ä¹ è®°å½•ï¼Œé¢è¯•è®°å½•å’Œç»éªŒæ€»ç»“ã€äº’è”ç½‘ä¸­ä¸€å—å±äºè‡ªå·±çš„å°çª">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QingQiu'Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/03/28/" class="post-title-link" itemprop="url">æ·±å…¥æµ…å‡ºï¼Œä»æºç ææ¸…Beançš„åŠ è½½è¿‡ç¨‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-10-03 20:19:28" itemprop="dateCreated datePublished" datetime="2024-10-03T20:19:28+08:00">2024-10-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">æ·±å…¥ç†è§£ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>11k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>Beançš„åŠ è½½è¿‡ç¨‹ç®—æ˜¯é¢è¯•ä¸­çš„è€ç”Ÿå¸¸è°ˆäº†ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥ä»æºç å±‚é¢æ·±å…¥å»äº†è§£ä¸€ä¸‹Springä¸­æ˜¯å¦‚ä½•è¿›è¡ŒBeançš„åŠ è½½çš„</p>
<h1 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h1><p>å…ˆçœ‹ç¤ºä¾‹ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"classpath:/spring/text.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"stringutil"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å°±ä»è¿™ä¸ªgetBeanå»æ¢ç´¢Springå¦‚ä½•è¿›è¡Œç±»çš„åŠ è½½ã€‚<br>é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹çœ‹ClassPathXmlApplicationContexçš„ç»§æ‰¿å…³ç³»ï¼š</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2024/10/03/28/#more" rel="contents">
                é˜…è¯»å…¨æ–‡ &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zuofw.github.io/2024/09/29/55/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QingQiu">
      <meta itemprop="description" content="ä¸ªäººç½‘ç«™ï¼Œå­¦ä¹ è®°å½•ï¼Œé¢è¯•è®°å½•å’Œç»éªŒæ€»ç»“ã€äº’è”ç½‘ä¸­ä¸€å—å±äºè‡ªå·±çš„å°çª">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QingQiu'Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/29/55/" class="post-title-link" itemprop="url">MySQLä¸­NULLå€¼æ˜¯å¦ä¼šå½±å“ç´¢å¼•çš„ä½¿ç”¨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-09-29 19:13:55" itemprop="dateCreated datePublished" datetime="2024-09-29T19:13:55+08:00">2024-09-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">æ·±å…¥ç†è§£ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>1.9k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ä¸ºä½•å†™è¿™ä¸€ç¯‡æ–‡ç« "><a href="#ä¸ºä½•å†™è¿™ä¸€ç¯‡æ–‡ç« " class="headerlink" title="ä¸ºä½•å†™è¿™ä¸€ç¯‡æ–‡ç« "></a>ä¸ºä½•å†™è¿™ä¸€ç¯‡æ–‡ç« </h1><p>ğŸ­ğŸ­åœ¨é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°NULLå€¼æ˜¯å¦ä¼šèµ°ç´¢å¼•çš„æ—¶å€™ï¼Œæ„Ÿåˆ°æœ‰ç‚¹ä¸ç†è§£ï¼Œäºæ˜¯äº‹åå°±æœ‰äº†è¿™ç¯‡æ–‡ç« <br>é—®é¢˜ï¼š<br>ä¸ºnameå»ºç«‹ç´¢å¼•ï¼Œnameå¯ä»¥ä¸ºç©º<br><code>select * from user where name is null</code>æ˜¯å¦ä¼šä½¿ç”¨ç´¢å¼•ï¼Ÿ<br>ç”Ÿæ´»ä¼šæ‹·æ‰“æ¯ä¸€ä¸ªåšäº‹ä¸è®¤çœŸçš„äººğŸ˜­</p>
<h1 id="ç´¢å¼•çš„ç»“æ„"><a href="#ç´¢å¼•çš„ç»“æ„" class="headerlink" title="ç´¢å¼•çš„ç»“æ„"></a>ç´¢å¼•çš„ç»“æ„</h1><p>è¯¦ç»†çš„å¯ä»¥å‚ç…§æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç« æ·±å…¥æµ…å‡ºMySQLï¼Œé‡Œé¢æœ‰å…³äºç´¢å¼•çš„è¯¦ç»†ä»‹ç»<br>åœ¨InnoDBå¼•æ“ä¸­ï¼Œç´¢å¼•åˆ†ä¸ºèšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•ï¼Œå¯¹äºäºŒçº§ç´¢å¼•ï¼Œåœ¨è¿™ä¸ªåœºæ™¯ä¸‹æˆ‘ä»¬è¦è€ƒè™‘çš„å°±æ˜¯æ˜¯å¦ä¼šä¸ºNULLå»ºç«‹ç´¢å¼•å’Œå¦‚æœåˆ—ä¸­å­˜åœ¨NULLå€¼ï¼Œæ˜¯å¦ä¼šèµ°ç´¢å¼•å»æŸ¥æ‰¾è¿™ä¸ªNULL</p>
<h1 id="è®¿é—®æ–¹æ³•"><a href="#è®¿é—®æ–¹æ³•" class="headerlink" title="è®¿é—®æ–¹æ³•"></a>è®¿é—®æ–¹æ³•</h1><p>è®¿é—®æ–¹æ³•æ˜¯MySQLæ¥å®é™…è®¿é—®æ•°æ®çš„æ‰§è¡Œæ–¹æ³•<br>å¤§è‡´åˆ†ä¸ºï¼š</p>
<ol>
<li>å…¨è¡¨æ‰«æ</li>
<li>ä½¿ç”¨ç´¢å¼•æ‰«</li>
</ol>
<h2 id="æµ‹è¯•è¡¨"><a href="#æµ‹è¯•è¡¨" class="headerlink" title="æµ‹è¯•è¡¨"></a>æµ‹è¯•è¡¨</h2><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE TABLE user (  
                          `id` int(11) NOT NULL AUTO_INCREMENT,  
                          `name` varchar(20) NOT NULL,  
                          `age` int(11) DEFAULT NULL,  
                          `sex` varchar(20) DEFAULT NULL,  
                          PRIMARY KEY (`id`)  
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;  
  
INSERT INTO user (`id`, `name`, `age`, `sex`) VALUES ('1', 'Bob', '20', 'ç”·');  
INSERT INTO user (`id`, `name`, `age`, `sex`) VALUES ('2', 'Jack', '20', 'ç”·');  
INSERT INTO user (`id`, `name`, `age`, `sex`) VALUES ('3', 'Tony', '20', 'ç”·');  
INSERT INTO user (`id`, `name`, `age`, `sex`) VALUES ('4', 'Alan', '20', 'ç”·');  
  
CREATE  UNIQUE  INDEX indexName ON user(name(20));  
# ä¸ºageå»ºç«‹ç´¢å¼•  
CREATE INDEX indexAge ON user(age);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="const"><a href="#const" class="headerlink" title="const"></a>const</h2><p>é€šè¿‡ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—æ¥å®šä½ä¸€æ¡è®°å½•çš„è®¿é—®æ–¹æ³•<br><code>explain select * from user where id = 1;</code><br>è§£å†³å¦‚ä¸‹ï¼š<br><img src="/2024/09/29/55/const.png" alt="|1150"><br>é€šè¿‡typeæˆ‘ä»¬å¯ä»¥çœ‹è§è®¿é—®æ–¹æ³•æ˜¯const</p>
<h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><p>å¦‚æœäºŒçº§ç´¢å¼•åˆ—ä¸æ˜¯å”¯ä¸€çš„ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨äºŒçº§ç´¢å¼•çš„å€¼å»åŒ¹é…ï¼Œä¹‹åå†å›è¡¨<br><img src="/2024/09/29/55/ref.png"><br><code>explain select * from user where age = 20;</code><br><img src="/2024/09/29/55/ref-result.png"><br>å¦‚å›¾ä½¿ç”¨çš„æ˜¯refæ–¹æ³•<br><strong>äºŒçº§ç´¢å¼•åˆ—å€¼ä¸ºNULLæ—¶</strong>ï¼š<br>äºŒçº§ç´¢å¼•åˆ—å¯¹NULLå€¼çš„æ•°é‡æ—¶ä¸é™åˆ¶çš„ï¼Œæ‰€ä»¥key is NULLæœ€å¤šä½¿ç”¨çš„æ˜¯refï¼Œè€Œä¸æ˜¯const</p>
<h2 id="ref-or-null"><a href="#ref-or-null" class="headerlink" title="ref_or_null"></a>ref_or_null</h2><p>æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æ‰¾å‡ºäºŒçº§ç´¢å¼•ç­‰äºå¸¸æ•°å’Œä¸ºNULLçš„è®°å½•ä¸€åŒæ‰¾å‡º<br><code>explain select * from user where age = 20 or age is null ;</code><br><img src="/2024/09/29/55/ref_or_null-result.png"><br>æ‰§è¡Œçš„æµç¨‹ï¼š<br>å¦‚å›¾ï¼ŒNULLæ˜¯æ”¾åœ¨æ¯ä¸€å±‚ä¸­æœ€å·¦ä¾§çš„ï¼Œå¹¶ä¸”æ˜¯è¿åœ¨ä¸€èµ·çš„<br><img src="/2024/09/29/55/ref_or_null.png"></p>
<h2 id="range"><a href="#range" class="headerlink" title="range"></a>range</h2><p>ä½¿ç”¨ç´¢å¼•è¿›è¡ŒèŒƒå›´è®¿é—®ï¼Œå¯ä»¥æ˜¯èšç°‡ç´¢å¼•ï¼Œä¹Ÿå¯ä»¥æ˜¯äºŒçº§ç´¢å¼•ã€‚<br><code>explain select * from user where age &gt; 11 and age &lt;= 20;</code><br><img src="/2024/09/29/55/range.png"></p>
<h2 id="index"><a href="#index" class="headerlink" title="index"></a>index</h2><p>éå†äºŒçº§ç´¢å¼•è®°å½•çš„æ‰§è¡Œæ–¹å¼ï¼Œå¸¸å¸¸å‡ºç°åœ¨æŸ¥è¯¢åˆ—å’Œæ¡ä»¶éƒ½åŒ…å«åœ¨ç´¢å¼•ä¸­ï¼Œä¸éœ€è¦å›è¡¨ï¼Œæ‰€ä»¥ç›´æ¥éå†å³å¯</p>
<h2 id="all"><a href="#all" class="headerlink" title="all"></a>all</h2><p>å…¨è¡¨æ‰«æ</p>
<h1 id="NULLåœ¨äºŒçº§ç´¢å¼•ä¸­çš„ä½ç½®"><a href="#NULLåœ¨äºŒçº§ç´¢å¼•ä¸­çš„ä½ç½®" class="headerlink" title="NULLåœ¨äºŒçº§ç´¢å¼•ä¸­çš„ä½ç½®"></a>NULLåœ¨äºŒçº§ç´¢å¼•ä¸­çš„ä½ç½®</h1><p>é€šè¿‡æŸ¥è¯¢èµ„æ–™ï¼Œå‘ç°å¦‚æœç´¢å¼•åˆ—å…è®¸NULLå€¼ï¼Œé‚£ä¹ˆNULLåœ¨äºŒçº§ç´¢å¼•ä¸­æ˜¯è¢«å½“ä½œæœ€å°å€¼æ”¾åœ¨æ ‘çš„æ¯ä¸€å±‚çš„æœ€å·¦ä¾§çš„ï¼Œä¹Ÿå°±æ˜¯NULLå€¼ä¼šè¢«å½“æˆç´¢å¼•åˆ—çš„æ•°æ®ä½¿ç”¨çš„ï¼Œæ‰€ä»¥NULLå€¼åŒ¹é…æ˜¯å¯èƒ½ä¼šèµ°ç´¢å¼•çš„</p>
<ol>
<li>å¦‚æœåœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨IS NULLæˆ–IS NOT NULLï¼ŒMySQLé€šå¸¸ä¼šèµ°ç´¢å¼•<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// typeä¸ºrefï¼Œæ‰€ä»¥èµ°ç´¢å¼•äº†</span>
explain select <span class="token operator">*</span> from user where age is <span class="token keyword">null</span><span class="token punctuation">;</span>  
<span class="token comment">// typeä¸ºrangeï¼Œæ‰€ä»¥èµ°ç´¢å¼•äº†</span>
explain select <span class="token operator">*</span> from user where age is not <span class="token keyword">null</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>ç¬¦åˆç´¢å¼•ï¼Œå¦‚æœç­¾åˆ°åˆ—ä¸ä¸ºNULLï¼Œåç»­çš„åˆ—ä¹Ÿæ˜¯å¯ä»¥èµ°ç´¢å¼•çš„</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zuofw.github.io/2024/09/28/24/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QingQiu">
      <meta itemprop="description" content="ä¸ªäººç½‘ç«™ï¼Œå­¦ä¹ è®°å½•ï¼Œé¢è¯•è®°å½•å’Œç»éªŒæ€»ç»“ã€äº’è”ç½‘ä¸­ä¸€å—å±äºè‡ªå·±çš„å°çª">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QingQiu'Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/28/24/" class="post-title-link" itemprop="url">HashMapæºç åˆ†æä¸å¸¸è§å…«è‚¡</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-09-28 10:58:24" itemprop="dateCreated datePublished" datetime="2024-09-28T10:58:24+08:00">2024-09-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">æ·±å…¥ç†è§£ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>17k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="æ–‡ç« æ¨è"><a href="#æ–‡ç« æ¨è" class="headerlink" title="æ–‡ç« æ¨è"></a>æ–‡ç« æ¨è</h1><p><a target="_blank" rel="noopener" href="https://javadoop.com/post/hashmap">Java7/8 ä¸­çš„ HashMap å’Œ ConcurrentHashMap å…¨è§£æ (javadoop.com)</a></p>
<h1 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><h2 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h2><h3 id="åŸºæœ¬å±æ€§-é˜ˆå€¼-amp-ç³»æ•°-amp-å®¹é‡"><a href="#åŸºæœ¬å±æ€§-é˜ˆå€¼-amp-ç³»æ•°-amp-å®¹é‡" class="headerlink" title="åŸºæœ¬å±æ€§(é˜ˆå€¼&amp;ç³»æ•°&amp;å®¹é‡)"></a>åŸºæœ¬å±æ€§(é˜ˆå€¼&amp;ç³»æ•°&amp;å®¹é‡)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">implements</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
	<span class="token comment">// åºåˆ—å·</span>
    <span class="token annotation punctuation">@java.io.Serial</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">362498820763181265L</span><span class="token punctuation">;</span>

	<span class="token comment">// é»˜è®¤å®¹é‡ï¼Œä¹Ÿå°±æ˜¯ 16</span>
	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_INITIAL_CAPACITY</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> 

	<span class="token comment">/**
	 * æœ€å¤§å®¹é‡ï¼Œå¦‚æœé€šè¿‡æ„é€ å‡½æ•°éšå¼æŒ‡å®šäº†æ›´é«˜çš„å€¼ï¼Œåˆ™ä½¿ç”¨æ­¤å€¼ã€‚
	 * å¿…é¡»æ˜¯2çš„å¹‚ä¸” &lt;= 1&lt;&lt;30ã€‚
	 * ä¹Ÿå°±æ˜¯æœ€å¤§å®¹é‡æ˜¯ 2^30
	 */</span>
	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAXIMUM_CAPACITY</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * æ„é€ å‡½æ•°æœªæŒ‡å®šæ—¶ä½¿ç”¨çš„è´Ÿè½½å› å­ã€‚
	 */</span>
	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> <span class="token constant">DEFAULT_LOAD_FACTOR</span> <span class="token operator">=</span> <span class="token number">0.75f</span><span class="token punctuation">;</span>

	<span class="token comment">// å½“æ¡¶ä¸Šçš„èŠ‚ç‚¹æ•°&gt;=è¿™ä¸ªå€¼æ—¶ä¼šè½¬åŒ–ä¸ºçº¢é»‘æ ‘</span>
	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TREEIFY_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>

	<span class="token comment">// å½“æ¡¶ä¸Šçš„èŠ‚ç‚¹æ•°å°äºè¿™ä¸ªå€¼æ—¶ä¼šè½¬åŒ–ä¸ºé“¾è¡¨</span>
	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">UNTREEIFY_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>

	<span class="token comment">// è½¬åŒ–ä¸ºçº¢é»‘æ ‘å¯¹åº”çš„æ‰€éœ€è¦çš„æœ€å°çš„æ•°ç»„å®¹é‡</span>
	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MIN_TREEIFY_CAPACITY</span> <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
	<span class="token comment">// å­˜å‚¨å…ƒç´ çš„æ•°ç»„ï¼Œå®¹é‡æ€»æ˜¯2çš„å¹‚æ¬¡å€</span>
	<span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>
	<span class="token comment">// transientç”¨äºæ ‡è¯†è¿™ä¸ªå­—æ®µä¸åº”è¯¥è¢«åºåˆ—åŒ–</span>
	<span class="token keyword">transient</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entrySet<span class="token punctuation">;</span>
	<span class="token comment">// å­˜æ”¾å…ƒç´ çš„ä¸ªæ•°ï¼Œ</span>
	<span class="token keyword">transient</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>
	<span class="token comment">// æ¯æ¬¡æ‰©å®¹å’Œæ›´æ”¹mapç»“æ„çš„è®¡æ•°å™¨</span>
	<span class="token comment">/*
	* 1.æ£€æµ‹å¹¶å‘ä¿®æ”¹ï¼šåœ¨è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ modCount å‘ç”Ÿå˜åŒ–ï¼Œè¿­ä»£å™¨ä¼šæŠ›å‡º ConcurrentModificationExceptionï¼Œä»¥é˜²æ­¢å¹¶å‘ä¿®æ”¹å¯¼è‡´çš„ä¸ä¸€è‡´æ€§ã€‚
	2.ç»´æŠ¤å†…éƒ¨çŠ¶æ€ï¼šåœ¨æŸäº›æ“ä½œï¼ˆå¦‚æ’å…¥ã€åˆ é™¤ã€æ‰©å®¹ï¼‰ä¸­ï¼ŒmodCount ä¼šå¢åŠ ï¼Œä»¥ç¡®ä¿ HashMap çš„å†…éƒ¨çŠ¶æ€ä¿æŒä¸€è‡´
	*/</span>
	<span class="token keyword">transient</span> <span class="token keyword">int</span> modCount<span class="token punctuation">;</span>
	<span class="token comment">// é˜ˆå€¼(å®¹é‡*è´Ÿè½½å› å­) å½“å®é™…å¤§å°è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œä¼šè¿›è¡Œæ‰©å®¹</span>
	<span class="token keyword">int</span> threshold<span class="token punctuation">;</span>
	<span class="token comment">// è´Ÿè½½å› å­</span>
	<span class="token keyword">final</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="loadFactorè´Ÿè½½å› å­"><a href="#loadFactorè´Ÿè½½å› å­" class="headerlink" title="loadFactorè´Ÿè½½å› å­"></a>loadFactorè´Ÿè½½å› å­</h4><p>è´Ÿè½½å› å­æ˜¯æ§åˆ¶æ•°ç»„å­˜æ”¾æ•°æ®çš„ç–å¯†ç¨‹åº¦ï¼ŒloadFactorè¶Šæ¥è¿‘1ï¼Œé‚£ä¹ˆæ•°ç»„ä¸­å­˜æ”¾çš„æ•°æ®(entry)ä¹Ÿå°±è¶Šå¤š,å¦åˆ™å°±è¶Šå°‘ã€‚<br>å¤ªå¤§æŸ¥æ‰¾å…ƒç´ çš„æ•ˆç‡ä½ï¼Œå¤ªå°åˆ©ç”¨ç‡å¤ªä½<br>æ‰€ä»¥é»˜è®¤ 16 * 0.75 = 12ï¼Œè¶…è¿‡è¿™ä¸ªæ•°æ®é‡æ—¶ï¼Œå°±ä¼šè¿›è¡Œæ‰©å®¹</p>
<h4 id="threshold"><a href="#threshold" class="headerlink" title="threshold"></a>threshold</h4><p>threshold = capacity * loadFacotryï¼Œæ˜¯æ•°ç»„æ‰©å®¹çš„æ ‡å‡†<br>å› ä¸ºhashmapä¸­æ²¡æœ‰capacityè¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥å³ä½¿æŒ‡å®šäº†åˆå§‹åŒ–çš„capacityï¼Œä¹Ÿä¼šè¢«æ‰©å®¹åˆ°2çš„æœ€æ¥è¿‘è¿™ä¸ªå¤§å°çš„å¹‚æ¬¡æ–¹</p>
<h3 id="Node-èŠ‚ç‚¹ç±»æºç "><a href="#Node-èŠ‚ç‚¹ç±»æºç " class="headerlink" title="Node èŠ‚ç‚¹ç±»æºç "></a>Node èŠ‚ç‚¹ç±»æºç </h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// ç»§æ‰¿Map.Entry&lt;K,V&gt;</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>  
	<span class="token comment">// hashå€¼ï¼Œå­˜æ”¾å…ƒç´ åˆ°hashmapæ—¶ç”¨æ¥ä¸å…¶ä»–å…ƒç´ è¿›è¡Œæ¯”è¾ƒ</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> hash<span class="token punctuation">;</span>  
    <span class="token keyword">final</span> <span class="token class-name">K</span> key<span class="token punctuation">;</span>  
    <span class="token class-name">V</span> value<span class="token punctuation">;</span>  
	<span class="token comment">// æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">;</span>  
  
    <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>hash <span class="token operator">=</span> hash<span class="token punctuation">;</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">K</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span> <span class="token keyword">return</span> key<span class="token punctuation">;</span> <span class="token punctuation">}</span>  
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span> <span class="token punctuation">}</span>  
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> key <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> value<span class="token punctuation">;</span> <span class="token punctuation">}</span>  
  
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name">V</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token class-name">V</span> oldValue <span class="token operator">=</span> value<span class="token punctuation">;</span>  
        value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>  
        <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span>  
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
  
        <span class="token keyword">return</span> o <span class="token keyword">instanceof</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> e  
                <span class="token operator">&amp;&amp;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                <span class="token operator">&amp;&amp;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="æ ‘èŠ‚ç‚¹æºç "><a href="#æ ‘èŠ‚ç‚¹æºç " class="headerlink" title="æ ‘èŠ‚ç‚¹æºç "></a>æ ‘èŠ‚ç‚¹æºç </h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// ä»…æˆªå–éƒ¨åˆ†æºç </span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">LinkedHashMap<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>  
    <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> parent<span class="token punctuation">;</span>  <span class="token comment">// çˆ¶</span>
    <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> left<span class="token punctuation">;</span>    <span class="token comment">// å·¦</span>
    <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> right<span class="token punctuation">;</span>   <span class="token comment">// å³ </span>
    <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> prev<span class="token punctuation">;</span>    <span class="token comment">// needed to unlink next upon deletion  </span>
    <span class="token keyword">boolean</span> red<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="hashæ–¹æ³•"><a href="#hashæ–¹æ³•" class="headerlink" title="hashæ–¹æ³•"></a>hashæ–¹æ³•</h3><h3 id="put"><a href="#put" class="headerlink" title="put"></a>put</h3><ol>
<li>åˆ¤æ–­æ•°ç»„,è‹¥å‘ç°æ•°ç»„ä¸ºç©º,åˆ™è¿›è¡Œé¦–æ¬¡æ‰©å®¹ã€‚</li>
<li>åˆ¤æ–­å¤´èŠ‚ç‚¹,è‹¥å‘ç°å¤´èŠ‚ç‚¹ä¸ºç©º,åˆ™æ–°å»ºé“¾è¡¨èŠ‚ç‚¹,å­˜å…¥æ•°ç»„ã€‚</li>
<li>åˆ¤æ–­å¤´èŠ‚ç‚¹,è‹¥å‘ç°å¤´èŠ‚ç‚¹éç©º,åˆ™å°†å…ƒç´ æ’å…¥æ§½å†…ã€‚</li>
<li>è‹¥å…ƒç´ çš„keyä¸å¤´èŠ‚ç‚¹ä¸€è‡´,åˆ™ç›´æ¥è¦†ç›–å¤´èŠ‚ç‚¹ã€‚</li>
<li>è‹¥å…ƒç´ ä¸ºæ ‘å‹èŠ‚ç‚¹,åˆ™å°†å…ƒç´ è¿½åŠ åˆ°æ ‘ä¸­ã€‚</li>
<li>è‹¥å…ƒç´ ä¸ºé“¾è¡¨èŠ‚ç‚¹,åˆ™å°†å…ƒç´ è¿½åŠ åˆ°é“¾è¡¨ä¸­ã€‚ï¼ˆè¿½åŠ å,éœ€è¦åˆ¤æ–­é“¾è¡¨é•¿åº¦ä»¥å†³å®šæ˜¯å¦è½¬ä¸ºçº¢é»‘æ ‘ã€‚è‹¥é“¾è¡¨é•¿åº¦è¾¾åˆ°8ã€æ•°ç»„å®¹é‡æœªè¾¾åˆ°64,åˆ™æ‰©å®¹ã€‚è‹¥é“¾è¡¨é•¿åº¦è¾¾åˆ°8ã€æ•°ç»„å®¹é‡è¾¾åˆ°64,åˆ™è½¬ä¸ºçº¢é»‘æ ‘ã€‚ï¼‰</li>
<li>æ’å…¥å…ƒç´ å,åˆ¤æ–­å…ƒç´ çš„ä¸ªæ•°,è‹¥å‘ç°è¶…è¿‡é˜ˆå€¼åˆ™å†æ¬¡æ‰©å®¹ã€‚<br>putæ–¹æ³•å®é™…å°±æ˜¯è°ƒç”¨putValï¼Œå¹¶ä¸”putValç”¨æˆ·ä¸å¯ç›´æ¥ä½¿ç”¨<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

<span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">,</span>
               <span class="token keyword">boolean</span> evict<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> p<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœè¡¨ä¸ºç©ºæˆ–é•¿åº¦ä¸º0ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–æˆ–æ‰©å®¹</span>
    <span class="token comment">// å°†å±æ€§ä¸­çš„tableèµ‹å€¼ï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦ä¸ºç©ºæˆ–è€…é•¿åº¦ä¸º0ï¼Œå¦‚æœæ˜¯å°±è¿›è¡Œåˆå§‹åŒ–æˆ–è€…æ‰©å®¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	    <span class="token comment">// resize()å‡½æ•°å°±æ˜¯è¿›è¡Œæ‰©å®¹æˆ–è€…åˆå§‹åŒ–</span>
        n <span class="token operator">=</span> <span class="token punctuation">(</span>tab <span class="token operator">=</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// è®¡ç®—ç´¢å¼•ä½ç½®ï¼Œå¦‚æœå½“å‰ä½ç½®ä¸ºç©ºï¼Œåˆ™ç›´æ¥æ’å…¥æ–°èŠ‚ç‚¹</span>
    <span class="token comment">// (n - 1) &amp; hash ç¡®å®šå…ƒç´ æ”¾åœ¨å“ªä¸ªæ¡¶é‡Œï¼Œæ¡¶ä¸ºç©ºï¼Œæ–°ç”ŸæˆèŠ‚ç‚¹æ”¾å…¥æ•°ç»„ä¸­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e<span class="token punctuation">;</span> <span class="token class-name">K</span> k<span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœå½“å‰ä½ç½®çš„èŠ‚ç‚¹çš„å“ˆå¸Œå€¼å’Œé”®éƒ½ç›¸ç­‰ï¼Œåˆ™ç›´æ¥è¦†ç›–</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            e <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœæ˜¯æ ‘èŠ‚ç‚¹ï¼Œåˆ™è°ƒç”¨æ ‘èŠ‚ç‚¹çš„æ’å…¥æ–¹æ³•</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>
            e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tab<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// éå†é“¾è¡¨ï¼ŒæŸ¥æ‰¾æ’å…¥ä½ç½®æˆ–ç›¸åŒé”®çš„èŠ‚ç‚¹</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// å¦‚æœé“¾è¡¨é•¿åº¦è¾¾åˆ°é˜ˆå€¼ï¼Œåˆ™è½¬æ¢ä¸ºæ ‘ç»“æ„</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">&gt;=</span> <span class="token constant">TREEIFY_THRESHOLD</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// -1 for 1st</span>
                        <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// å¦‚æœæ‰¾åˆ°ç›¸åŒé”®çš„èŠ‚ç‚¹ï¼Œåˆ™è·³å‡ºå¾ªç¯</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                p <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å¦‚æœæ‰¾åˆ°ç›¸åŒé”®çš„èŠ‚ç‚¹ï¼Œåˆ™æ›´æ–°å€¼</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// existing mapping for key</span>
            <span class="token class-name">V</span> oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent <span class="token operator">||</span> oldValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token function">afterNodeAccess</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ä¿®æ”¹è®¡æ•°å™¨</span>
    <span class="token operator">++</span>modCount<span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœå¤§å°è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™è¿›è¡Œæ‰©å®¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>size <span class="token operator">&gt;</span> threshold<span class="token punctuation">)</span>
        <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">afterNodeInsertion</span><span class="token punctuation">(</span>evict<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
åŸºæœ¬é€»è¾‘ï¼š</li>
<li>å¦‚æœå®šä½åˆ°çš„æ•°ç»„ä½ç½®æ²¡æœ‰å…ƒç´ ï¼Œåˆ™ç›´æ¥æ’å…¥</li>
<li>å¦‚æœæœ‰å…ƒç´ ï¼Œå°±è¦ä¸æ’å…¥çš„keyè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸åŒï¼Œå°±è¦†ç›–ã€‚å¦‚æœä¸åŒå°±åˆ¤æ–­pæ˜¯å¦æ˜¯æ ‘èŠ‚ç‚¹ï¼Œå¦‚æœä¸æ˜¯å°±ç›´æ¥éå†é“¾è¡¨æ’å…¥ï¼Œä½¿ç”¨å°¾æ’æ³•ï¼Œå¦åˆ™è°ƒç”¨putTreeValå‡½æ•°</li>
</ol>
<h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> <span class="token function">getNode</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">getNode</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> first<span class="token punctuation">,</span> e<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> hash<span class="token punctuation">;</span> <span class="token class-name">K</span> k<span class="token punctuation">;</span>
    <span class="token comment">// æ£€æŸ¥è¡¨æ˜¯å¦ä¸ºç©ºä¸”é•¿åº¦å¤§äº0ï¼Œå¹¶è®¡ç®—å“ˆå¸Œå€¼å’Œç´¢å¼•</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>first <span class="token operator">=</span> tab<span class="token punctuation">[</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>hash <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ£€æŸ¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦åŒ¹é…</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>first<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span> <span class="token comment">// å§‹ç»ˆæ£€æŸ¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> first<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> first<span class="token punctuation">;</span>
        <span class="token comment">// éå†é“¾è¡¨æˆ–æ ‘èŠ‚ç‚¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> first<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>first<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTreeNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ£€æŸ¥é“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ˜¯å¦åŒ¹é…</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„èŠ‚ç‚¹ï¼Œè¿”å›null</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="resize"><a href="#resize" class="headerlink" title="resize"></a>resize</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldTab <span class="token operator">=</span> table<span class="token punctuation">;</span> <span class="token comment">// æ—§çš„å“ˆå¸Œè¡¨</span>
    <span class="token keyword">int</span> oldCap <span class="token operator">=</span> <span class="token punctuation">(</span>oldTab <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> oldTab<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// æ—§çš„å®¹é‡</span>
    <span class="token keyword">int</span> oldThr <span class="token operator">=</span> threshold<span class="token punctuation">;</span> <span class="token comment">// æ—§çš„é˜ˆå€¼</span>
    <span class="token keyword">int</span> newCap<span class="token punctuation">,</span> newThr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// æ–°çš„å®¹é‡å’Œé˜ˆå€¼</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCap <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœæ—§çš„å®¹é‡å¤§äº0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCap <span class="token operator">&gt;=</span> <span class="token constant">MAXIMUM_CAPACITY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœæ—§çš„å®¹é‡å·²ç»è¾¾åˆ°æœ€å¤§å®¹é‡</span>
            threshold <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span> <span class="token comment">// å°†é˜ˆå€¼è®¾ä¸ºæœ€å¤§æ•´æ•°å€¼</span>
            <span class="token keyword">return</span> oldTab<span class="token punctuation">;</span> <span class="token comment">// è¿”å›æ—§çš„å“ˆå¸Œè¡¨</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newCap <span class="token operator">=</span> oldCap <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">MAXIMUM_CAPACITY</span> <span class="token operator">&amp;&amp;</span> oldCap <span class="token operator">&gt;=</span> <span class="token constant">DEFAULT_INITIAL_CAPACITY</span><span class="token punctuation">)</span>
            newThr <span class="token operator">=</span> oldThr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// å°†å®¹é‡å’Œé˜ˆå€¼éƒ½ç¿»å€</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldThr <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// å¦‚æœæ—§çš„é˜ˆå€¼å¤§äº0</span>
        newCap <span class="token operator">=</span> oldThr<span class="token punctuation">;</span> <span class="token comment">// å°†æ–°çš„å®¹é‡è®¾ä¸ºæ—§çš„é˜ˆå€¼</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœæ—§çš„é˜ˆå€¼ä¸º0ï¼Œä½¿ç”¨é»˜è®¤å€¼</span>
        newCap <span class="token operator">=</span> <span class="token constant">DEFAULT_INITIAL_CAPACITY</span><span class="token punctuation">;</span> <span class="token comment">// é»˜è®¤åˆå§‹å®¹é‡</span>
        newThr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_LOAD_FACTOR</span> <span class="token operator">*</span> <span class="token constant">DEFAULT_INITIAL_CAPACITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é»˜è®¤é˜ˆå€¼</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newThr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœæ–°çš„é˜ˆå€¼ä¸º0</span>
        <span class="token keyword">float</span> ft <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>newCap <span class="token operator">*</span> loadFactor<span class="token punctuation">;</span> <span class="token comment">// è®¡ç®—æ–°çš„é˜ˆå€¼</span>
        newThr <span class="token operator">=</span> <span class="token punctuation">(</span>newCap <span class="token operator">&lt;</span> <span class="token constant">MAXIMUM_CAPACITY</span> <span class="token operator">&amp;&amp;</span> ft <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token constant">MAXIMUM_CAPACITY</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>ft <span class="token operator">:</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    threshold <span class="token operator">=</span> newThr<span class="token punctuation">;</span> <span class="token comment">// æ›´æ–°é˜ˆå€¼</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"rawtypes"</span><span class="token punctuation">,</span><span class="token string">"unchecked"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> newTab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">[</span>newCap<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// åˆ›å»ºæ–°çš„å“ˆå¸Œè¡¨</span>
    table <span class="token operator">=</span> newTab<span class="token punctuation">;</span> <span class="token comment">// æ›´æ–°å“ˆå¸Œè¡¨å¼•ç”¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldTab <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœæ—§çš„å“ˆå¸Œè¡¨ä¸ä¸ºç©º</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldCap<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// éå†æ—§çš„å“ˆå¸Œè¡¨</span>
            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœæ—§è¡¨ä¸­çš„æ¡¶ä¸ä¸ºç©º</span>
                oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// æ¸…ç©ºæ—§è¡¨ä¸­çš„æ¡¶</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>next <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// å¦‚æœæ¡¶ä¸­åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹</span>
                    newTab<span class="token punctuation">[</span>e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> <span class="token punctuation">(</span>newCap <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span> <span class="token comment">// ç›´æ¥æ”¾å…¥æ–°è¡¨</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span> <span class="token comment">// å¦‚æœæ¡¶ä¸­æ˜¯æ ‘èŠ‚ç‚¹</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> newTab<span class="token punctuation">,</span> j<span class="token punctuation">,</span> oldCap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ‹†åˆ†æ ‘èŠ‚ç‚¹</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœæ¡¶ä¸­æ˜¯é“¾è¡¨èŠ‚ç‚¹</span>
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> loHead <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loTail <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// ä½ä½é“¾è¡¨çš„å¤´å’Œå°¾</span>
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> hiHead <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> hiTail <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// é«˜ä½é“¾è¡¨çš„å¤´å’Œå°¾</span>
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">;</span>
                    <span class="token keyword">do</span> <span class="token punctuation">{</span>
                        next <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> oldCap<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// ä½ä½é“¾è¡¨</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>loTail <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                                loHead <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            <span class="token keyword">else</span>
                                loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            loTail <span class="token operator">=</span> e<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// é«˜ä½é“¾è¡¨</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>hiTail <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                                hiHead <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            <span class="token keyword">else</span>
                                hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            hiTail <span class="token operator">=</span> e<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>loTail <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        newTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> loHead<span class="token punctuation">;</span> <span class="token comment">// æ”¾å…¥ä½ä½é“¾è¡¨</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>hiTail <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        newTab<span class="token punctuation">[</span>j <span class="token operator">+</span> oldCap<span class="token punctuation">]</span> <span class="token operator">=</span> hiHead<span class="token punctuation">;</span> <span class="token comment">// æ”¾å…¥é«˜ä½é“¾è¡¨</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> newTab<span class="token punctuation">;</span> <span class="token comment">// è¿”å›æ–°çš„å“ˆå¸Œè¡¨</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h2><h2 id="JDK1-7"><a href="#JDK1-7" class="headerlink" title="JDK1.7"></a>JDK1.7</h2><p>JDK1.7ä¸­ï¼ŒConcurrentHashMapæ˜¯ç”±å¤šä¸ªSegmentç»„åˆï¼Œè€Œæ¯ä¸€ä¸ªSegmentéƒ½æ˜¯ä¸€ä¸ªç±»ä¼¼äºHashMapçš„ç»“æ„ï¼Œå¯ä»¥å†…éƒ¨è¿›è¡Œæ‰©å®¹ï¼Œä½†æ˜¯Segmentçš„ä¸ªæ•°ä¸€æ—¦åˆå§‹åŒ–å°±ä¸èƒ½æ”¹å˜äº†ã€‚é»˜è®¤æ”¯æŒ16ä¸ªï¼Œä¹Ÿå°±æ˜¯é»˜è®¤æ”¯æŒ16ä¸ªçº¿ç¨‹å¹¶å‘<img src="/2024/09/28/24/jdk1.7concurrent.png">Segment é€šè¿‡ç»§æ‰¿ ReentrantLock æ¥è¿›è¡ŒåŠ é”</p>
<h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p>æ— å‚æ„é€ ä¸­è°ƒç”¨äº†æœ‰å‚æ„é€ ï¼Œä¼ å…¥ä¸‰ä¸ªé»˜è®¤å€¼</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * é»˜è®¤åˆå§‹åŒ–å®¹é‡
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_INITIAL_CAPACITY</span> <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * é»˜è®¤è´Ÿè½½å› å­
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> <span class="token constant">DEFAULT_LOAD_FACTOR</span> <span class="token operator">=</span> <span class="token number">0.75f</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * é»˜è®¤å¹¶å‘çº§åˆ«
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_CONCURRENCY_LEVEL</span> <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åˆå§‹åŒ–é€»è¾‘</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span><span class="token keyword">float</span> loadFactor<span class="token punctuation">,</span> <span class="token keyword">int</span> concurrencyLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å‚æ•°æ ¡éªŒ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>loadFactor <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> initialCapacity <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> concurrencyLevel <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ ¡éªŒå¹¶å‘çº§åˆ«å¤§å°ï¼Œå¤§äº 1&lt;&lt;16ï¼Œé‡ç½®ä¸º 65536</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>concurrencyLevel <span class="token operator">&gt;</span> <span class="token constant">MAX_SEGMENTS</span><span class="token punctuation">)</span>
        concurrencyLevel <span class="token operator">=</span> <span class="token constant">MAX_SEGMENTS</span><span class="token punctuation">;</span>
    <span class="token comment">// Find power-of-two sizes best matching arguments</span>
    <span class="token comment">// 2çš„å¤šå°‘æ¬¡æ–¹</span>
    <span class="token keyword">int</span> sshift <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ssize <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿™ä¸ªå¾ªç¯å¯ä»¥æ‰¾åˆ° concurrencyLevel ä¹‹ä¸Šæœ€è¿‘çš„ 2çš„æ¬¡æ–¹å€¼</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>ssize <span class="token operator">&lt;</span> concurrencyLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">++</span>sshift<span class="token punctuation">;</span>
        ssize <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è®°å½•æ®µåç§»é‡</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>segmentShift <span class="token operator">=</span> <span class="token number">32</span> <span class="token operator">-</span> sshift<span class="token punctuation">;</span>
    <span class="token comment">// è®°å½•æ®µæ©ç </span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>segmentMask <span class="token operator">=</span> ssize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®å®¹é‡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">&gt;</span> <span class="token constant">MAXIMUM_CAPACITY</span><span class="token punctuation">)</span>
        initialCapacity <span class="token operator">=</span> <span class="token constant">MAXIMUM_CAPACITY</span><span class="token punctuation">;</span>
    <span class="token comment">// c = å®¹é‡ / ssize ï¼Œé»˜è®¤ 16 / 16 = 1ï¼Œè¿™é‡Œæ˜¯è®¡ç®—æ¯ä¸ª Segment ä¸­çš„ç±»ä¼¼äº HashMap çš„å®¹é‡</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> initialCapacity <span class="token operator">/</span> ssize<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">*</span> ssize <span class="token operator">&lt;</span> initialCapacity<span class="token punctuation">)</span>
        <span class="token operator">++</span>c<span class="token punctuation">;</span>
    <span class="token keyword">int</span> cap <span class="token operator">=</span> <span class="token constant">MIN_SEGMENT_TABLE_CAPACITY</span><span class="token punctuation">;</span>
    <span class="token comment">//Segment ä¸­çš„ç±»ä¼¼äº HashMap çš„å®¹é‡è‡³å°‘æ˜¯2æˆ–è€…2çš„å€æ•°</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cap <span class="token operator">&lt;</span> c<span class="token punctuation">)</span>
        cap <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// create segments and segments[0]</span>
    <span class="token comment">// åˆ›å»º Segment æ•°ç»„ï¼Œè®¾ç½® segments[0]</span>
    <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> s0 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>loadFactor<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>cap <span class="token operator">*</span> loadFactor<span class="token punctuation">)</span><span class="token punctuation">,</span>
                         <span class="token punctuation">(</span><span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">HashEntry</span><span class="token punctuation">[</span>cap<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ss <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Segment</span><span class="token punctuation">[</span>ssize<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> <span class="token constant">SBASE</span><span class="token punctuation">,</span> s0<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ordered write of segments[0]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>segments <span class="token operator">=</span> ss<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>æ ¡éªŒå¹¶å‘ç­‰çº§å¤§å°ï¼Œå¦‚æœå¤§äºæœ€å¤§å€¼ï¼Œå°±é‡ç½®ä¸ºæœ€å¤§å€¼</li>
<li>åˆå§‹åŒ–å®¹é‡ä¸ºå¤§äºå¹¶å‘ç­‰çº§æœ€è¿‘çš„2çš„å¹‚æ¬¡æ–¹ï¼Œé»˜è®¤16</li>
<li>è®°å½•segmentShiftåç§»é‡ï¼Œ2^n ä¸­çš„nï¼Œé»˜è®¤ä¸º32 - sshift = 28  </li>
<li>è®°å½•segmentMaskï¼Œé»˜è®¤æ˜¯ssize - 1 = 16 - 1 = 15</li>
<li>åˆå§‹åŒ–<code>segment[0]</code>ï¼Œé»˜è®¤å¤§å°ä¸º2ï¼Œæ‰©å®¹é˜ˆå€¼ä¸º 2 * 0.75 = 1.5ã€‚æ’å…¥ç¬¬äºŒä¸ªå€¼æ—¶æ‰ä¼šè¿›è¡Œæ‰©å®¹</li>
</ol>
<h3 id="put-1"><a href="#put-1" class="headerlink" title="put"></a>put</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Maps the specified key to the specified value in this table.
 * Neither the key nor the value can be null.
 *
 * &lt;p&gt; The value can be retrieved by calling the &lt;tt&gt;get&lt;/tt&gt; method
 * with a key that is equal to the original key.
 *
 * @param key key with which the specified value is to be associated
 * @param value value to be associated with the specified key
 * @return the previous value associated with &lt;tt&gt;key&lt;/tt&gt;, or
 *         &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for &lt;tt&gt;key&lt;/tt&gt;
 * @throws NullPointerException if the specified key or value is null
 */</span>
<span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> s<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// hash å€¼æ— ç¬¦å·å³ç§» 28ä½ï¼ˆåˆå§‹åŒ–æ—¶è·å¾—ï¼‰ï¼Œç„¶åä¸ segmentMask=15 åšä¸è¿ç®—</span>
    <span class="token comment">// å…¶å®ä¹Ÿå°±æ˜¯æŠŠé«˜4ä½ä¸segmentMaskï¼ˆ1111ï¼‰åšä¸è¿ç®—</span>
    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token punctuation">(</span>hash <span class="token operator">&gt;&gt;&gt;</span> segmentShift<span class="token punctuation">)</span> <span class="token operator">&amp;</span> segmentMask<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token constant">UNSAFE</span><span class="token punctuation">.</span>getObject          <span class="token comment">// nonvolatile; recheck</span>
         <span class="token punctuation">(</span>segments<span class="token punctuation">,</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;&lt;</span> <span class="token constant">SSHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">SBASE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">//  in ensureSegment</span>
        <span class="token comment">// å¦‚æœæŸ¥æ‰¾åˆ°çš„ Segment ä¸ºç©ºï¼Œåˆå§‹åŒ–</span>
        s <span class="token operator">=</span> <span class="token function">ensureSegment</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Returns the segment for the given index, creating it and
 * recording in segment table (via CAS) if not already present.
 *
 * @param k the index
 * @return the segment
 */</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">ensureSegment</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ss <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>segments<span class="token punctuation">;</span>
    <span class="token keyword">long</span> u <span class="token operator">=</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;&lt;</span> <span class="token constant">SSHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">SBASE</span><span class="token punctuation">;</span> <span class="token comment">// raw offset</span>
    <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> seg<span class="token punctuation">;</span>
    <span class="token comment">// åˆ¤æ–­ u ä½ç½®çš„ Segment æ˜¯å¦ä¸ºnull</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>seg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">getObjectVolatile</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> proto <span class="token operator">=</span> ss<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// use segment 0 as prototype</span>
        <span class="token comment">// è·å–0å· segment é‡Œçš„ HashEntry&lt;K,V&gt; åˆå§‹åŒ–é•¿åº¦</span>
        <span class="token keyword">int</span> cap <span class="token operator">=</span> proto<span class="token punctuation">.</span>table<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token comment">// è·å–0å· segment é‡Œçš„ hash è¡¨é‡Œçš„æ‰©å®¹è´Ÿè½½å› å­ï¼Œæ‰€æœ‰çš„ segment çš„ loadFactor æ˜¯ç›¸åŒçš„</span>
        <span class="token keyword">float</span> lf <span class="token operator">=</span> proto<span class="token punctuation">.</span>loadFactor<span class="token punctuation">;</span>
        <span class="token comment">// è®¡ç®—æ‰©å®¹é˜€å€¼</span>
        <span class="token keyword">int</span> threshold <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>cap <span class="token operator">*</span> lf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ›å»ºä¸€ä¸ª cap å®¹é‡çš„ HashEntry æ•°ç»„</span>
        <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">HashEntry</span><span class="token punctuation">[</span>cap<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>seg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">getObjectVolatile</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// recheck</span>
            <span class="token comment">// å†æ¬¡æ£€æŸ¥ u ä½ç½®çš„ Segment æ˜¯å¦ä¸ºnullï¼Œå› ä¸ºè¿™æ—¶å¯èƒ½æœ‰å…¶ä»–çº¿ç¨‹è¿›è¡Œäº†æ“ä½œ</span>
            <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>lf<span class="token punctuation">,</span> threshold<span class="token punctuation">,</span> tab<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è‡ªæ—‹æ£€æŸ¥ u ä½ç½®çš„ Segment æ˜¯å¦ä¸ºnull</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>seg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">getObjectVolatile</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">)</span>
                   <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// ä½¿ç”¨CAS èµ‹å€¼ï¼Œåªä¼šæˆåŠŸä¸€æ¬¡</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> u<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> seg <span class="token operator">=</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> seg<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>è®¡ç®—keyçš„ä½ç½®ï¼Œè·å–æŒ‡å®šä½ç½®çš„Segment</li>
<li>å¦‚æœæŒ‡å®šä½ç½®çš„Segmentä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ–è¿™ä¸ªSegment<ul>
<li>å¦‚æœä¸ºnullï¼Œä½¿ç”¨<code>Segment[0]</code>çš„å®¹é‡å’Œè´Ÿè½½å› å­åˆ›å»ºä¸€ä¸ªHashEntryæ•°ç»„</li>
<li>å†æ¬¡æ£€æŸ¥æ˜¯å¦ä¸ºnull</li>
<li>ä½¿ç”¨HashEntryåˆå§‹åŒ–è¿™ä¸ªSegment</li>
<li>è‡ªæ—‹è®¡ç®—å¾—åˆ°çš„æŒ‡å®šä½ç½®æ˜¯å¦ä¸ºnullï¼Œä½¿ç”¨CASåœ¨è¿™ä¸ªä½ç½®èµ‹å€¼Segment</li>
</ul>
</li>
<li>Segment.putæ’å…¥keyï¼Œvalue<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å– ReentrantLock ç‹¬å é”ï¼Œè·å–ä¸åˆ°ï¼ŒscanAndLockForPut è·å–ã€‚</span>
    <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> node <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token function">scanAndLockForPut</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">V</span> oldValue<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
        <span class="token comment">// è®¡ç®—è¦putçš„æ•°æ®ä½ç½®</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token punctuation">(</span>tab<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">;</span>
        <span class="token comment">// CAS è·å– index åæ ‡çš„å€¼</span>
        <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> first <span class="token operator">=</span> <span class="token function">entryAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> first<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ£€æŸ¥æ˜¯å¦ key å·²ç»å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™éå†é“¾è¡¨å¯»æ‰¾ä½ç½®ï¼Œæ‰¾åˆ°åæ›¿æ¢ value</span>
                <span class="token class-name">K</span> k<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span>
                    <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
                        <span class="token operator">++</span>modCount<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// first æœ‰å€¼æ²¡è¯´æ˜ index ä½ç½®å·²ç»æœ‰å€¼äº†ï¼Œæœ‰å†²çªï¼Œé“¾è¡¨å¤´æ’æ³•ã€‚</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    node<span class="token punctuation">.</span><span class="token function">setNext</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> c <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token comment">// å®¹é‡å¤§äºæ‰©å®¹é˜€å€¼ï¼Œå°äºæœ€å¤§å®¹é‡ï¼Œè¿›è¡Œæ‰©å®¹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;</span> threshold <span class="token operator">&amp;&amp;</span> tab<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token constant">MAXIMUM_CAPACITY</span><span class="token punctuation">)</span>
                    <span class="token function">rehash</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    <span class="token comment">// index ä½ç½®èµ‹å€¼ nodeï¼Œnode å¯èƒ½æ˜¯ä¸€ä¸ªå…ƒç´ ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªé“¾è¡¨çš„è¡¨å¤´</span>
                    <span class="token function">setEntryAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> index<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">++</span>modCount<span class="token punctuation">;</span>
                count <span class="token operator">=</span> c<span class="token punctuation">;</span>
                oldValue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<ul>
<li><p><code>tryLock()</code> è·å–é”ï¼Œè·å–ä¸åˆ°ä½¿ç”¨ <strong><code>scanAndLockForPut</code></strong> æ–¹æ³•ç»§ç»­è·å–ã€‚</p>
</li>
<li><p>è®¡ç®— put çš„æ•°æ®è¦æ”¾å…¥çš„ index ä½ç½®ï¼Œç„¶åè·å–è¿™ä¸ªä½ç½®ä¸Šçš„ <code>HashEntry</code> ã€‚</p>
</li>
<li><p>éå† put æ–°å…ƒç´ ï¼Œä¸ºä»€ä¹ˆè¦éå†ï¼Ÿå› ä¸ºè¿™é‡Œè·å–çš„ <code>HashEntry</code> å¯èƒ½æ˜¯ä¸€ä¸ªç©ºå…ƒç´ ï¼Œä¹Ÿå¯èƒ½æ˜¯é“¾è¡¨å·²å­˜åœ¨ï¼Œæ‰€ä»¥è¦åŒºåˆ«å¯¹å¾…ã€‚</p>
<p>  å¦‚æœè¿™ä¸ªä½ç½®ä¸Šçš„ <strong><code>HashEntry</code> ä¸å­˜åœ¨</strong>ï¼š</p>
<ol>
<li>å¦‚æœå½“å‰å®¹é‡å¤§äºæ‰©å®¹é˜€å€¼ï¼Œå°äºæœ€å¤§å®¹é‡ï¼Œ<strong>è¿›è¡Œæ‰©å®¹</strong>ã€‚</li>
<li>ç›´æ¥å¤´æ’æ³•æ’å…¥ã€‚</li>
</ol>
<p>  å¦‚æœè¿™ä¸ªä½ç½®ä¸Šçš„ <strong><code>HashEntry</code> å­˜åœ¨</strong>ï¼š</p>
<ol>
<li>åˆ¤æ–­é“¾è¡¨å½“å‰å…ƒç´  key å’Œ hash å€¼æ˜¯å¦å’Œè¦ put çš„ key å’Œ hash å€¼ä¸€è‡´ã€‚ä¸€è‡´åˆ™æ›¿æ¢å€¼</li>
<li>ä¸ä¸€è‡´ï¼Œè·å–é“¾è¡¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç›´åˆ°å‘ç°ç›¸åŒè¿›è¡Œå€¼æ›¿æ¢ï¼Œæˆ–è€…é“¾è¡¨è¡¨é‡Œå®Œæ¯•æ²¡æœ‰ç›¸åŒçš„ã€‚<ol>
<li>å¦‚æœå½“å‰å®¹é‡å¤§äºæ‰©å®¹é˜€å€¼ï¼Œå°äºæœ€å¤§å®¹é‡ï¼Œ<strong>è¿›è¡Œæ‰©å®¹</strong>ã€‚</li>
<li>ç›´æ¥é“¾è¡¨å¤´æ’æ³•æ’å…¥ã€‚</li>
</ol>
</li>
</ol>
</li>
<li><p>å¦‚æœè¦æ’å…¥çš„ä½ç½®ä¹‹å‰å·²ç»å­˜åœ¨ï¼Œæ›¿æ¢åè¿”å›æ—§å€¼ï¼Œå¦åˆ™è¿”å› null.</p>
</li>
</ul>
<h3 id="resize-1"><a href="#resize-1" class="headerlink" title="resize"></a>resize</h3><p>æ‰©å®¹ä½¿ç”¨çš„æ˜¯å¤´æ’æ³•</p>
<h2 id="JDK1-8"><a href="#JDK1-8" class="headerlink" title="JDK1.8"></a>JDK1.8</h2><p><img src="/2024/09/28/24/jdk1.8concurrent.png"><br>ç”±åŸå…ˆçš„Segmentæ•°ç»„ + HashEntryè½¬åŒ–ä¸ºNodeæ•°ç»„ + é“¾è¡¨/çº¢é»‘æ ‘</p>
<h3 id="é‡è¦å±æ€§"><a href="#é‡è¦å±æ€§" class="headerlink" title="é‡è¦å±æ€§"></a>é‡è¦å±æ€§</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>  
    <span class="token keyword">implements</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span> <span class="token comment">// å“ˆå¸Œè¡¨æ•°ç»„ï¼Œå­˜å‚¨é”®å€¼å¯¹</span>

<span class="token comment">/**
 * ä¸‹ä¸€ä¸ªå“ˆå¸Œè¡¨æ•°ç»„ï¼Œä»…åœ¨æ‰©å®¹æ—¶ä½¿ç”¨ï¼Œä¸ä¸ºç©º
 */</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nextTable<span class="token punctuation">;</span>

<span class="token comment">/**
 * åŸºç¡€è®¡æ•°å™¨å€¼ï¼Œä¸»è¦åœ¨æ²¡æœ‰ç«äº‰æ—¶ä½¿ç”¨ï¼Œä¹Ÿä½œä¸ºè¡¨åˆå§‹åŒ–ç«äº‰æœŸé—´çš„å›é€€ã€‚é€šè¿‡CASæ›´æ–°
 */</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> baseCount<span class="token punctuation">;</span>

<span class="token comment">/**
 * è¡¨åˆå§‹åŒ–å’Œæ‰©å®¹æ§åˆ¶ã€‚å½“ä¸ºè´Ÿæ•°æ—¶ï¼Œè¡¨ç¤ºè¡¨æ­£åœ¨åˆå§‹åŒ–æˆ–æ‰©å®¹ï¼š-1è¡¨ç¤ºåˆå§‹åŒ–ï¼Œå¦åˆ™ä¸º-(1 + æ´»åŠ¨æ‰©å®¹çº¿ç¨‹æ•°)ã€‚
 * å¦åˆ™ï¼Œå½“è¡¨ä¸ºç©ºæ—¶ï¼Œä¿å­˜åˆ›å»ºæ—¶ä½¿ç”¨çš„åˆå§‹è¡¨å¤§å°ï¼Œé»˜è®¤ä¸º0ã€‚åˆå§‹åŒ–åï¼Œä¿å­˜ä¸‹ä¸€ä¸ªç”¨äºæ‰©å®¹çš„å…ƒç´ è®¡æ•°å€¼
 */</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> sizeCtl<span class="token punctuation">;</span>

<span class="token comment">/**
 * æ‰©å®¹æ—¶è¦æ‹†åˆ†çš„ä¸‹ä¸€ä¸ªè¡¨ç´¢å¼•ï¼ˆåŠ ä¸€ï¼‰
 */</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> transferIndex<span class="token punctuation">;</span>

<span class="token comment">/**
 * æ‰©å®¹å’Œ/æˆ–åˆ›å»ºCounterCellsæ—¶ä½¿ç”¨çš„è‡ªæ—‹é”ï¼ˆé€šè¿‡CASé”å®šï¼‰
 */</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> cellsBusy<span class="token punctuation">;</span>

<span class="token comment">/**
 * è®¡æ•°å•å…ƒè¡¨ã€‚å½“ä¸ä¸ºç©ºæ—¶ï¼Œå¤§å°ä¸º2çš„å¹‚
 */</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">CounterCell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> counterCells<span class="token punctuation">;</span>

<span class="token comment">// views</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">KeySetView</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> keySet<span class="token punctuation">;</span> <span class="token comment">// é”®é›†åˆè§†å›¾</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">ValuesView</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> values<span class="token punctuation">;</span> <span class="token comment">// å€¼é›†åˆè§†å›¾</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">EntrySetView</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> entrySet<span class="token punctuation">;</span> <span class="token comment">// é”®å€¼å¯¹é›†åˆè§†å›¾</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><p>åŸºæœ¬ä¸HashMapä¸­çš„ç›¸åŒï¼Œæ‰€ä»¥ç•¥è¿‡</p>
<h3 id="initTable"><a href="#initTable" class="headerlink" title="initTable"></a>initTable</h3><p>åˆå§‹åŒ–</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> <span class="token keyword">int</span> sc<span class="token punctuation">;</span>
       <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> tab<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// sizeCtl &lt; 0 è¯´æ˜å…¶ä»–çº¿ç¨‹CASæˆåŠŸï¼Œæ­£åœ¨åˆå§‹åŒ–æˆ–</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">=</span> sizeCtl<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token comment">// è®©å‡ºcpu</span>
               <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
           <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">SIZECTL</span><span class="token punctuation">,</span> sc<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">try</span> <span class="token punctuation">{</span>
                   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> tab<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token punctuation">(</span>sc <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> sc <span class="token operator">:</span> <span class="token constant">DEFAULT_CAPACITY</span><span class="token punctuation">;</span>
                       <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
                       <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
                       table <span class="token operator">=</span> tab <span class="token operator">=</span> nt<span class="token punctuation">;</span>
                       sc <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token punctuation">}</span>
               <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                   sizeCtl <span class="token operator">=</span> sc<span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span> tab<span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>é€šè¿‡è‡ªæ—‹ + CASæ“ä½œæ¥å®Œæˆåˆå§‹åŒ–</li>
<li>sizeCtl çš„å€¼<ul>
<li>-1 ï¼š æ­£åœ¨åˆå§‹åŒ–</li>
<li><ul>
<li>Nï¼šæ­£åœ¨æ‰©å®¹é«˜16ä½ä½æ‰©å®¹çš„æ ‡è¯†æˆ³ï¼Œä½16ä½-1ä½æ­£åœ¨æ‰©å®¹çš„çº¿ç¨‹æ•°</li>
</ul>
</li>
<li>0 ï¼štableåˆå§‹åŒ–å¤§å°ï¼Œå¦‚æœtableæ²¡æœ‰åˆå§‹åŒ–</li>
<li><blockquote>
<p>0 ï¼š æ‰©å®¹é˜ˆå€¼</p>
</blockquote>
</li>
</ul>
</li>
</ol>
<h3 id="put-2"><a href="#put-2" class="headerlink" title="put"></a>put</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token function">putVal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token comment">/** Implementation for put and putIfAbsent */</span>  
<span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// è®¡ç®—hash</span>
    <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">spread</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// è®¡æ•°å™¨ï¼Œæ£€æµ‹é“¾è¡¨é•¿åº¦ï¼Œç»Ÿè®¡èŠ‚ç‚¹ä¸ªæ•°ï¼Œæ§åˆ¶å¾ªç¯</span>
    <span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	    <span class="token comment">// fæ˜¯ç›®æ ‡å…ƒç´ çš„ä½ç½®, fhæ˜¯åé¢å­˜æ”¾ç›®æ ‡ä½ç½®å…ƒç´ çš„hashå€¼</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> f<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fh<span class="token punctuation">;</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  
		    <span class="token comment">// æ•°æ®æ¡¶ä¸ºç©ºï¼Œå°±å…ˆåˆå§‹åŒ–</span>
            tab <span class="token operator">=</span> <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token comment">// å®šä½åˆ°è¿™ä¸ªä½ç½®ä¹‹åå‘ç°æ¡¶ä¸­æ²¡æœ‰æ•°æ®ï¼Œå°±ç›´æ¥æ”¾å…¥ï¼Œä¸åŠ é”ï¼Œç„¶åè·³å‡ºå³å¯</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">casTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  
                         <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                <span class="token keyword">break</span><span class="token punctuation">;</span>                   <span class="token comment">// no lock when adding to empty bin  </span>
        <span class="token punctuation">}</span>  
        <span class="token comment">// æ£€æŸ¥å½“å‰æ¡¶ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ä¸€ä¸ª ForwardingNodeã€‚ForwardingNode æ˜¯åœ¨å“ˆå¸Œè¡¨æ‰©å®¹æ—¶ä½¿ç”¨çš„ä¸€ç§ç‰¹æ®ŠèŠ‚ç‚¹ç±»å‹ï¼Œç”¨äºæŒ‡ç¤ºè¯¥æ¡¶çš„å†…å®¹å·²ç»è¢«ç§»åŠ¨åˆ°æ–°çš„å“ˆå¸Œè¡¨ä¸­ã€‚ </span>
        <span class="token comment">// å¦‚æœæ˜¯å°±éœ€è¦helpTranfer</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fh <span class="token operator">=</span> f<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">MOVED</span><span class="token punctuation">)</span>  
            tab <span class="token operator">=</span> <span class="token function">helpTransfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">else</span> <span class="token punctuation">{</span>  
            <span class="token class-name">V</span> oldVal <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
            <span class="token comment">// å¯¹èŠ‚ç‚¹fåŠ é”</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	                <span class="token comment">// å‘ç°æ˜¯é“¾è¡¨</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>fh <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                        binCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  
                        <span class="token comment">// å¾ªç¯åŠ å…¥æ–°çš„èŠ‚ç‚¹ï¼Œæˆ–è€…è¦†ç›–</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> f<span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                            <span class="token class-name">K</span> ek<span class="token punctuation">;</span>  
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>  
                                <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span>  
                                 <span class="token punctuation">(</span>ek <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                                oldVal <span class="token operator">=</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>  
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>  
                                    e<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>  
                                <span class="token keyword">break</span><span class="token punctuation">;</span>  
                            <span class="token punctuation">}</span>                            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> pred <span class="token operator">=</span> e<span class="token punctuation">;</span>  
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                                pred<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span>  
                                                          value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                                <span class="token keyword">break</span><span class="token punctuation">;</span>  
                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">TreeBin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                            <span class="token comment">//å‘ç°æ˜¯çº¢é»‘æ ‘</span>
                        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> p<span class="token punctuation">;</span>  
                        binCount <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span>  
                                                       value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                            oldVal <span class="token operator">=</span> p<span class="token punctuation">.</span>val<span class="token punctuation">;</span>  
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>  
                                p<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>  
                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">&gt;=</span> <span class="token constant">TREEIFY_THRESHOLD</span><span class="token punctuation">)</span>  
                    <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVal <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>  
                    <span class="token keyword">return</span> oldVal<span class="token punctuation">;</span>  
                <span class="token keyword">break</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">addCount</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> binCount<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>é€šè¿‡keyè®¡ç®—hashcode</li>
<li>åˆ¤æ–­æ˜¯å¦éœ€è¦åˆå§‹åŒ–</li>
<li>å®šä½åˆ°Nodeï¼Œå¦‚æœä¸ºç©ºç›´æ¥ç”¨CASå†™å…¥ï¼Œå¤±è´¥å°±è‡ªæ—‹ä¿è¯æˆåŠŸ</li>
<li>å¦‚æœhashcode == MOVED == - 1éœ€è¦è¿›è¡Œæ‰©å®¹</li>
<li>å¦‚æœéƒ½ä¸æ»¡è¶³å°±ä½¿ç”¨synchronizedé”å†™å…¥æ•°æ®</li>
<li>å¦‚æœæ•°é‡å¤§äºTREEIFY_THRESHOLDè°ƒç”¨treeifyBinè¿›è¡Œè½¬åŒ–<br><strong>å€¼å¾—ä¸€æçš„æ˜¯synchronizedåœ¨è¿™é‡Œæ˜¯é”ä½äº†è¿™ä¸ªä¸€ä¸ªæ¡¶ï¼Œä¹Ÿæ˜¯è¿™ä¸€ä¸ªNodeï¼Œè€Œä¸æ˜¯ä¸€æ•´ä¸ªè¡¨</strong></li>
</ol>
<h3 id="get-1"><a href="#get-1" class="headerlink" title="get"></a>get</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e<span class="token punctuation">,</span> p<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> eh<span class="token punctuation">;</span> <span class="token class-name">K</span> ek<span class="token punctuation">;</span>
    <span class="token comment">// key æ‰€åœ¨çš„ hash ä½ç½®</span>
    <span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token function">spread</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>e <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæŒ‡å®šä½ç½®å…ƒç´ å­˜åœ¨ï¼Œå¤´ç»“ç‚¹hashå€¼ç›¸åŒ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>eh <span class="token operator">=</span> e<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>ek <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// key hash å€¼ç›¸ç­‰ï¼Œkeyå€¼ç›¸åŒï¼Œç›´æ¥è¿”å›å…ƒç´  value</span>
                <span class="token keyword">return</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>eh <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">// å¤´ç»“ç‚¹hashå€¼å°äº0ï¼Œè¯´æ˜æ­£åœ¨æ‰©å®¹æˆ–è€…æ˜¯çº¢é»‘æ ‘ï¼ŒfindæŸ¥æ‰¾</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> p<span class="token punctuation">.</span>val <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ˜¯é“¾è¡¨ï¼Œéå†æŸ¥æ‰¾</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>ek <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="å¸¸è§å…«è‚¡"><a href="#å¸¸è§å…«è‚¡" class="headerlink" title="å¸¸è§å…«è‚¡"></a>å¸¸è§å…«è‚¡</h1><h2 id="HashMapçš„åº•å±‚å®ç°æ˜¯ä»€ä¹ˆ"><a href="#HashMapçš„åº•å±‚å®ç°æ˜¯ä»€ä¹ˆ" class="headerlink" title="HashMapçš„åº•å±‚å®ç°æ˜¯ä»€ä¹ˆ"></a>HashMapçš„åº•å±‚å®ç°æ˜¯ä»€ä¹ˆ</h2><p>JDK1.8ä¹‹å‰æ˜¯æ•°ç»„ + é“¾è¡¨ï¼Œæ•°ç»„æ˜¯HashMapçš„ä¸»ä½“ï¼Œé“¾è¡¨æ˜¯ç”¨æ¥è§£å†³å“ˆå¸Œå†²çªã€‚ä½¿ç”¨æ‹‰é“¾æ³•æ¥è§£å†³ã€‚<br>JDK1.8ä¹‹åå˜ä¸ºæ•°ç»„+é“¾è¡¨/çº¢é»‘æ ‘ï¼Œå½“é“¾è¡¨é•¿åº¦å¤§äºç­‰äºé˜ˆå€¼ <u>8</u> æ—¶ï¼Œä¼šè½¬åŒ–ï¼Œå¦‚æœå½“å‰æ•°ç»„é•¿åº¦å°äº64å°±å­¦ä¼šå…ˆè¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œå¦åˆ™å°±è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œé»˜è®¤å¤§å°ä¸º16ï¼Œæ¯æ¬¡æ‰©å®¹2å€ã€‚</p>
<h2 id="æ‹‰é“¾æ³•åˆ°åº•æ˜¯ä»€ä¹ˆ"><a href="#æ‹‰é“¾æ³•åˆ°åº•æ˜¯ä»€ä¹ˆ" class="headerlink" title="æ‹‰é“¾æ³•åˆ°åº•æ˜¯ä»€ä¹ˆ"></a>æ‹‰é“¾æ³•åˆ°åº•æ˜¯ä»€ä¹ˆ</h2><p>æ‹‰é“¾æ³•å°±æ˜¯ä½¿ç”¨ä¸€ä¸ªé“¾è¡¨æ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸€æ ¼éƒ½æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå¦‚æœé‡è§å“ˆå¸Œå†²çªï¼Œåˆ™å°†å†²çªçš„å€¼åŠ åˆ°é“¾è¡¨ä¸­ã€‚<br>JDK1.8ä¹‹åä¼šå…ˆåˆ¤æ–­é“¾è¡¨çš„é•¿åº¦æ˜¯å¦å¤§äºé˜ˆå€¼8ï¼Œç„¶åå»æ ¹æ®æ•°æ®æ¥åˆ¤æ–­æ˜¯å¦è½¬åŒ–ä¸ºçº¢é»‘æ ‘ã€‚<br><img src="/2024/09/28/24/%E6%95%B0%E6%8D%AE+%E7%BA%A2%E9%BB%91%E6%A0%91.png" alt="|450"></p>
<h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨2ä½œä¸ºåº•æ•°"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨2ä½œä¸ºåº•æ•°" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨2ä½œä¸ºåº•æ•°"></a>ä¸ºä»€ä¹ˆä½¿ç”¨2ä½œä¸ºåº•æ•°</h2><ol>
<li>ä½¿ç”¨2ä½œä¸ºåº•æ•°å¯ä»¥ä½¿ç”¨ä½è¿ç®—è€Œä¸æ˜¯å–æ¨¡å»è®¡ç®—ç´¢å¼•ï¼Œæ¯”è¾ƒæ–¹ä¾¿ï¼Œæé«˜æ€§èƒ½</li>
<li>åŒæ—¶å®¹é‡æ˜¯2çš„å¹‚æ¬¡æ—¶ï¼Œå“ˆå¸Œå€¼çš„ä½ä½å’Œé«˜ä½éƒ½å¯ä»¥å‚ä¸ç´¢å¼•çš„è®¡ç®—ï¼Œå‡å°‘å“ˆå¸Œå†²çª(capacity æ˜¯ 2 çš„å¹‚æ¬¡ï¼Œå› æ­¤ capacity - 1 çš„äºŒè¿›åˆ¶è¡¨ç¤ºå…¨æ˜¯ 1ï¼Œè¿™æ · hash &amp; (capacity - 1) å°±èƒ½é«˜æ•ˆåœ°è®¡ç®—å‡ºç´¢å¼•ã€‚)</li>
<li>æ‰©å®¹æ›´æ›´ç®€å•ï¼Œé‡æ–°è®¡ç®—å“ˆå¸Œåªéœ€è¦æ£€æŸ¥å“ˆå¸Œå€¼çš„ä¸€ä¸ªé¢å¤–ä½</li>
</ol>
<h2 id="è®²è§£ä¸€ä¸‹putçš„è¿‡ç¨‹"><a href="#è®²è§£ä¸€ä¸‹putçš„è¿‡ç¨‹" class="headerlink" title="è®²è§£ä¸€ä¸‹putçš„è¿‡ç¨‹"></a>è®²è§£ä¸€ä¸‹putçš„è¿‡ç¨‹</h2><ol>
<li>åˆ¤æ–­mapæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºæˆ–è€…é•¿åº¦ä½0å°±åŠé€†è¡Œåˆå§‹åŒ–æˆ–è€…æ‰©å®¹</li>
<li>ä¹‹åè®¡ç®—hashå€¼ï¼Œå»åŒ¹é…Nodeæ•°ç»„ï¼Œå¦‚æœå®šä½åˆ°çš„æ•°ç»„æ²¡æœ‰ä½ç½®ä¸ºç©ºï¼Œåˆ™ç›´æ¥æ’å…¥åˆ°Nodeæ•°ç»„ä¸­</li>
<li>å¦‚æœä¸ä¸ºç©ºï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯æ ‘èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯å°±è°ƒç”¨putTreeValï¼Œå¦åˆ™å°±å»éå†è¿™ä¸ªæ•°ç»„æ‰€å¯¹åº”çš„é“¾è¡¨ï¼Œå¦‚æœå‡ºç°å“ˆå¸Œå€¼å’Œkeyå®Œå…¨ä¸€è‡´å°±è¦†ç›–æ•°æ®ï¼Œå¦åˆ™å°±éå†åˆ°æœ€åä½¿ç”¨å°¾æ’æ³•ï¼Œæ’å…¥æ•°æ®</li>
<li>æ’å…¥æˆ–è€…è¦†ç›–æ•°æ®ä¹‹ååˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹æˆ–è€…è½¬åŒ–ä¸ºæ ‘å½¢ç»“æ„</li>
</ol>
<h2 id="ä¸ºä»€ä¹ˆJDK1-8ä½¿ç”¨å°¾æ’æ³•è€Œä¸æ˜¯å’ŒJDK1-7ä¸€æ ·ä½¿ç”¨å¤´æ’æ³•"><a href="#ä¸ºä»€ä¹ˆJDK1-8ä½¿ç”¨å°¾æ’æ³•è€Œä¸æ˜¯å’ŒJDK1-7ä¸€æ ·ä½¿ç”¨å¤´æ’æ³•" class="headerlink" title="ä¸ºä»€ä¹ˆJDK1.8ä½¿ç”¨å°¾æ’æ³•è€Œä¸æ˜¯å’ŒJDK1.7ä¸€æ ·ä½¿ç”¨å¤´æ’æ³•"></a>ä¸ºä»€ä¹ˆJDK1.8ä½¿ç”¨å°¾æ’æ³•è€Œä¸æ˜¯å’ŒJDK1.7ä¸€æ ·ä½¿ç”¨å¤´æ’æ³•</h2><p>å› ä¸ºå¤šçº¿ç¨‹çš„æƒ…å†µå¤´æ’æ³•æœ‰å¯èƒ½ä¼šå‡ºç°ç¯</p>
<h2 id="HashMapä½•æ—¶ä¼šæ‰©å®¹"><a href="#HashMapä½•æ—¶ä¼šæ‰©å®¹" class="headerlink" title="HashMapä½•æ—¶ä¼šæ‰©å®¹"></a>HashMapä½•æ—¶ä¼šæ‰©å®¹</h2><p>å½“é“¾è¡¨çš„é•¿åº¦å¤§äºTREEIFY_THRESHOLD(é»˜è®¤ä¸º8)æ—¶ä¼šå¼€å§‹è½¬åŒ–ï¼ŒåŒæ—¶è¦åˆ¤æ–­Nodeæ•°ç»„çš„ä¸ªæ•°æ˜¯å¦å¤§äºMIN_TREEIFY_CAPACITY(é»˜è®¤64)ï¼Œå¦‚æœå°äºå°±ä¼šå…ˆè¿›è¡Œæ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬åŒ–ï¼Œå¦‚æœå¤§äºå°±ç›´æ¥è½¬åŒ–ä¸ºçº¢é»‘æ ‘</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zuofw.github.io/2024/12/24/44/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QingQiu">
      <meta itemprop="description" content="ä¸ªäººç½‘ç«™ï¼Œå­¦ä¹ è®°å½•ï¼Œé¢è¯•è®°å½•å’Œç»éªŒæ€»ç»“ã€äº’è”ç½‘ä¸­ä¸€å—å±äºè‡ªå·±çš„å°çª">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QingQiu'Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/24/44/" class="post-title-link" itemprop="url">åº¦å°æ»¡</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-12-24 13:13:44" itemprop="dateCreated datePublished" datetime="2024-12-24T13:13:44+08:00">2024-12-24</time>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>2.3k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="åº¦å°æ»¡æ•°æ®åº“åç«¯ç ”å‘"><a href="#åº¦å°æ»¡æ•°æ®åº“åç«¯ç ”å‘" class="headerlink" title="åº¦å°æ»¡æ•°æ®åº“åç«¯ç ”å‘"></a>åº¦å°æ»¡æ•°æ®åº“åç«¯ç ”å‘</h1><h1 id="ä¸€é¢2024-12-24-å·²oc"><a href="#ä¸€é¢2024-12-24-å·²oc" class="headerlink" title="ä¸€é¢2024.12.24(å·²oc)"></a>ä¸€é¢2024.12.24(å·²oc)</h1><p>ä¸Šåˆé¢ï¼Œæ™šä¸Šçº¦äºŒé¢</p>
<h2 id="æµç¨‹"><a href="#æµç¨‹" class="headerlink" title="æµç¨‹"></a>æµç¨‹</h2><p>é—®äº†40åˆ†é’Ÿï¼Œæ„Ÿè§‰åƒæ˜¯kpiï¼Œå®ä¹ å’Œé¡¹ç›®æ‹·æ‰“æŒºå¤šï¼Œæ¯ä¸€æ¡éƒ½é—®äº†ï¼Œå…«è‚¡æ²¡å’‹é—®</p>
<ol>
<li>è‡ªæˆ‘ä»‹ç»</li>
<li>æ¥æ”¶è½¬è¯­è¨€å—</li>
<li>å®ä¹ æ‹·æ‰“<ol>
<li>æ¯”è¾ƒé‡è¦çš„éš¾ç‚¹æˆ–è€…äº®ç‚¹</li>
<li>æ€ä¹ˆå¾—åˆ°çš„ä¼˜åŒ–æ•ˆç‡ </li>
<li>ä¸ºä»€ä¹ˆé€‰æ‹©RocketMQè€Œä¸æ˜¯å…¶ä»–æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>ä»‹ç»ä¸€ä¸‹ç­–ç•¥æ¨¡å¼å’Œæ¨¡æ¿æ¨¡å¼æ€ä¹ˆåº”ç”¨çš„</li>
<li>åˆ†å¸ƒå¼è°ƒåº¦å’ŒRedisåˆ†å¸ƒå¼é”</li>
<li>å¦‚ä½•ä¼˜åŒ–sqlçš„ï¼Ÿ</li>
</ol>
</li>
<li>é¡¹ç›®æ‹·æ‰“ï¼š<ol>
<li>æ¶æ„ï¼Ÿæ–‡ä»¶ä¸Šä¼ (åˆ†ç‰‡ä¸Šä¼ é€»è¾‘ï¼Ÿè¶…æ—¶é‡ä¼ ï¼Ÿæ–­ç‚¹é‡ä¼ ï¼Ÿç§’ä¼ ï¼Ÿ)</li>
<li>å¤šçº§ç¼“å­˜çš„è®¾è®¡ï¼Ÿä¸ºä»€ä¹ˆä½¿ç”¨å¤šçº§ç¼“å­˜ï¼Ÿå¦‚ä½•ç»´æŠ¤æœ¬åœ°ç¼“å­˜å’ŒRedisçš„ä¸€è‡´æ€§ï¼Ÿ</li>
</ol>
</li>
<li>æŒ‘ä¸€ä¸ªæ•°æ®ç»“æ„æˆ–è€…ç®—æ³•æ¥è®²è®²(æˆ‘è®²çš„å›¾è®º)</li>
<li>TCPå››å±‚æ¨¡å‹ï¼Ÿ æ¯ä¸€å±‚çš„åè®®ï¼Ÿ</li>
<li>TCPå’ŒUDPåŒºåˆ«(7ç‚¹ï¼Œæ²¡ç­”å…¨)</li>
<li>Linuxå¸¸è§å‘½ä»¤</li>
<li>binlogå’Œredologçš„åŒºåˆ«å’Œåº”ç”¨åœºæ™¯</li>
<li>éš”ç¦»ç­‰çº§å’Œå¦‚ä½•è§£å†³ç›¸å…³é—®é¢˜çš„</li>
<li>åé—®ï¼šè´Ÿè´£ä¸šåŠ¡ï¼Œå»ºè®®(æ¢ä¸ªéº¦ï¼Œéº¦æœ‰ç‚¹éš¾èšŒ) å»ºè®®å¤šç»“åˆå…·ä½“ä¾‹å­å»å›ç­”é—®é¢˜ï¼Œæ—¥å¸¸ or æœ‰è½¬æ­£ï¼Ÿ ç­”ï¼šæ—¥å¸¸</li>
</ol>
<h3 id="æ¯”è¾ƒé‡è¦çš„éš¾ç‚¹æˆ–è€…äº®ç‚¹"><a href="#æ¯”è¾ƒé‡è¦çš„éš¾ç‚¹æˆ–è€…äº®ç‚¹" class="headerlink" title="æ¯”è¾ƒé‡è¦çš„éš¾ç‚¹æˆ–è€…äº®ç‚¹"></a>æ¯”è¾ƒé‡è¦çš„éš¾ç‚¹æˆ–è€…äº®ç‚¹</h3><p>æ•°æ®åŒæ­¥ä½¿ç”¨çº¿ç¨‹æ± ï¼Œä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹æ± å‡ºç°OOMäº†ï¼Œå¦‚ä½•è§£å†³çš„ã€‚ ä¼˜åŒ–ç‚¹ï¼šè®²è®²çº¿ç¨‹æ± æºç ï¼Œä»»åŠ¡é˜Ÿåˆ—ï¼Œå‚æ•°ï¼Œä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± </p>
<h3 id="ä¸ºä»€ä¹ˆé€‰å‹ä½¿ç”¨äº†RocketMQè€Œä¸æ˜¯å…¶ä»–-ç­”å¾—ä¸å¥½"><a href="#ä¸ºä»€ä¹ˆé€‰å‹ä½¿ç”¨äº†RocketMQè€Œä¸æ˜¯å…¶ä»–-ç­”å¾—ä¸å¥½" class="headerlink" title="ä¸ºä»€ä¹ˆé€‰å‹ä½¿ç”¨äº†RocketMQè€Œä¸æ˜¯å…¶ä»–(ç­”å¾—ä¸å¥½)"></a>ä¸ºä»€ä¹ˆé€‰å‹ä½¿ç”¨äº†RocketMQè€Œä¸æ˜¯å…¶ä»–(ç­”å¾—ä¸å¥½)</h3><ol>
<li>ä¸å¸Œæœ›å¼•å…¥æ–°çš„æŠ€æœ¯æ ˆ</li>
<li>å¯é æ€§é«˜ï¼šRocketMQæ”¯æŒä¸»ä»åŒåŒæ­¥åˆ·ç›˜æœºåˆ¶ï¼Œç›¸è¾ƒäºKafkaçš„å¼‚æ­¥åˆ·ç›˜æœºåˆ¶ï¼Œè™½ç„¶ä¼šé™ä½æ€§èƒ½ï¼Œä½†æ˜¯å¯é æ€§æ›´é«˜ã€‚</li>
<li>å•æœºæ”¯æŒçš„é˜Ÿåˆ—æ•°ï¼šKafkaå•æœºè¶…è¿‡64ä¸ªåˆ†åŒº/é˜Ÿåˆ—ï¼Œæ€§èƒ½ä¼šä¸‹é™ï¼ŒRocketMQå•æœºæœ€å¤šæ”¯æŒ5wä¸ªé˜Ÿåˆ—ï¼Œè´Ÿè½½ä¸ä¼šå‡ºç°æ˜æ˜¾çš„å˜åŒ–</li>
<li>RocketMQæ¶ˆè´¹å¤±è´¥æ”¯æŒé‡è¯•ã€‚</li>
<li>RocketMQæ”¯æŒä¸¥æ ¼çš„æ¶ˆæ¯é¡ºåºï¼Œæ”¯æŒå…¨å±€é¡ºåºï¼Œä¸€å°Brokerå®•æœºåï¼Œå‘é€æ¶ˆæ¯ä¼šå¤±è´¥ï¼Œä½†æ˜¯ä¸ä¼šä¹±åº(MySQLäºŒè¿›åˆ¶æ—¥å¿—åˆ†å‘éœ€è¦ä¸¥æ ¼çš„æ¶ˆæ¯é¡ºåº)</li>
<li>RocketMQæ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡å’Œå®šæ—¶ä»»åŠ¡</li>
<li>æ‰‹æ’•ï¼šé‡æ’é“¾è¡¨</li>
</ol>
<h3 id="å¦‚ä½•åŸºäºç­–ç•¥æ¨¡å¼å’Œæ¨¡æ¿æ¨¡å¼è¿›è¡Œexcelçš„å¯¼å…¥å’Œå¯¼å‡ºçš„-ç­”å¾—ä¸å¥½"><a href="#å¦‚ä½•åŸºäºç­–ç•¥æ¨¡å¼å’Œæ¨¡æ¿æ¨¡å¼è¿›è¡Œexcelçš„å¯¼å…¥å’Œå¯¼å‡ºçš„-ç­”å¾—ä¸å¥½" class="headerlink" title="å¦‚ä½•åŸºäºç­–ç•¥æ¨¡å¼å’Œæ¨¡æ¿æ¨¡å¼è¿›è¡Œexcelçš„å¯¼å…¥å’Œå¯¼å‡ºçš„(ç­”å¾—ä¸å¥½)"></a>å¦‚ä½•åŸºäºç­–ç•¥æ¨¡å¼å’Œæ¨¡æ¿æ¨¡å¼è¿›è¡Œexcelçš„å¯¼å…¥å’Œå¯¼å‡ºçš„(ç­”å¾—ä¸å¥½)</h3><ol>
<li>è¿™ä¿©çš„æ¦‚å¿µ</li>
<li>å¯¹äºä¸åŒç±»å‹çš„excelæ–‡ä»¶ï¼Œæ¯”å¦‚ä¸åŒä¸šåŠ¡éœ€è¦ä¸åŒçš„æ“ä½œï¼Œä½†æ˜¯ä»–ä»¬ä¼šæœ‰ä¸€äº›å…¬å…±çš„æ“ä½œæ­¥éª¤ï¼Œå¯ä»¥ä½¿ç”¨æ¨¡æ¿æ¨¡å¼æ¥è¿›è¡Œè§„å®šæ­¥éª¤å’ŒæŠ½å–å…¬å…±ç»„æˆã€‚ç„¶ååŸºäºç”¨å¤„ä¸åŒçš„excelè¿›è¡Œä¸åŒçš„è®¾è®¡ï¼Œæ¯”å¦‚å¯¼å‡ºå’Œå¯¼å…¥ï¼Œæœ‰ä¸€äº›excelå¯èƒ½æ˜¯éœ€è¦æˆ‘ä»¬è§£æï¼Œç„¶åè¿”å›ç»™è°ƒç”¨æ–¹ï¼Œä½†æ˜¯æœ‰ä¸€äº›åªéœ€è¦æˆ‘ä»¬è§£æç„¶åè¿›è¡Œä¸€äº›å…¶ä»–çš„æ“ä½œï¼Œæˆ–è€…æ˜¯å•çº¯ä¿®æ”¹excelï¼Œå¯ä»¥è®¾è®¡æˆä¸åŒçš„ç®—æ³•å°è£…èµ·æ¥ã€‚</li>
</ol>
<h3 id="TCPå’ŒUDPçš„åŒºåˆ«"><a href="#TCPå’ŒUDPçš„åŒºåˆ«" class="headerlink" title="TCPå’ŒUDPçš„åŒºåˆ«"></a>TCPå’ŒUDPçš„åŒºåˆ«</h3><ol>
<li>è¿æ¥ï¼šTCPé¢å‘è¿æ¥ï¼Œå…ˆè¦å»ºç«‹è¿æ¥æ‰èƒ½ä¼ è¾“ã€‚UDPä¸éœ€è¦è¿æ¥ï¼Œç›´æ¥å°±å¯å¯ä»¥ä¼ è¾“æ•°æ®ã€‚</li>
<li>æœåŠ¡å¯¹è±¡ï¼šTCPç‚¹å¯¹ç‚¹ï¼ŒUDPæ”¯æŒä¸€å¯¹ä¸€ï¼Œä¸€å¯¹å¤šï¼Œå¤šå¯¹å¤š</li>
<li>å¯é æ€§ï¼šTCPå¯é äº¤ä»˜æ•°æ®ï¼Œä¿è¯æ•°æ®æ— å·®åˆ«ï¼Œä¸é‡å¤ï¼ŒæŒ‰åºåˆ°è¾¾ã€‚UDPå°½æœ€å¤§åŠªåŠ›äº¤ä»˜ï¼Œä¸ä¿è¯å¯é äº¤ä»˜æ•°æ®ã€‚</li>
<li>æ‹¥å¡æ§åˆ¶ã€æµé‡æ§åˆ¶ï¼šTCPæœ‰æ‹¥å¡æ§åˆ¶å’Œæµé‡æ§åˆ¶èƒ½å¤Ÿä¿è¯æ•°æ®ä¼ è¾“çš„å®‰å…¨æ€§ã€‚UDPæ²¡æœ‰ï¼Œå³ä½¿ç½‘ç»œéå¸¸æ‹¥å µäº†ï¼Œä¹Ÿä¸ä¼šå½±å“UDPçš„å‘é€é€Ÿç‡</li>
<li>é¦–éƒ¨å¼€é”€ï¼šTCPæ•°æ®å¤§å°å¦‚æœå¤§äºMSSï¼Œå°±ä¼šåœ¨ä¼ è¾“å±‚è¿›è¡Œåˆ†ç‰‡ã€‚UDPæ•°æ®å¤§å°å¦‚æœå¤§äºMTUå°±ä¼šåœ¨IPå±‚è¿›è¡Œåˆ†ç‰‡ã€‚![[format,png-20230309230419839.webp]]</li>
<li>ä¼ è¾“æ–¹å¼ï¼šTCPæ˜¯æµå¼ä¼ è¾“ï¼Œæ²¡æœ‰è¾¹ç•Œï¼Œä½†ä¿è¯é¡ºåºå’Œå¯é ã€‚UDPæ˜¯ä¸€ä¸ªåŒ…ä¸€ä¸ªåŒ…çš„å‘é€ï¼Œæ˜¯æœ‰è¾¹ç•Œçš„ï¼Œä½†å¯èƒ½ä¼šä¸¢åŒ…å’Œä¹±åºã€‚</li>
<li>åˆ†ç‰‡ä¸åŒï¼šTCPçš„æ•°æ®å¤§å°ï¼Œå¦‚æœå¤§äºMSSåˆ™ä¼šåœ¨ä¼ è¾“å±‚è¿›è¡Œåˆ†ç‰‡ï¼Œç›®æ ‡ä¸»è§’åŠæ”¶åˆ°ä¹‹åä¹Ÿä¼šåœ¨ä¼ è¾“å±‚è¿›è¡Œç»„è£…ï¼Œä¸­é€”å‡ºç°ä¸¢åŒ…ï¼Œåªéœ€è¦ä¼ è¾“ä¸¢å¤±çš„è¿™ä¸ªåˆ†ç‰‡ã€‚UDPçš„æ•°æ®å¤§å°å¦‚æœå¤§äºMTUå¤§å°ï¼Œåˆ™ä¼šåœ¨IPå±‚è¿›è¡Œåˆ†ç‰‡ï¼Œç›®æ ‡ä¸»æœºæ”¶åˆ°ä¹‹åï¼Œåœ¨IPå±‚ç»„è£…å®Œæ•°æ®ï¼Œè®°è€…å†ä¼ ç»™ä¼ è¾“å±‚ã€‚</li>
</ol>
<h3 id="binlogå’Œredologçš„åŒºåˆ«å’Œåº”ç”¨åœºæ™¯"><a href="#binlogå’Œredologçš„åŒºåˆ«å’Œåº”ç”¨åœºæ™¯" class="headerlink" title="binlogå’Œredologçš„åŒºåˆ«å’Œåº”ç”¨åœºæ™¯"></a>binlogå’Œredologçš„åŒºåˆ«å’Œåº”ç”¨åœºæ™¯</h3><p>binlogä¸»è¦ç”¨äºæ•°æ®å¤åˆ¶å’Œæ¢å¤ï¼Œè®°å½•çš„æ˜¯æ›´æ”¹æ•°æ®åº“çš„SQLè¯­å¥<br>redologä¸»è¦ç”¨äºæ•°æ®çš„æŒä¹…åŒ–å’Œå´©æºƒæ¢å¤ï¼Œè®°å½•çš„æ˜¯äº‹åŠ¡çš„ç‰©ç†æ›´æ”¹ï¼Œæ¯”å¦‚æ•°æ®é¡µçš„ä¿®æ”¹ã€‚<br>å´©æºƒæ¢å¤ï¼šä½¿ç”¨redologå¯ä»¥æ¢å¤æœªæäº¤çš„äº‹åŠ¡ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œredologæ˜¯é¡ºåºå†™å…¥ï¼Œå¯ä»¥æé«˜æ•°æ®åº“çš„å†™å…¥æ€§èƒ½</p>
<h3 id="mysqléš”ç¦»ç­‰çº§å’Œåˆ†åˆ«è§£å†³äº†å“ªäº›é—®é¢˜ï¼Œå¦‚ä½•è§£å†³çš„"><a href="#mysqléš”ç¦»ç­‰çº§å’Œåˆ†åˆ«è§£å†³äº†å“ªäº›é—®é¢˜ï¼Œå¦‚ä½•è§£å†³çš„" class="headerlink" title="mysqléš”ç¦»ç­‰çº§å’Œåˆ†åˆ«è§£å†³äº†å“ªäº›é—®é¢˜ï¼Œå¦‚ä½•è§£å†³çš„"></a>mysqléš”ç¦»ç­‰çº§å’Œåˆ†åˆ«è§£å†³äº†å“ªäº›é—®é¢˜ï¼Œå¦‚ä½•è§£å†³çš„</h3><ol>
<li>è¯»æœªæäº¤ï¼šä¸è§£å†³è„è¯»ï¼Œäº‹åŠ¡å¯ä»¥è¯»åˆ°å…¶ä»–äº‹åŠ¡æœªæäº¤çš„äº‹åŠ¡</li>
<li>è¯»å·²æäº¤ï¼šæ¯æ¬¡è¯»å–äº‹åŠ¡ï¼Œåªèƒ½è¯»å–åˆ°å…¶ä»–äº‹åŠ¡å·²ç»æäº¤çš„äº‹åŠ¡ï¼Œé¿å…è„è¯»</li>
<li>å¯é‡å¤è¯»ï¼šè§£å†³äº†è„è¯»å’Œä¸å¯é‡å¤åº¦ï¼Œä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®æ—¶ï¼Œä¿è¯è¯»å–åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œé¿å…äº†è„è¯»å’Œä¸å¯é‡å¤è¯»é—®é¢˜ã€‚MySQL InnoDBæ˜¯é€šè¿‡MVCC+é”æ¥è§£å†³çš„å¹»è¯»</li>
<li>ä¸²è¡ŒåŒ–ï¼šå¯¹æ‰€æœ‰è¯»å–çš„è¡ŒåŠ é”ï¼Œå¼ºåˆ¶äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œé¿å…äº†è„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»é—®é¢˜ï¼Œæ€§èƒ½è¾ƒä½ã€‚</li>
</ol>
<h1 id="äºŒé¢-ç¬¬äºŒå¤©æ™šä¸Š"><a href="#äºŒé¢-ç¬¬äºŒå¤©æ™šä¸Š" class="headerlink" title="äºŒé¢(ç¬¬äºŒå¤©æ™šä¸Š)"></a>äºŒé¢(ç¬¬äºŒå¤©æ™šä¸Š)</h1><p>æ‰‹æ’•æ²¡æ’•å‡ºæ¥ï¼Œç­”å¾—ä¸€å¨ï¼Œæ²¡æœºä¼šäº†ï¼ŒæŒ‚äº†</p>
<h2 id="æµç¨‹-1"><a href="#æµç¨‹-1" class="headerlink" title="æµç¨‹"></a>æµç¨‹</h2><ol>
<li>è‡ªæˆ‘ä»‹ç»</li>
<li>golangå’ŒJavaç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜åŠ¿</li>
<li>ä»‹ç»é¡¹ç›®ï¼š<ol>
<li>æ•°æ®åŒæ­¥ï¼Œæ•°æ®æºæœ‰å“ªäº›(ä»ä¸Šæ¸¸æ•°æ®åº“åŒæ­¥åˆ°å…¶ä»–æ•°æ®åº“ï¼Œä½œä¸ºä¸€ä¸ªä¸­é—´ä»¶ï¼ŒåŸç›®æ ‡å’Œç›®çš„éƒ½æ˜¯åœ¨æœåŠ¡å™¨ä¸Šå—ï¼Œåˆ†æ‰¹æŸ¥è¯¢ï¼Œé˜²æ­¢OOM)</li>
<li>å¢é‡åŒæ­¥ï¼šä»¥æ—¥æœŸä¸ºæ›´æ–°æ—¶é—´</li>
<li>MySQLä¸»ä»å»ºè¿è¿æ¥</li>
</ol>
</li>
<li>æ‰‹æ’•ï¼šå­é›†(å†™ä¸å‡ºæ¥ï¼Œæ²¡åŠæ³•å»é‡ï¼Œçƒ‚å®Œäº†)</li>
<li>ä»‹ç»MySQLç´¢å¼•</li>
<li>Linuxå¸¸ç”¨å‘½ä»¤ï¼Œæ–‡ä»¶æè¿°ç¬¦æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</li>
<li>è™šæ‹Ÿå†…å­˜ï¼Œé€»è¾‘åœ°å€ï¼Œç‰©ç†åœ°å€</li>
<li>B+æ ‘å¶å­èŠ‚ç‚¹ä½¿ç”¨é“¾è¡¨è¿æ¥æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</li>
<li>åé—®ï¼š</li>
</ol>
<h3 id="MySQLä¸»ä»åŒæ­¥å»ºç«‹è¿æ¥ï¼Œä»–ä»¬ä¹‹é—´çš„è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Œéœ€è¦å‘é€å“ªäº›æ¶ˆæ¯"><a href="#MySQLä¸»ä»åŒæ­¥å»ºç«‹è¿æ¥ï¼Œä»–ä»¬ä¹‹é—´çš„è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Œéœ€è¦å‘é€å“ªäº›æ¶ˆæ¯" class="headerlink" title="MySQLä¸»ä»åŒæ­¥å»ºç«‹è¿æ¥ï¼Œä»–ä»¬ä¹‹é—´çš„è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Œéœ€è¦å‘é€å“ªäº›æ¶ˆæ¯"></a>MySQLä¸»ä»åŒæ­¥å»ºç«‹è¿æ¥ï¼Œä»–ä»¬ä¹‹é—´çš„è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Œéœ€è¦å‘é€å“ªäº›æ¶ˆæ¯</h3><h3 id="Redisåˆ†å¸ƒå¼é”ä½ æ€ä¹ˆå®ç°çš„ï¼Œæ€ä¹ˆåº”å¯¹æ­»é”ï¼Œ"><a href="#Redisåˆ†å¸ƒå¼é”ä½ æ€ä¹ˆå®ç°çš„ï¼Œæ€ä¹ˆåº”å¯¹æ­»é”ï¼Œ" class="headerlink" title="Redisåˆ†å¸ƒå¼é”ä½ æ€ä¹ˆå®ç°çš„ï¼Œæ€ä¹ˆåº”å¯¹æ­»é”ï¼Œ"></a>Redisåˆ†å¸ƒå¼é”ä½ æ€ä¹ˆå®ç°çš„ï¼Œæ€ä¹ˆåº”å¯¹æ­»é”ï¼Œ</h3><h3 id="B-æ ‘å¶å­èŠ‚ç‚¹ä½¿ç”¨é“¾è¡¨è¿æ¥æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ"><a href="#B-æ ‘å¶å­èŠ‚ç‚¹ä½¿ç”¨é“¾è¡¨è¿æ¥æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ" class="headerlink" title="B+æ ‘å¶å­èŠ‚ç‚¹ä½¿ç”¨é“¾è¡¨è¿æ¥æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ"></a>B+æ ‘å¶å­èŠ‚ç‚¹ä½¿ç”¨é“¾è¡¨è¿æ¥æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</h3><h3 id="ä»‹ç»MySQLç´¢å¼•"><a href="#ä»‹ç»MySQLç´¢å¼•" class="headerlink" title="ä»‹ç»MySQLç´¢å¼•"></a>ä»‹ç»MySQLç´¢å¼•</h3><h3 id="ä¸ºä»€ä¹ˆç›¸åŒIOæ¬¡æ•°ï¼ŒB-æ ‘å¯ä»¥è¯»å–æ›´å¤šæ•°æ®å‘¢ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆç›¸åŒIOæ¬¡æ•°ï¼ŒB-æ ‘å¯ä»¥è¯»å–æ›´å¤šæ•°æ®å‘¢ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆç›¸åŒIOæ¬¡æ•°ï¼ŒB+æ ‘å¯ä»¥è¯»å–æ›´å¤šæ•°æ®å‘¢ï¼Ÿ"></a>ä¸ºä»€ä¹ˆç›¸åŒIOæ¬¡æ•°ï¼ŒB+æ ‘å¯ä»¥è¯»å–æ›´å¤šæ•°æ®å‘¢ï¼Ÿ</h3><h3 id="MySQLç´¢å¼•æ¢æˆHashç´¢å¼•ï¼Œä¼šæœ‰ä»€ä¹ˆä¼˜åŠ¿å‘¢ï¼Ÿ"><a href="#MySQLç´¢å¼•æ¢æˆHashç´¢å¼•ï¼Œä¼šæœ‰ä»€ä¹ˆä¼˜åŠ¿å‘¢ï¼Ÿ" class="headerlink" title="MySQLç´¢å¼•æ¢æˆHashç´¢å¼•ï¼Œä¼šæœ‰ä»€ä¹ˆä¼˜åŠ¿å‘¢ï¼Ÿ"></a>MySQLç´¢å¼•æ¢æˆHashç´¢å¼•ï¼Œä¼šæœ‰ä»€ä¹ˆä¼˜åŠ¿å‘¢ï¼Ÿ</h3><h3 id="5äº¿æ¡æ•°æ®ï¼Œå¦‚ä½•ä¼˜åŒ–"><a href="#5äº¿æ¡æ•°æ®ï¼Œå¦‚ä½•ä¼˜åŒ–" class="headerlink" title="5äº¿æ¡æ•°æ®ï¼Œå¦‚ä½•ä¼˜åŒ–"></a>5äº¿æ¡æ•°æ®ï¼Œå¦‚ä½•ä¼˜åŒ–</h3><p>æˆ‘å›ç­”çš„æ˜¯åˆ†åº“åˆ†è¡¨</p>
<h4 id="åˆ†åº“åˆ†è¡¨å¦‚ä½•åˆ†ï¼Ÿæ ¹æ®ä»€ä¹ˆåˆ†ï¼Ÿ"><a href="#åˆ†åº“åˆ†è¡¨å¦‚ä½•åˆ†ï¼Ÿæ ¹æ®ä»€ä¹ˆåˆ†ï¼Ÿ" class="headerlink" title="åˆ†åº“åˆ†è¡¨å¦‚ä½•åˆ†ï¼Ÿæ ¹æ®ä»€ä¹ˆåˆ†ï¼Ÿ"></a>åˆ†åº“åˆ†è¡¨å¦‚ä½•åˆ†ï¼Ÿæ ¹æ®ä»€ä¹ˆåˆ†ï¼Ÿ</h4><h3 id="å¿«ç…§è¯»å’Œå½“å‰è¯»æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#å¿«ç…§è¯»å’Œå½“å‰è¯»æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="å¿«ç…§è¯»å’Œå½“å‰è¯»æœ‰ä»€ä¹ˆåŒºåˆ«"></a>å¿«ç…§è¯»å’Œå½“å‰è¯»æœ‰ä»€ä¹ˆåŒºåˆ«</h3><h3 id="Linuxå¸¸è§çš„å‘½ä»¤å’Œä»–ä»¬çš„ä½œç”¨"><a href="#Linuxå¸¸è§çš„å‘½ä»¤å’Œä»–ä»¬çš„ä½œç”¨" class="headerlink" title="Linuxå¸¸è§çš„å‘½ä»¤å’Œä»–ä»¬çš„ä½œç”¨"></a>Linuxå¸¸è§çš„å‘½ä»¤å’Œä»–ä»¬çš„ä½œç”¨</h3><h3 id="é€»è¾‘åœ°å€å’Œç‰©ç†åœ°å€æœ‰ä»€ä¹ˆä½œç”¨ï¼Œè™šæ‹Ÿå†…å­˜æ˜¯å¦‚ä½•å®ç°çš„ï¼ŒCPUå¯»å€æ˜¯å¦‚ä½•åšçš„"><a href="#é€»è¾‘åœ°å€å’Œç‰©ç†åœ°å€æœ‰ä»€ä¹ˆä½œç”¨ï¼Œè™šæ‹Ÿå†…å­˜æ˜¯å¦‚ä½•å®ç°çš„ï¼ŒCPUå¯»å€æ˜¯å¦‚ä½•åšçš„" class="headerlink" title="é€»è¾‘åœ°å€å’Œç‰©ç†åœ°å€æœ‰ä»€ä¹ˆä½œç”¨ï¼Œè™šæ‹Ÿå†…å­˜æ˜¯å¦‚ä½•å®ç°çš„ï¼ŒCPUå¯»å€æ˜¯å¦‚ä½•åšçš„"></a>é€»è¾‘åœ°å€å’Œç‰©ç†åœ°å€æœ‰ä»€ä¹ˆä½œç”¨ï¼Œè™šæ‹Ÿå†…å­˜æ˜¯å¦‚ä½•å®ç°çš„ï¼ŒCPUå¯»å€æ˜¯å¦‚ä½•åšçš„</h3><h3 id="æ–‡ä»¶æè¿°ç¬¦æœ‰ä»€ä¹ˆç”¨"><a href="#æ–‡ä»¶æè¿°ç¬¦æœ‰ä»€ä¹ˆç”¨" class="headerlink" title="æ–‡ä»¶æè¿°ç¬¦æœ‰ä»€ä¹ˆç”¨"></a>æ–‡ä»¶æè¿°ç¬¦æœ‰ä»€ä¹ˆç”¨</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zuofw.github.io/2024/10/19/10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QingQiu">
      <meta itemprop="description" content="ä¸ªäººç½‘ç«™ï¼Œå­¦ä¹ è®°å½•ï¼Œé¢è¯•è®°å½•å’Œç»éªŒæ€»ç»“ã€äº’è”ç½‘ä¸­ä¸€å—å±äºè‡ªå·±çš„å°çª">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QingQiu'Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/19/10/" class="post-title-link" itemprop="url">ThreadLocalæŠ€æœ¯åˆ†æä¸é€‰å‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-10-19 15:25:10" itemprop="dateCreated datePublished" datetime="2024-10-19T15:25:10+08:00">2024-10-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">æ·±å…¥ç†è§£ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>4k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¹‹å‰æˆ‘ä»¬åˆ†æäº†ä¸€æ³¢ThreadLocalçš„æºç ï¼Œæˆ‘ä»¬çŸ¥é“ThreadLocaæ˜¯ä¸ºäº†ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹ä¿å­˜ä¸€ä¸ªæœ¬çº¿ç¨‹çš„å˜é‡ï¼Œä½†æ˜¯æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ä¸€äº›å˜é‡ï¼Œæ¯”å¦‚å¼‚æ­¥æ“ä½œå’Œä½¿ç”¨çº¿ç¨‹æ± è¿›è¡Œä»»åŠ¡ç­‰ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æœ‰å“ªäº›å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œå…·ä½“çš„ä½¿ç”¨æ–¹å¼å°±ä¸è´´ä¸Šæ¥äº†ï¼ŒåŸºæœ¬å’ŒThreadLcoalä¸€æ ·çš„ï¼Œè¿™é‡Œé‡ç‚¹åˆ†æä»–ä»¬çš„å®ç°</p>
<h1 id="InheritableThreadLocal"><a href="#InheritableThreadLocal" class="headerlink" title="InheritableThreadLocal"></a>InheritableThreadLocal</h1><p>InheritThreadLocalæ˜¯ThreadLocalçš„ä¸€ä¸ªå­ç±»ï¼Œä»–çš„ä»£ç åŸºæœ¬å°±æ˜¯ä¸€äº›å®šä¹‰ï¼Œå’ŒåŒ…è£…å¥½ä¾›æˆ‘ä»¬ä½¿ç”¨çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†ç»™ThreadLocaä¸­çš„inheritableThreadLocalsè¿›è¡Œèµ‹å€¼ç­‰æ“ä½œã€‚ç²¾é«“è¿˜æ˜¯åœ¨ThreadLocalä¸­<br>é¦–å…ˆå…ˆä¸Šç»“è®ºï¼š<br>InheritableThreadLocalåªèƒ½åœ¨çˆ¶å­çº¿ç¨‹ä¹‹é—´ä¼ é€’å˜é‡ï¼Œè€Œä¸é€‚ç”¨äºçº¿ç¨‹æ± çš„åœºæ™¯ã€‚</p>
<h2 id="æºç è§£è¯»"><a href="#æºç è§£è¯»" class="headerlink" title="æºç è§£è¯»"></a>æºç è§£è¯»</h2><p>é¦–å…ˆçœ‹ä¸€æ®µä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalTest</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">InheritableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">MAIN_THREAD_LOCAL</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InheritableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SneakyThrows</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"threadlocal é»˜è®¤å€¼ï¼š"</span><span class="token operator">+</span><span class="token class-name">ThreadLocalTest</span><span class="token punctuation">.</span><span class="token constant">MAIN_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">MAIN_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"child thread value :"</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"threadlocal è®¾ç½®å­çº¿ç¨‹å€¼ä¹‹åï¼š"</span><span class="token operator">+</span><span class="token class-name">ThreadLocalTest</span><span class="token punctuation">.</span><span class="token constant">MAIN_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">MAIN_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token constant">MAIN_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocalTest</span> threadLocalTest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">MAIN_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"çˆ¶çº¿ç¨‹çš„å€¼ set 111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¯åŠ¨:"</span><span class="token operator">+</span>threadLocalTest<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>threadLocalTest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            ThreadUtil.execAsync(threadLocalTest);</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç»“æŸï¼š"</span><span class="token operator">+</span>threadLocalTest<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ˜¯ä¸€æ®µå¯åŠ¨å­çº¿ç¨‹çš„ä»£ç ï¼Œæˆ‘ä»¬é¡ºç€ new Threadè¿›å»Threadä¸­æ¥åˆ°è¿™æ®µä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">ThreadGroup</span> g<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> target<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span>
                     <span class="token keyword">long</span> stackSize<span class="token punctuation">,</span> <span class="token class-name">AccessControlContext</span> acc<span class="token punctuation">,</span>
                     <span class="token keyword">boolean</span> inheritThreadLocals<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>é‚£ä¹ˆæˆ‘ä»¬å°±å»æ‰¾inheritThreadLocalsè¿™ä¸ªå˜é‡ï¼Œæœ€ååœ¨400å¤šè¡Œçš„ä¸€ä¸ªå‡½æ•°ä¸­æ‰¾åˆ°äº†è¿™ä¸ªå˜é‡çš„ä½ç½®(å…·ä½“ä½ç½®æ¯ä¸ªç‰ˆæœ¬çš„è¡Œæ•°ä¸ä¸€æ ·ï¼Œç›´æ¥æœç´¢inheritThreadLocalså°±è¡Œäº†)<img src="/2024/10/19/10/itl1.png"><br>ä»–ä¼šä½¿ç”¨ThreadLocal.createInheriteaMapå»è¿›è¡Œèµ‹å€¼ï¼Œæˆ‘ä»¬å°±å»çœ‹è¿™ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•åšçš„</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token class-name">ThreadLocalMap</span> <span class="token function">createInheritedMap</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalMap</span> parentMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span>parentMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>æ¥ç€è¿›å»çœ‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalMap</span> parentMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parentTable <span class="token operator">=</span> parentMap<span class="token punctuation">.</span>table<span class="token punctuation">;</span>
           <span class="token keyword">int</span> len <span class="token operator">=</span> parentTable<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
           <span class="token function">setThreshold</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
           table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>

           <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> e <span class="token operator">:</span> parentTable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
                   <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       <span class="token class-name">Object</span> value <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">childValue</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token class-name">Entry</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token keyword">int</span> h <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token keyword">while</span> <span class="token punctuation">(</span>table<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                           h <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                       table<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
                       size<span class="token operator">++</span><span class="token punctuation">;</span>
                   <span class="token punctuation">}</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å…¶å®ä¸€ç›®äº†ç„¶äº†ï¼ŒåŸæ¥å°±æ˜¯æ–°å»ºäº†ä¸€ä¸ªThreadLocalMapï¼Œç„¶åå°†ä¼ è¿›æ¥çš„çˆ¶ThreadLocalMapä¸­çš„å†…å®¹ä¸€ä¸ªä¸€ä¸ªå¤åˆ¶è¿‡å»ã€‚ã€‚ã€‚å¯ä»¥çœ‹å‡ºï¼Œå®é™…ä¸Šé«˜å¤§ä¸Šçš„æŠ€æœ¯å…¶å®å¾€å¾€éƒ½æ˜¯å¾ˆç®€å•çš„å®ç°ï¼Œæ‰€ä»¥æºç è¯¥çœ‹çš„è¿˜æ˜¯å¾—çœ‹ã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆçº¿ç¨‹æ± ä¸­æ— æ³•å…±äº«"><a href="#ä¸ºä»€ä¹ˆçº¿ç¨‹æ± ä¸­æ— æ³•å…±äº«" class="headerlink" title="ä¸ºä»€ä¹ˆçº¿ç¨‹æ± ä¸­æ— æ³•å…±äº«"></a>ä¸ºä»€ä¹ˆçº¿ç¨‹æ± ä¸­æ— æ³•å…±äº«</h2><p>é€šè¿‡ä¹‹å‰æˆ‘ä»¬å¯¹çº¿ç¨‹æ± æºç çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œçº¿ç¨‹æ± ä¹Ÿä½¿ç”¨çš„new Threadåˆ›å»ºå­çº¿ç¨‹çš„ï¼Œä¹Ÿå°±æ˜¯ï¼Œå®é™…ä¸Šç»™æ˜¯å¯ä»¥å®ç°çº¿ç¨‹æ± ä¹‹é—´çš„å…±äº«çš„ï¼Œä½†æ˜¯é—®é¢˜æ˜¯ï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯é‡ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ²¡åŠæ³•ç¡®è®¤å“ªå‡ ä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«äº†å“ªä¸ªInheritedLocal</p>
<h1 id="TransmittableThreadLocal"><a href="#TransmittableThreadLocal" class="headerlink" title="TransmittableThreadLocal"></a>TransmittableThreadLocal</h1><p>è¿™ä¸ªæ˜¯æ¥è‡ªé˜¿é‡Œå·´å·´å¼€æºçš„ä¸€ä¸ªåº“ä¸­çš„ç±»ï¼Œç®€ç§°TTLï¼Œè¿™ä¸ªæ˜¯å¯ä»¥æ»¡è¶³çº¿ç¨‹æ± ä¹‹é—´ä¼ é€’å˜é‡çš„ã€‚<br>å…ˆç»™å‡ºä½¿ç”¨å®ä¾‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginUserContextHolder</span> <span class="token punctuation">{</span>

    <span class="token comment">// åˆå§‹åŒ–ä¸€ä¸ª ThreadLocal å˜é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token constant">LOGIN_USER_CONTEXT_THREAD_LOCAL</span>
            <span class="token operator">=</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * è®¾ç½®ç”¨æˆ· ID
     *
     * @param value
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">LOGIN_USER_CONTEXT_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">GlobalConstants</span><span class="token punctuation">.</span><span class="token constant">USER_ID</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * è·å–ç”¨æˆ· ID
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Long</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token constant">LOGIN_USER_CONTEXT_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">GlobalConstants</span><span class="token punctuation">.</span><span class="token constant">USER_ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å­çº¿ç¨‹è·å–åˆ°çš„ç”¨æˆ·IDï¼š"</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * åˆ é™¤ ThreadLocal
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">LOGIN_USER_CONTEXT_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>é¦–å…ˆçœ‹å®šä¹‰<img src="/2024/10/19/10/ttl1.png"><br>å¯ä»¥çœ‹å‡ºTTLæ˜¯InheritableThreadLocalçš„å­ç±»ï¼Œè¿›è¡Œäº†ä¸€äº›è¡¥å……ã€‚<br>æˆ‘ä»¬å»çœ‹ä¸Šé¢ç¤ºä¾‹ä¸­çš„withInitialæ–¹æ³•<img src="/2024/10/19/10/ttl2.png"><br>æ’ä¸ªé¢˜å¤–è¯ï¼Œæˆ‘ä»¬å…ˆå…³æ³¨ä¸€ä¸‹è¿™ä¸ªSupplierï¼š</p>
<blockquote>
<p>Supplier æ¥å£åœ¨ Java ä¸­çš„ä½œç”¨æ˜¯æä¾›ä¸€ä¸ªç»“æœçš„ä¾›åº”è€…ã€‚å®ƒæ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œæ„å‘³ç€å®ƒå¯ä»¥ç”¨ä½œ lambda è¡¨è¾¾å¼æˆ–æ–¹æ³•å¼•ç”¨çš„ç›®æ ‡ã€‚å‡½æ•°å¼æ¥å£çš„æ„ä¹‰åœ¨äºå®ƒä»¬ä½¿ä»£ç æ›´åŠ ç®€æ´å’Œå¯è¯»ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨ Java 8 å¼•å…¥çš„æµå¼ API æ—¶</p>
</blockquote>
<p>æºä»£ç æ¯”è¾ƒé•¿ï¼Œ<del>(æœ‰ç‚¹æ‡’å¾—å†™)</del> å¯ä»¥çœ‹è¿™ä½<a target="_blank" rel="noopener" href="https://www.cnblogs.com/intotw/p/14740215.html">å¤§ä½¬çš„åˆ†æ</a>ï¼Œè¿™é‡Œå°±åšä¸€äº›ç®€å•çš„æ€»ç»“ ï¼š</p>
<ol>
<li>å®šä¹‰äº†ä¸€ä¸ªé™æ€å˜é‡ï¼šholder(InheritableThreadLocalæ¥å­˜å‚¨WeakHashMapï¼Œçˆ¶å­çº¿ç¨‹å…±äº«)ï¼Œè´Ÿè´£ä¿å­˜æ‰€æœ‰çš„TTLç¤ºä¾‹</li>
<li>getã€setã€removeæ–¹æ³•ä¼šå°†å½“å‰å®ä¾‹ä»holderä¸­æ·»åŠ æˆ–è€…ç§»é™¤</li>
<li>withInitial å’Œ withInitialAndCopieræä¾›ç”¨äºåˆ›å»ºå…·æœ‰åˆå§‹å€¼å’Œå¤åˆ¶å™¨çš„TTLå˜é‡</li>
<li>æ ¸å¿ƒ Transmitter å†…éƒ¨ç±»æä¾›äº† capture(å°†å½“å‰çº¿ç¨‹ä¸­çš„holderé‡Œçš„TTLæ•è·å‡ºæ¥è®¾ç½®åˆ°HashMapä¸­ï¼‰ã€replay(å°†æ•è·çš„HashMapè®¾ç½®åˆ°æ–°çº¿ç¨‹çš„TTLå®ä¾‹ä¸­)ã€clear å’Œ restore(å°†ä¹‹å‰æ•è·çš„HashMapæ¢å¤åˆ°å½“å‰çº¿ç¨‹çš„TTLä¸­) æ–¹æ³•ï¼Œç”¨äºæ•è·å’Œæ¢å¤çº¿ç¨‹æœ¬åœ°å˜é‡çš„å€¼ã€‚</li>
</ol>
<p>TTLåšçš„å®é™…ä¸Šå°±æ˜¯å°†åŸæœ¬ä¸Threadç»‘å®šçš„çº¿ç¨‹å˜é‡ï¼Œç¼“å­˜ä¸€ä»½åˆ°TtlRunnableå¯¹è±¡ä¸­ï¼Œåœ¨æ‰§è¡Œå­çº¿ç¨‹ä»»åŠ¡å‰ï¼Œå°†å¯¹è±¡ä¸­ç¼“å­˜çš„å˜é‡å€¼è®¾ç½®åˆ°å­çº¿ç¨‹çš„ThreadLocalä¸­ä»¥ä¾›run()æ–¹æ³•çš„ä»£ç ä½¿ç”¨ï¼Œç„¶åæ‰§è¡Œå®Œåï¼Œåˆæ¢å¤ç°åœºï¼Œä¿è¯ä¸ä¼šå¯¹å¤ç”¨çº¿ç¨‹äº§ç”Ÿå½±å“ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zuofw.github.io/2024/10/11/36/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QingQiu">
      <meta itemprop="description" content="ä¸ªäººç½‘ç«™ï¼Œå­¦ä¹ è®°å½•ï¼Œé¢è¯•è®°å½•å’Œç»éªŒæ€»ç»“ã€äº’è”ç½‘ä¸­ä¸€å—å±äºè‡ªå·±çš„å°çª">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QingQiu'Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/11/36/" class="post-title-link" itemprop="url">ç¾äº‘æ™ºæ•°ä¸€é¢</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-10-11 20:52:36" itemprop="dateCreated datePublished" datetime="2024-10-11T20:52:36+08:00">2024-10-11</time>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>1.9k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><del>ç¢ç¢å¿µæ²¡å¿…è¦çœ‹</del><br>å…¬å¸é¢è¯•æŒºæ°´çš„ï¼Œåªæœ‰ä¸€é¢ï¼Œæ˜¯ç¾çš„çš„å­å…¬å¸ï¼Œæˆ‘ä¹Ÿä¸æ¸…æ¥šåˆ°åº•èƒ½ä¸èƒ½å­¦åˆ°ä¸œè¥¿ï¼Œä½†æ˜¯å¯¹æˆ‘è¿™ç§åºŸç‰©æ¥è¯´ï¼Œç¾çš„è¿™ä¸ªç‰Œå­å°±è¶³å¤Ÿæˆ‘å»æ¢æ¢æ·±æµ…äº†ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©äº†å»å®ä¹ å‡ ä¸ªæœˆã€‚<br>æœ€å¼€å§‹æ˜¯ä¸æƒ³å»çš„ï¼Œå› ä¸ºå­å…¬å¸ç»ˆç©¶ä¸æ˜¯ç¾çš„ï¼Œè€Œä¸”ç¾çš„ä¹Ÿä¸æ˜¯äº’è”ç½‘å‚ï¼Œæ‰€ä»¥å¯èƒ½è®¤å¯åº¦ä¸æ˜¯å¾ˆé«˜ï¼Œä½†æ˜¯æœ€è¿‘æ‹›å®ä¹ æœ‰éš¾å›°éš¾ï¼ŒåŒæ—¶æˆ‘ä¹Ÿæ„Ÿè§‰è‡ªå·±çš„æ°´å¹³å¯èƒ½ä¸å¤Ÿå»å¤§å‚çš„ï¼Œè€Œä¸”ä¸Šä¸€æ®µå®ä¹ è¿˜è¢«è«åå…¶å¦™çš„å¼€äº†ï¼Œæ²¡å­¦åˆ°å¤šå°‘ä¸œè¥¿ï¼Œæ‰€ä»¥æˆ‘åªèƒ½éª‘é©´æ‰¾é©¬äº†ã€‚<br>ä¸è¿‡ï¼Œhrè¿˜æœ‰é¢è¯•å®˜éƒ½å¾ˆå¥½ï¼Œé¢è¯•å®˜ä¹Ÿä¸ä¸¥å‰ï¼Œè™½ç„¶æ²¡å¼€æ‘„åƒå¤´ï¼Œä½†æ˜¯é¢èµ·æ¥å¾ˆèˆ’æœï¼Œç„¶åé¢è¯•å®˜æ„Ÿè§‰å°±åƒæ˜¯è·ŸåŒé¾„äººèŠå¤©ä¸€æ ·ï¼Œå¾ˆå¯çˆ±çš„å°å§å§ğŸ˜ƒï¼Œä»–ä»¬ä¿©æ˜¯æˆ‘å»ç¾äº‘çš„é‡è¦å› ç´ å§ã€‚<br><del>è®¸æ„¿æ˜å¹´èƒ½æ‰¾åˆ°å¤§å‚çš„è½¬æ­£å®ä¹ å§ï¼Œç„¶åå†è½¬æ­£ä¸€ç•ªï¼Œå”‰ï¼ŒåŒé + å†œæ‘å‡ºèº«ï¼Œæˆ‘å·²ç»å°½åŠ›äº†ã€‚</del></p>
<p>æµç¨‹å•¥çš„å°±ä¸è¯´äº†ï¼Œç»å…¸ä»‹ç» + å…«è‚¡é¡¹ç›®æ‹·é—® + åé—®ï¼Œæ²¡æœ‰ç®—æ³•ã€‚é¡ºä¾¿è¢«å¤¸å¥–äº†ç»éªŒæŒºä¸°å¯Œçš„hhh</p>
<h1 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h1><h2 id="IOCå’ŒAOPçš„åŒºåˆ«"><a href="#IOCå’ŒAOPçš„åŒºåˆ«" class="headerlink" title="IOCå’ŒAOPçš„åŒºåˆ«"></a>IOCå’ŒAOPçš„åŒºåˆ«</h2><p>è¿™ä¸ªé—®é¢˜æ„Ÿè§‰æœ‰ç‚¹æŠ½è±¡ã€‚ã€‚ã€‚æ„Ÿè§‰ä»–ä»¬æ²¡å•¥å…³ç³»ï¼Œç¡¬è¦è¯´çš„è¯ä¹Ÿæ˜¯AOPæ˜¯åœ¨Springæ¡†æ¶çš„åŸºç¡€ä¸Šå®ç°çš„ï¼Œè€ŒSpringçš„æ ¸å¿ƒå°±æ˜¯IOC<br>å›ç­”å°±æ˜¯ç»å…¸çš„IOC + DIå’å”±ï¼ŒAOPçš„å’å”±ï¼šåˆ‡ç‚¹ï¼Œé€šçŸ¥ï¼Œé¡ºä¾¿è¯´äº†ä¸€ä¸‹AOPå¦‚ä½•å®ç°çš„ï¼Œç®€å•æ¥è¯´å°±æ˜¯JDKåŠ¨æ€ä»£ç†å’ŒCGLIBï¼Œè¿˜æœ‰å’Œé™æ€ä»£ç†çš„åŒºåˆ«ã€‚</p>
<h2 id="é›†åˆå’Œé“¾è¡¨é‡Œå“ªäº›æ˜¯æœ‰åºçš„ï¼Œå“ªäº›æ˜¯æ— åºçš„"><a href="#é›†åˆå’Œé“¾è¡¨é‡Œå“ªäº›æ˜¯æœ‰åºçš„ï¼Œå“ªäº›æ˜¯æ— åºçš„" class="headerlink" title="é›†åˆå’Œé“¾è¡¨é‡Œå“ªäº›æ˜¯æœ‰åºçš„ï¼Œå“ªäº›æ˜¯æ— åºçš„"></a>é›†åˆå’Œé“¾è¡¨é‡Œå“ªäº›æ˜¯æœ‰åºçš„ï¼Œå“ªäº›æ˜¯æ— åºçš„</h2><p>æŠ½è±¡é—®é¢˜ï¼Œæˆ‘ä»¥ä¸ºæ˜¯é—®çš„TreeSetï¼ŒPriorityQueueè¿™ç§ã€‚ã€‚ã€‚<br>ä¸‹é¢éšä¾¿æŒ‘å‡ ä¸ªè®²è®²å°±è¡Œäº†<br>æœ‰åºï¼š</p>
<ol>
<li>ArrayListã€LinkedListã€Vectorã€Stack</li>
<li>TreeSet</li>
<li>PriorityQueueã€åŒå‘é˜Ÿåˆ—Deque<br>æ— åºï¼š</li>
<li>HashSetã€LinkedHashSet</li>
<li>HashMapã€‚ã€‚ã€‚ã€‚<br>æ€»ç»“ï¼š<br>æœ‰åºï¼šlistï¼Œé“¾è¡¨ï¼Œé˜Ÿåˆ—ï¼Œæ ˆï¼Œtreeset,<br>æ— åºï¼šseté™¤äº†treesetï¼Œmapé™¤äº†LinkedHashMap</li>
</ol>
<h2 id="æœ‰ç”¨åˆ°ä»€ä¹ˆè®¾è®¡æ¨¡å¼å—"><a href="#æœ‰ç”¨åˆ°ä»€ä¹ˆè®¾è®¡æ¨¡å¼å—" class="headerlink" title="æœ‰ç”¨åˆ°ä»€ä¹ˆè®¾è®¡æ¨¡å¼å—"></a>æœ‰ç”¨åˆ°ä»€ä¹ˆè®¾è®¡æ¨¡å¼å—</h2><p>æˆ‘ç”¨åˆ°è¿‡<br>æ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€å·¥å‚æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼ã€‚ã€‚å¿˜äº†ï¼Œè‡ªå·±ç»“åˆé¡¹ç›®å›ç­”å§ã€‚</p>
<h2 id="æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³"><a href="#æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³"></a>æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³</h2><p>#todo </p>
<ul>
<li><input disabled="" type="checkbox"> è¿™ä¸ªå…«è‚¡å‡†å¤‡çš„ä¸å……åˆ†ï¼Œè¦ä½¿åŠ²å­¦å­¦</li>
</ul>
<h3 id="Kafkaå’ŒRocketMQåˆ†åˆ«é€‚åˆå“ªäº›åœºæ™¯"><a href="#Kafkaå’ŒRocketMQåˆ†åˆ«é€‚åˆå“ªäº›åœºæ™¯" class="headerlink" title="Kafkaå’ŒRocketMQåˆ†åˆ«é€‚åˆå“ªäº›åœºæ™¯"></a>Kafkaå’ŒRocketMQåˆ†åˆ«é€‚åˆå“ªäº›åœºæ™¯</h3><h3 id="æœ‰ç”¨è¿‡åˆ†åŒºé¡ºåºæ¶ˆæ¯å—"><a href="#æœ‰ç”¨è¿‡åˆ†åŒºé¡ºåºæ¶ˆæ¯å—" class="headerlink" title="æœ‰ç”¨è¿‡åˆ†åŒºé¡ºåºæ¶ˆæ¯å—"></a>æœ‰ç”¨è¿‡åˆ†åŒºé¡ºåºæ¶ˆæ¯å—</h3><h3 id="æœ‰äº†è§£è¿‡RocketMQçš„æ¶ˆæ¯å¤§å°é™åˆ¶å—"><a href="#æœ‰äº†è§£è¿‡RocketMQçš„æ¶ˆæ¯å¤§å°é™åˆ¶å—" class="headerlink" title="æœ‰äº†è§£è¿‡RocketMQçš„æ¶ˆæ¯å¤§å°é™åˆ¶å—"></a>æœ‰äº†è§£è¿‡RocketMQçš„æ¶ˆæ¯å¤§å°é™åˆ¶å—</h3><h2 id="ç®€å•ä»‹ç»ä¸€ä¸‹RBACçš„åŸç†"><a href="#ç®€å•ä»‹ç»ä¸€ä¸‹RBACçš„åŸç†" class="headerlink" title="ç®€å•ä»‹ç»ä¸€ä¸‹RBACçš„åŸç†"></a>ç®€å•ä»‹ç»ä¸€ä¸‹RBACçš„åŸç†</h2><p>ç›´æ¥çœ‹JavaGuideçš„åŸç†å°±è¡Œï¼Œæ²¡éš¾åº¦</p>
<h2 id="è‡ªå®šä¹‰ä»»åŠ¡å¼•æ“"><a href="#è‡ªå®šä¹‰ä»»åŠ¡å¼•æ“" class="headerlink" title="è‡ªå®šä¹‰ä»»åŠ¡å¼•æ“"></a>è‡ªå®šä¹‰ä»»åŠ¡å¼•æ“</h2><p>#todo </p>
<ul>
<li><input disabled="" type="checkbox"> å­¦å­¦ XXL-JOB<br>ä¸ºä»€ä¹ˆä½¿ç”¨äº†Quartzè€Œä¸æ˜¯XXL-JOB<br>å› ä¸ºå…¬å¸çš„é™ˆå¹´è€é¡¹ç›®</li>
</ul>
<h2 id="æœ‰å¤šçº¿ç¨‹çš„ç»å†å—ï¼Œç®€å•ä¸¾ä¾‹æœ‰å“ªå‡ ç§çº¿ç¨‹æ± "><a href="#æœ‰å¤šçº¿ç¨‹çš„ç»å†å—ï¼Œç®€å•ä¸¾ä¾‹æœ‰å“ªå‡ ç§çº¿ç¨‹æ± " class="headerlink" title="æœ‰å¤šçº¿ç¨‹çš„ç»å†å—ï¼Œç®€å•ä¸¾ä¾‹æœ‰å“ªå‡ ç§çº¿ç¨‹æ± "></a>æœ‰å¤šçº¿ç¨‹çš„ç»å†å—ï¼Œç®€å•ä¸¾ä¾‹æœ‰å“ªå‡ ç§çº¿ç¨‹æ± </h2><p>å›ç­”ï¼šæœ‰çœ‹è¿‡çº¿ç¨‹æ± çš„çš„æºç ï¼Œç„¶åçº¿ç¨‹æ± å…«è‚¡ï¼Œé¡ºä¾¿ç©¿æ’äº†ä¸€äº›æºç é‡Œçš„ä¸œè¥¿ã€‚</p>
<h2 id="ForkJoinPoolé€‚åˆå“ªäº›åœºæ™¯"><a href="#ForkJoinPoolé€‚åˆå“ªäº›åœºæ™¯" class="headerlink" title="ForkJoinPoolé€‚åˆå“ªäº›åœºæ™¯"></a>ForkJoinPoolé€‚åˆå“ªäº›åœºæ™¯</h2><ol>
<li>é€’å½’ä»»åŠ¡ï¼šä»»åŠ¡å¯åˆ†ï¼Œå¯å¹¶è¡Œå¤„ç†ï¼Œä¾‹å¦‚é€’å½’å’Œåˆ†æ”¯</li>
<li>å¤§è§„æ¨¡çš„æ•°æ®å¤„ç†ï¼šå½“éœ€è¦å¤„ç†å¤§é‡æ•°æ®å’Œæ•°æ®åˆ†å—æ—¶</li>
<li>CPUå¯†é›†å‹ä»»åŠ¡ï¼šé€‚åˆå¤§é‡è®¡ç®—çš„åœºæ™¯ï¼Œèƒ½å¤Ÿåˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„ä¼˜åŠ¿</li>
<li>ä»»åŠ¡ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼šä»»åŠ¡ä¹‹é—´æ²¡æœ‰å¤ªå¤šä¾èµ–å…³ç³»ï¼Œå¯ä»¥ç‹¬ç«‹æ‰§è¡Œæ—¶ï¼Œä½¿ç”¨ForkJoinPoolå¯ä»¥æœ€å¤§åŒ–å¹¶è¡Œåº¦å‡å°‘ä»»åŠ¡ä¹‹é—´çš„ç­‰å¾…æ—¶é—´</li>
</ol>
<p>#todo </p>
<ul>
<li><input disabled="" type="checkbox"> forkJoinçš„æºç å’ŒparralelStreamçš„åŸç†çœ‹çœ‹<br>ç®€å•è®²è§£ä¸€ä¸‹ï¼Œé¡ºä¾¿è¯´ParallelStreamçš„åº•å±‚å°±æ˜¯ForkJoin</li>
</ul>
<h2 id="å¹¶è¡Œæµæœ‰ä»€ä¹ˆç¼ºç‚¹"><a href="#å¹¶è¡Œæµæœ‰ä»€ä¹ˆç¼ºç‚¹" class="headerlink" title="å¹¶è¡Œæµæœ‰ä»€ä¹ˆç¼ºç‚¹"></a>å¹¶è¡Œæµæœ‰ä»€ä¹ˆç¼ºç‚¹</h2><ol>
<li>çº¿ç¨‹å¼€é”€ï¼šåº•å±‚æ˜¯ä½¿ç”¨ForkJoinPoolæ¥ç®¡ç†çº¿ç¨‹çš„ï¼Œéœ€è¦åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹ï¼Œä»»åŠ¡æ•°é‡è¾ƒå°‘æ—¶ä¼šå½±å“æ€§èƒ½</li>
<li>çº¿ç¨‹å®‰å…¨ï¼šå¦‚æœæ“ä½œä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„å¯èƒ½ä¼šå¯¼è‡´</li>
<li>éç¡®å®šæ€§ï¼šæ‰§è¡Œé¡ºåºä¸ç¡®å®šï¼Œæ‰€ä»¥æ¯æ¬¡æ‰§è¡Œçš„ç»“æœå¯èƒ½ä¸åŒ</li>
<li>èµ„æºç«äº‰ï¼šä¼šä½¿ç”¨å…±äº«çš„ForkJoinPoolï¼Œå¦‚æœåˆ«çš„ä»»åŠ¡ä¹Ÿä½¿ç”¨è¿™ä¸ªå¹¶è¡Œæµï¼Œé‚£ä¹ˆä¼šå‡ºå¸­é‚£èµ„æºç«äº‰ï¼ŒåŒæ—¶ä½¿ç”¨çš„</li>
<li>è°ƒè¯•å›°éš¾ï¼š</li>
<li>ä¸é€‚åˆå¼ºä¾èµ–æ€§çš„ä»»åŠ¡</li>
</ol>
<h2 id="RPCç›¸å…³"><a href="#RPCç›¸å…³" class="headerlink" title="RPCç›¸å…³"></a>RPCç›¸å…³</h2><h3 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h3><ol>
<li>æ³¨å†Œä¸­å¿ƒ</li>
<li>æœåŠ¡æä¾›è€…</li>
<li>æœåŠ¡æ¶ˆè´¹è€…</li>
<li>å‰©ä¸‹çš„å°±æ˜¯å…¶ä»–ä¸œè¥¿ï¼ŒSPIä¹‹ç±»çš„</li>
</ol>
<h3 id="æœ‰å‚è€ƒè¿‡dubboå’Œå…¶ä»–å—"><a href="#æœ‰å‚è€ƒè¿‡dubboå’Œå…¶ä»–å—" class="headerlink" title="æœ‰å‚è€ƒè¿‡dubboå’Œå…¶ä»–å—"></a>æœ‰å‚è€ƒè¿‡dubboå’Œå…¶ä»–å—</h3><p>æœ‰</p>
<h3 id="æœ‰å¤„ç†é™æµå—"><a href="#æœ‰å¤„ç†é™æµå—" class="headerlink" title="æœ‰å¤„ç†é™æµå—"></a>æœ‰å¤„ç†é™æµå—</h3><p>è¿˜æ²¡å®ç°</p>
<h3 id="æœ‰å“ªäº›å®ç°çš„æ³¨å†Œä¸­å¿ƒ"><a href="#æœ‰å“ªäº›å®ç°çš„æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="æœ‰å“ªäº›å®ç°çš„æ³¨å†Œä¸­å¿ƒ"></a>æœ‰å“ªäº›å®ç°çš„æ³¨å†Œä¸­å¿ƒ</h3><p>ç›®å‰åªå®ç°äº†zookeeperï¼Œä½†æ˜¯å®Œå…¨å¯ä»¥ä½¿ç”¨nacosæ¥å®ç°ï¼ŒåŒæ—¶çœ‹è§ä¸€ä¸ªä½¿ç”¨äº†etcdæ¥å®ç°çš„ï¼Œä½†æ˜¯æ—¶é—´å…³ç³»ï¼Œå°±æ²¡å®ç°</p>
<h3 id="å·¥å…·æœ‰è½åœ°åˆ°å“ªä¸ªé¡¹ç›®å—"><a href="#å·¥å…·æœ‰è½åœ°åˆ°å“ªä¸ªé¡¹ç›®å—" class="headerlink" title="å·¥å…·æœ‰è½åœ°åˆ°å“ªä¸ªé¡¹ç›®å—"></a>å·¥å…·æœ‰è½åœ°åˆ°å“ªä¸ªé¡¹ç›®å—</h3><p>ç›®å‰åœ¨å†™ä¸€ä¸ªå¾®æœåŠ¡é¡¹ç›®ï¼Œåç»­å¯èƒ½ä¼šä½¿ç”¨ä»–æ¥æ›¿æ¢æ‰OpenFeign</p>
<h2 id="Tokenè¿‡æœŸå¦‚ä½•å¤„ç†çš„"><a href="#Tokenè¿‡æœŸå¦‚ä½•å¤„ç†çš„" class="headerlink" title="Tokenè¿‡æœŸå¦‚ä½•å¤„ç†çš„"></a>Tokenè¿‡æœŸå¦‚ä½•å¤„ç†çš„</h2><p>ä½¿ç”¨Redisçš„è‡ªåŠ¨è¿‡æœŸã€‚ã€‚ã€‚<br>æ¯æ¬¡è®¿é—®ç»­å†™ä¸€æ¬¡ï¼Œé€€å‡ºç™»å½•åˆ é™¤token</p>
<h2 id="Redisé›†ç¾¤å’Œå“¨å…µçš„åŒºåˆ«"><a href="#Redisé›†ç¾¤å’Œå“¨å…µçš„åŒºåˆ«" class="headerlink" title="Redisé›†ç¾¤å’Œå“¨å…µçš„åŒºåˆ«"></a>Redisé›†ç¾¤å’Œå“¨å…µçš„åŒºåˆ«</h2><p>é›†ç¾¤æ˜¯æ•°æ®åˆ†ç‰‡ï¼Œç›®çš„æ˜¯é«˜å¯ç”¨æ€§<br>å“¨å…µæ˜¯ç›‘æ§ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ï¼Œä¸å­˜å‚¨æ•°æ®ï¼Œæ•…éšœè½¬ç§»æ—¶å‘èµ·æŠ•ç¥¨ä¹‹ç±»çš„</p>
<h2 id="å¤§æ¨¡å‹çš„APIè°ƒç”¨äº†å“ªäº›"><a href="#å¤§æ¨¡å‹çš„APIè°ƒç”¨äº†å“ªäº›" class="headerlink" title="å¤§æ¨¡å‹çš„APIè°ƒç”¨äº†å“ªäº›"></a>å¤§æ¨¡å‹çš„APIè°ƒç”¨äº†å“ªäº›</h2><p>ç­”ï¼šè°ƒç”¨äº†å›¾ç‰‡è¯†åˆ«ç›¸å…³çš„</p>
<h2 id="ä½¿ç”¨çš„ä»€ä¹ˆè¿›è¡Œé¡¹ç›®ç®¡ç†"><a href="#ä½¿ç”¨çš„ä»€ä¹ˆè¿›è¡Œé¡¹ç›®ç®¡ç†" class="headerlink" title="ä½¿ç”¨çš„ä»€ä¹ˆè¿›è¡Œé¡¹ç›®ç®¡ç†"></a>ä½¿ç”¨çš„ä»€ä¹ˆè¿›è¡Œé¡¹ç›®ç®¡ç†</h2><p>gitea</p>
<h2 id="git-rebaseå‘½ä»¤äº†è§£å—"><a href="#git-rebaseå‘½ä»¤äº†è§£å—" class="headerlink" title="git rebaseå‘½ä»¤äº†è§£å—"></a>git rebaseå‘½ä»¤äº†è§£å—</h2><h2 id="æ‰“åŒ…ç›¸å…³"><a href="#æ‰“åŒ…ç›¸å…³" class="headerlink" title="æ‰“åŒ…ç›¸å…³"></a>æ‰“åŒ…ç›¸å…³</h2><p>docker-composeï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰ä½¿ç”¨Jenkinsä¹‹ç±»çš„ã€‚ã€‚æœåŠ¡å™¨å¤ªçƒ‚äº†</p>
<h2 id="é—®è¯¾ç»“æŸäº†å—ï¼Œæ¯•ä¸šè®ºæ–‡å•¥æ—¶å€™å¼€å§‹ï¼Œç›®å‰åœ¨å“ªï¼Œä½•æ—¶è¿‡æ¥"><a href="#é—®è¯¾ç»“æŸäº†å—ï¼Œæ¯•ä¸šè®ºæ–‡å•¥æ—¶å€™å¼€å§‹ï¼Œç›®å‰åœ¨å“ªï¼Œä½•æ—¶è¿‡æ¥" class="headerlink" title="é—®è¯¾ç»“æŸäº†å—ï¼Œæ¯•ä¸šè®ºæ–‡å•¥æ—¶å€™å¼€å§‹ï¼Œç›®å‰åœ¨å“ªï¼Œä½•æ—¶è¿‡æ¥"></a>é—®è¯¾ç»“æŸäº†å—ï¼Œæ¯•ä¸šè®ºæ–‡å•¥æ—¶å€™å¼€å§‹ï¼Œç›®å‰åœ¨å“ªï¼Œä½•æ—¶è¿‡æ¥</h2><p>è€é—®é¢˜äº†ï¼Œç›´æ¥ ç»“æŸäº†ï¼Œå¤§å››ï¼Œåœ¨å­¦æ ¡ï¼Œé©¬ä¸Šè¿‡æ¥</p>
<h2 id="åé—®ï¼š"><a href="#åé—®ï¼š" class="headerlink" title="åé—®ï¼š"></a>åé—®ï¼š</h2><ol>
<li>æ˜¯é©»åœºå—ï¼Œæ˜¯å¤–åŒ…å—</li>
<li>ä¸šåŠ¡ç›¸å…³</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zuofw.github.io/2024/10/04/15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QingQiu">
      <meta itemprop="description" content="ä¸ªäººç½‘ç«™ï¼Œå­¦ä¹ è®°å½•ï¼Œé¢è¯•è®°å½•å’Œç»éªŒæ€»ç»“ã€äº’è”ç½‘ä¸­ä¸€å—å±äºè‡ªå·±çš„å°çª">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QingQiu'Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/04/15/" class="post-title-link" itemprop="url">å¾®æœåŠ¡åŠ å¯†æ¢è®¨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-10-04 10:38:15" itemprop="dateCreated datePublished" datetime="2024-10-04T10:38:15+08:00">2024-10-04</time>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>0</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zuofw.github.io/2024/10/01/34/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QingQiu">
      <meta itemprop="description" content="ä¸ªäººç½‘ç«™ï¼Œå­¦ä¹ è®°å½•ï¼Œé¢è¯•è®°å½•å’Œç»éªŒæ€»ç»“ã€äº’è”ç½‘ä¸­ä¸€å—å±äºè‡ªå·±çš„å°çª">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QingQiu'Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/01/34/" class="post-title-link" itemprop="url">Nettyæºç åˆæ¢</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-10-01 17:44:34" itemprop="dateCreated datePublished" datetime="2024-10-01T17:44:34+08:00">2024-10-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">æ·±å…¥ç†è§£ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>14k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ¬äººåœ¨å°è¯•ä½¿ç”¨Nettyæ¥æ‰‹å†™RPCæ—¶ï¼Œå­¦ä¹ åˆ°äº†å¾ˆå¤šNettyçŸ¥è¯†ï¼Œåœ¨æ­¤è¿›è¡Œä¸€äº›è®°å½•</p>
<h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><p>ä»¥ä¸‹æ—¶æœåŠ¡ç«¯çš„ç®€å•å¯åŠ¨ç¤ºä¾‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1æ˜¯æŒ‡å®šä¸€ä¸ªçº¿ç¨‹ç”¨äºå¤„ç†è¿æ¥ï¼Œ0è¡¨ç¤ºä¸å¤„ç†è¿æ¥</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// é‡Œé¢çš„å‚æ•°æ˜¯çº¿ç¨‹æ•°ï¼Œè¿™é‡Œæ˜¯å¤„ç†æ¶ˆæ¯çš„çº¿ç¨‹æ•°,falseæ˜¯æŒ‡å®šçº¿ç¨‹å·¥å‚æ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹</span>
        <span class="token class-name">DefaultEventExecutorGroup</span> serviceHandlerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultEventExecutorGroup</span><span class="token punctuation">(</span>
                <span class="token class-name">RuntimeUtil</span><span class="token punctuation">.</span><span class="token function">getProcessorCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
                <span class="token class-name">ThreadUtil</span><span class="token punctuation">.</span><span class="token function">newNamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">"service-handler-group"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * bossçº¿ç¨‹ç»„ç”¨äºå¤„ç†è¿æ¥å·¥ä½œï¼Œworkerçº¿ç¨‹ç»„ç”¨äºæ•°æ®å¤„ç†
             * ä¾æ¬¡çš„ç»“æ„æ˜¯ group -&gt; channel -&gt; childHandler -&gt; handler
             * group ç”¨äºå¤„ç†è¿æ¥ï¼Œchannel ç”¨äºå¤„ç†æ•°æ®ï¼ŒchildHandler ç”¨äºå¤„ç†è¿æ¥çš„æ•°æ®ï¼Œhandler ç”¨äºå¤„ç†æ•°æ®çš„
             * æ‰€å±å…³ç³»:ä¸€ä¸ª group å¯ä»¥æœ‰å¤šä¸ª channelï¼Œä¸€ä¸ª channel å¯ä»¥æœ‰å¤šä¸ª childHandlerï¼Œä¸€ä¸ª childHandler å¯ä»¥æœ‰å¤šä¸ª handler
             * ä¸€ä¸ª channel åªèƒ½æœ‰ä¸€ä¸ª childHandlerï¼Œä¸€ä¸ª childHandler å¯ä»¥æœ‰å¤šä¸ª handler
             */</span>
            <span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">TRACE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//                                    .addLast(new HttpServerCodec())</span>
<span class="token comment">//                                    .addLast(new HttpObjectAggregator(65536))</span>
<span class="token comment">//                                    .addLast(new ChunkedWriteHandler())</span>
                                    <span class="token comment">// 30ä¹‹å†…æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå°±ä¼šè§¦å‘IdleStateHandlerçš„userEventTriggeredæ–¹æ³•</span>
                                    <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtocolEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtocolDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serviceHandlerGroup<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NettyServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                                    .addLast(new TestNettyHandler());</span>
                            <span class="token comment">// todo æ¥æ”¶æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯å…ˆç¼–ç ï¼Œç„¶åè§£ç æˆZMessageæ ¼å¼ï¼Œæœ€åäº¤ç”±NettyHttpServerHandlerå¤„ç†</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_KEEPALIVE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Server is now listening on port "</span> <span class="token operator">+</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ¬æ–‡å°±åŸºäºè¿™ä¸€æ®µä»£ç æ¥è¿›è¡Œæ·±å…¥æ¢ç©¶Nettyæ˜¯å¦‚ä½•å®ç°çš„</p>
<h2 id="EventLoopGroup"><a href="#EventLoopGroup" class="headerlink" title="EventLoopGroup"></a>EventLoopGroup</h2><p>æˆ‘ä»¬è¿›å…¥NioEventLoopGroupçš„æºç ä¸­</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Executor</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬æ²¿ç€thisä¸æ–­å¾€ä¸‹æŸ¥æ‰¾ï¼Œå‘ç°</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">SelectorProvider</span> selectorProvider<span class="token punctuation">,</span> <span class="token class-name">SelectStrategyFactory</span> selectStrategyFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>selectorProvider<span class="token punctuation">,</span> selectStrategyFactory<span class="token punctuation">,</span> <span class="token class-name">RejectedExecutionHandlers</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ç„¶åè¿›å…¥superä¹‹åï¼Œå‘ç°nThreadsè¿™ä¸ªå‚æ•°å½±å“çš„æ˜¯è¿™é‡Œ</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_EVENT_LOOP_THREADS</span> <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">SystemPropertyUtil</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"io.netty.eventLoopThreads"</span><span class="token punctuation">,</span> <span class="token class-name">NettyRuntime</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token keyword">protected</span> <span class="token class-name">MultithreadEventLoopGroup</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">super</span><span class="token punctuation">(</span>nThreads <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token constant">DEFAULT_EVENT_LOOP_THREADS</span> <span class="token operator">:</span> nThreads<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ€ç»ˆå‘ç°ï¼š<br>ä¸€åˆ‡çš„æ ¹æºæ˜¯<code>MultithreadEventExecutorGroup</code>è¿™ä¸ªç±»</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">MultithreadEventExecutorGroup</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">EventExecutorChooserFactory</span> chooserFactory<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆå§‹åŒ– terminatedChildren å’Œ terminationFuture</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>terminatedChildren <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>terminationFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultPromise</span><span class="token punctuation">(</span><span class="token class-name">GlobalEventExecutor</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ£€æŸ¥ nThreads æ˜¯å¦ä¸ºæ­£æ•°</span>
    <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkPositive</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> <span class="token string">"nThreads"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å¦‚æœ executor ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹å·¥å‚åˆ›å»ºä¸€ä¸ªæ–°çš„ ThreadPerTaskExecutor</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPerTaskExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newDefaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆå§‹åŒ– children æ•°ç»„</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventExecutor</span><span class="token punctuation">[</span>nThreads<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// åˆ›å»ºå¹¶åˆå§‹åŒ–æ¯ä¸ª EventExecutor</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nThreads<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> var18 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            var18 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// åˆ›å»ºæ–°çš„å­ EventExecutor</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newChild</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Executor</span><span class="token punctuation">)</span> executor<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            var18 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var19<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¦‚æœåˆ›å»ºå¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"failed to create a child event loop"</span><span class="token punctuation">,</span> var19<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>var18<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œå…³é—­å·²åˆ›å»ºçš„ EventExecutor</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> i<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> i<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">EventExecutor</span> e <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>

                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                e<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">2147483647L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> var20<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œå…³é—­å·²åˆ›å»ºçš„ EventExecutor</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> i<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> i<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">EventExecutor</span> e <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">2147483647L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> var22<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆ›å»º EventExecutorChooser</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>chooser <span class="token operator">=</span> chooserFactory<span class="token punctuation">.</span><span class="token function">newChooser</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// åˆ›å»ºå¹¶æ·»åŠ  terminationListener</span>
    <span class="token class-name">FutureListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> terminationListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MultithreadEventExecutorGroup</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>terminatedChildren<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">MultithreadEventExecutorGroup</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">MultithreadEventExecutorGroup</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>terminationFuture<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// ä¸ºæ¯ä¸ª EventExecutor æ·»åŠ  terminationListener</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">EventExecutor</span> e <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">terminationFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>terminationListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆ›å»ºåªè¯»çš„ children é›†åˆ</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EventExecutor</span><span class="token punctuation">&gt;</span></span> childrenSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>childrenSet<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>readonlyChildren <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableSet</span><span class="token punctuation">(</span>childrenSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬debugèµ°è¿›å»ï¼Œåˆ°è¿™ä¸ªåœ°æ–¹<br><img src="/2024/10/01/34/Netty%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/1.png"><br>å‘ç°åœ¨è¿™é‡Œä½¿ç”¨äº†é»˜è®¤çš„çº¿ç¨‹å·¥å‚åˆ›å»ºäº†ä¸€ä¸ªThreadPerTaskExecutorï¼Œæ¥ç€å¾€ä¸‹èµ°<br>å‘ç°ä»<code>this.children = new EventExecutor[nThreads];</code>è¿™ä¸€è¡Œå¼€å§‹ï¼Œåœ¨åˆ›å»ºå¹¶åˆå§‹åŒ–æ¯ä¸€ä¸ªExecutor<br>æ¥ç€å¾€ä¸‹çœ‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">this</span><span class="token punctuation">.</span>chooser <span class="token operator">=</span> chooserFactory<span class="token punctuation">.</span><span class="token function">newChooser</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª EventExecutorChooserå¯¹è±¡ç”¨äºåœ¨å¤šä¸ª EventExecutor ä¹‹é—´é€‰æ‹©ä¸€ä¸ªæ‰§è¡Œä»»åŠ¡<br>ä¹‹åå¾€ä¸‹çœ‹ï¼Œå¯ä»¥å‘ç°ï¼Œä¸ºæ¯ä¸€ä¸ªchildrenæ•°ç»„ä¸­çš„å¯¹è±¡æ·»åŠ äº†TerminationListenerè¿™ä¸ªç›‘å¬å™¨<img src="/2024/10/01/34/addListener.png"><br>TerminationListenerçš„ä½œç”¨æ˜¯ï¼Œç›‘å¬æ¯ä¸€ä¸ªEventExecutorçš„ç»ˆæ­¢äº‹ä»¶ï¼Œå½“æ‰€æœ‰çš„EventExecutoréƒ½ç»ˆæ­¢ä¹‹åï¼Œä¼šå°†TerminationFutureè®¾ç½®ä¸ºæˆåŠŸçŠ¶æ€ï¼Œè¡¨ç¤ºæ•´ä¸ªMultithreadEventExecutorGroup å·²ç»å®Œå…¨ç»ˆæ­¢<br>TerminationListeneræ˜¯ä¸ªåŒ¿åå†…éƒ¨ç±»</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">FutureListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> terminationListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MultithreadEventExecutorGroup</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>terminatedChildren<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">MultithreadEventExecutorGroup</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token class-name">MultithreadEventExecutorGroup</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>terminationFuture<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ–¹æ³•çš„æœ€åï¼Œå°†æ‰€æœ‰çš„childrenä¸­çš„EventExecutorè½¬åŒ–ä¸ºä¸€ä¸ªä¸å¯ä¿®æ”¹çš„é›†åˆï¼Œä»è€Œä¿è¯readonlyChildrené›†åˆä¸­çš„å…ƒç´ ä¸å¯ä¿®æ”¹ï¼Œä»è€Œä¿è¯çº¿ç¨‹å®‰å…¨å’Œæ•°æ®çš„å®Œæ•´æ€§<br>åˆ°è¿™é‡Œç¬¬ä¸€éƒ¨åˆ†çš„æºç å°±åˆ†æå®Œæ¯•ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬å…³æ³¨åˆ°ServerBootstrapè¿™ä¸ªç±»</p>
<h2 id="ServerBootstrap"><a href="#ServerBootstrap" class="headerlink" title="ServerBootstrap"></a>ServerBootstrap</h2><p>å…ˆå›é¡¾ä¸€æ³¢ç¤ºä¾‹ä»£ç </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>  
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>  
                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">TRACE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                        <span class="token annotation punctuation">@Override</span>  
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>  
                            socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token comment">//                                    .addLast(new HttpServerCodec())  </span>
<span class="token comment">//                                    .addLast(new HttpObjectAggregator(65536))  </span>
<span class="token comment">//                                    .addLast(new ChunkedWriteHandler())  </span>
                                    <span class="token comment">// 30ä¹‹å†…æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå°±ä¼šè§¦å‘IdleStateHandlerçš„userEventTriggeredæ–¹æ³•  </span>
                                    <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                                    <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtocolEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                                    <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtocolDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                                    <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serviceHandlerGroup<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NettyServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token comment">//                                    .addLast(new TestNettyHandler());  </span>
                            <span class="token comment">// todo æ¥æ”¶æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯å…ˆç¼–ç ï¼Œç„¶åè§£ç æˆZMessageæ ¼å¼ï¼Œæœ€åäº¤ç”±NettyHttpServerHandlerå¤„ç†  </span>
                        <span class="token punctuation">}</span>  
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>  
                    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>  
                    <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_KEEPALIVE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="group"><a href="#group" class="headerlink" title="group"></a>group</h3><p><img src="/2024/10/01/34/group.png"><br>è®©æˆ‘ä»¬ç‚¹è¿›å»æŸ¥çœ‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ServerBootstrap</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token class-name">EventLoopGroup</span> parentGroup<span class="token punctuation">,</span> <span class="token class-name">EventLoopGroup</span> childGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	<span class="token comment">// å°†parentGroupè®¾ç½®ä¸ºçˆ¶ç»„</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>parentGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childGroup <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"childGroup set already"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>childGroup <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">EventLoopGroup</span><span class="token punctuation">)</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>childGroup<span class="token punctuation">,</span> <span class="token string">"childGroup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥å‘ç°å‡ ä¸ªæœ‰è¶£çš„åœ°æ–¹ï¼š</p>
<ol>
<li>é“¾å¼è°ƒç”¨å®é™…ä¸Šå°±æ˜¯åœ¨æ–¹æ³•ç»“æŸçš„æ—¶å€™è¿”å›thisæœ¬èº«ï¼Œè¿™ä¸ªæŒ‡é’ˆ</li>
<li>parentGroupéœ€è¦å»çœ‹çˆ¶ç±»<br>å…ˆè®©æˆ‘ä»¬èšç„¦åˆ°ServerBootstrapè¿™ä¸ªç±»</li>
</ol>
<h3 id="åŸºæœ¬å±æ€§"><a href="#åŸºæœ¬å±æ€§" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerBootstrap</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerBootstrap</span><span class="token punctuation">,</span> <span class="token class-name">ServerChannel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// ç”¨äºè®°å½•æ—¥å¿—çš„é™æ€å¸¸é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">InternalLogger</span> logger <span class="token operator">=</span> <span class="token class-name">InternalLoggerFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">ServerBootstrap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å­˜å‚¨å­é€šé“é€‰é¡¹çš„ Map</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> childOptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å­˜å‚¨å­é€šé“å±æ€§çš„ Map</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> childAttrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ServerBootstrap çš„é…ç½®å¯¹è±¡</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ServerBootstrapConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrapConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å­äº‹ä»¶å¾ªç¯ç»„ï¼Œä½¿ç”¨ volatile ä¿®é¥°ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">EventLoopGroup</span> childGroup<span class="token punctuation">;</span>

    <span class="token comment">// å­é€šé“å¤„ç†å™¨ï¼Œä½¿ç”¨ volatile ä¿®é¥°ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ChannelHandler</span> childHandler<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬å°±ä¼šå‘ç°ï¼Œæ„é€ å‡½æ•°ä¸­çš„é‚£äº›å±æ€§å…¨éƒ½æ˜¯åœ¨è¿™é‡Œçš„<br>è®©æˆ‘ä»¬ç»§ç»­æº¯æºåˆ°AbstractBootstrap</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token punctuation">&lt;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{</span>

	<span class="token comment">// ç©ºçš„ ChannelOption æ•°ç»„å¸¸é‡</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">EMPTY_OPTION_ARRAY</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// ç©ºçš„ AttributeKey æ•°ç»„å¸¸é‡</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">EMPTY_ATTRIBUTE_ARRAY</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// äº‹ä»¶å¾ªç¯ç»„ï¼Œä½¿ç”¨ volatile ä¿®é¥°ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨</span>
<span class="token keyword">volatile</span> <span class="token class-name">EventLoopGroup</span> group<span class="token punctuation">;</span>

<span class="token comment">// é€šé“å·¥å‚ï¼Œä½¿ç”¨ volatile ä¿®é¥°ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> channelFactory<span class="token punctuation">;</span>

<span class="token comment">// æœ¬åœ°åœ°å€ï¼Œä½¿ç”¨ volatile ä¿®é¥°ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">;</span>

<span class="token comment">// å­˜å‚¨é€šé“é€‰é¡¹çš„ Map</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å­˜å‚¨é€šé“å±æ€§çš„ Map</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// é€šé“å¤„ç†å™¨ï¼Œä½¿ç”¨ volatile ä¿®é¥°ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">;</span>

<span class="token comment">// æ‰©å±•ç±»åŠ è½½å™¨ï¼Œä½¿ç”¨ volatile ä¿®é¥°ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ClassLoader</span> extensionsClassLoader<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œæœ‰ä¸ªå¾ˆæœ‰æ„æ€çš„ç»§æ‰¿å…³ç³»<br>è¿™ä¸ªå®šä¹‰æ˜¯ä¸€ä¸ªæŠ½è±¡ç±» <code>AbstractBootstrap</code>ï¼Œå®ƒæœ‰ä¸¤ä¸ªæ³›å‹å‚æ•° <code>B</code> å’Œ <code>C</code>ï¼Œå¹¶ä¸”å®ç°äº† <code>Cloneable</code> æ¥å£ã€‚</p>
<ul>
<li><code>B extends AbstractBootstrap&lt;B, C&gt;</code>ï¼šè¡¨ç¤ºæ³›å‹å‚æ•° <code>B</code> å¿…é¡»æ˜¯ <code>AbstractBootstrap</code> ç±»çš„å­ç±»ï¼Œå¹¶ä¸”å…·æœ‰ç›¸åŒçš„æ³›å‹å‚æ•° <code>B</code> å’Œ <code>C</code>ã€‚è¿™ç§å®šä¹‰æ–¹å¼é€šå¸¸ç”¨äºå®ç°æµå¼ APIï¼Œä½¿æ–¹æ³•å¯ä»¥è¿”å›å½“å‰å¯¹è±¡çš„ç±»å‹ã€‚</li>
<li><code>C extends Channel</code>ï¼šè¡¨ç¤ºæ³›å‹å‚æ•° <code>C</code> å¿…é¡»æ˜¯ <code>Channel</code> ç±»çš„å­ç±»ã€‚<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">B</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token class-name">EventLoopGroup</span> group<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token string">"group"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>group <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"group set already"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>group <span class="token operator">=</span> group<span class="token punctuation">;</span>  
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°<br><img src="/2024/10/01/34/supergroup.png"><br>è¿™é‡Œè®¾ç½®çš„groupå®é™…ä¸Šå°±æ˜¯åœ¨ç»™ä»<code>AbstractBoostrap</code>ä¸­é›†æˆåˆ°çš„groupè¿›è¡Œèµ‹å€¼ï¼Œè€ŒchildGroupåˆ™æ˜¯<code>ServerBoostarap</code>è‡ªå·±çš„æ–°å¢çš„å±æ€§èµ‹å€¼<br>æ¥ç€å…³æ³¨åˆ°.handlerè¿›å…¥ä¹‹åå¯ä»¥çœ‹åˆ°å°†handlerèµ‹å€¼ç»™å±æ€§äº†ï¼Œè¿™æ®µæºç æ¯”è¾ƒç®€å•ï¼Œå°±ä¸è´´å‡ºæ¥äº†<br>æ¥ç€å…³æ³¨childHandler<br><img src="/2024/10/01/34/childHandler.png"><br>åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç»™è¿æ¥åäº§ç”Ÿçš„SocketChannelé…ç½®ä¸€äº›ä¸œè¥¿ï¼Œæ¯”å¦‚é€šè¿‡.addLastæ¥æ·»åŠ è¿æ¥å¤„ç†å™¨ï¼Œhandleræ˜¯ç»™Bossåˆ0å§‹åŒ–çš„ï¼Œè€ŒchildHandleråˆ™æ˜¯ç»™Workerè¿›è¡Œåˆå§‹åŒ–<br>æœ€å<br>.option å’Œ .childOption æ˜¯ Netty ä¸­ ServerBootstrap ç±»çš„æ–¹æ³•ï¼Œç”¨äºé…ç½®æœåŠ¡å™¨é€šé“å’Œå­é€šé“çš„é€‰é¡¹ã€‚<br>å…¶ä¸­.optionæ˜¯<code>AbstractBoostrap</code>ä¸­çš„å±æ€§ã€‚<br>ä»¥ä¸Šéƒ½ä¸æ˜¯å¾ˆéš¾çš„éƒ¨åˆ†ï¼ŒçœŸæ­£æ ¸å¿ƒçš„åœ¨ä¸‹é¢ğŸ‘‡</li>
</ul>
<h3 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¿™ä¸€æ®µä»£ç æ˜¯å°†æˆ‘ä»¬çš„ChannelFutureé€šè¿‡Boostrapå¯åŠ¨ç±»åˆå§‹åŒ–ä¹‹åï¼Œæ¥ç»‘å®šç»“æœï¼ŒChannelFutureå°±æ˜¯ä¸€ä¸ªç±»ä¼¼äºFutureçš„ä¸€ä¸ªä¸œè¥¿ï¼Œæä¾›äº†ä¸€äº›ä¸Channelç›¸å…³çš„æ–¹æ³•ï¼Œåæ–‡ä¼šå±•å¼€ï¼Œè¿™é‡Œå…ˆè·³è¿‡ã€‚<br>ç„¶æˆ‘ä»¬è·Ÿç€bindçš„è°ƒç”¨é“¾å»æ­å¼€è°œåº•ï¼<br><img src="/2024/10/01/34/bind1.png"><br><img src="/2024/10/01/34/bind2.png"><br>åˆ°è¿™é‡Œæˆ‘ä»¬æ‰æ„è¯†åˆ°ï¼Œä¸€åˆ‡çš„æ ¹æºéƒ½åœ¨doBindè¿™ä¸ªæ–¹æ³•ä¸­ã€‚<br>å…ˆè´´æºç </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">ChannelFuture</span> <span class="token function">doBind</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆå§‹åŒ–å¹¶æ³¨å†ŒChannel</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initAndRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel <span class="token operator">=</span> regFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// å¦‚æœæ³¨å†Œè¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œç›´æ¥è¿”å›æ³¨å†Œçš„Future</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> regFuture<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token comment">// å¦‚æœæ³¨å†Œå·²ç»å®Œæˆï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ChannelPromiseå¹¶æ‰§è¡Œç»‘å®šæ“ä½œ</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPromise</span> promise <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">newPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">doBind0</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token comment">// å¦‚æœæ³¨å†Œæœªå®Œæˆï¼Œåˆ›å»ºä¸€ä¸ªPendingRegistrationPromiseå¹¶æ·»åŠ ç›‘å¬å™¨</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">PendingRegistrationPromise</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PendingRegistrationPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        regFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token class-name">Throwable</span> cause <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å¦‚æœæ³¨å†Œè¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œè®¾ç½®Promiseä¸ºå¤±è´¥çŠ¶æ€</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    promise<span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> 
                <span class="token comment">// å¦‚æœæ³¨å†ŒæˆåŠŸï¼Œæ ‡è®°Promiseä¸ºå·²æ³¨å†Œå¹¶æ‰§è¡Œç»‘å®šæ“ä½œ</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    promise<span class="token punctuation">.</span><span class="token function">registered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">AbstractBootstrap</span><span class="token punctuation">.</span><span class="token function">doBind0</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¼€å§‹åˆ†æ<br><img src="/2024/10/01/34/initAndRegister.png"><br>è®©æˆ‘ä»¬å…³æ³¨åˆ°<code>initAndRegister</code>è¿™ä¸ªæ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">initAndRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ›å»ºæ–°çš„Channelå®ä¾‹</span>
        channel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>channelFactory<span class="token punctuation">.</span><span class="token function">newChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆå§‹åŒ–Channel</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœåˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œå…³é—­Channelå¹¶è¿”å›å¤±è´¥çš„Promise</span>
        <span class="token comment">// promise æ˜¯ä¸€ç§ç”¨äºè¡¨ç¤ºå¼‚æ­¥æ“ä½œç»“æœçš„å¯¹è±¡ã€‚å®ƒå…è®¸ä½ åœ¨å¼‚æ­¥æ“ä½œå®Œæˆåæ‰§è¡ŒæŸäº›æ“ä½œï¼Œè€Œä¸éœ€è¦é˜»å¡å½“å‰çº¿ç¨‹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>channel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeForcibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultChannelPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token class-name">GlobalEventExecutor</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>var3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å¦‚æœChannelä¸ºnullï¼Œè¿”å›ä¸€ä¸ªå¤±è´¥çš„Promise</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultChannelPromise</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FailedChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">GlobalEventExecutor</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>var3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ³¨å†ŒChannelåˆ°EventLoopGroup</span>
    <span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœæ³¨å†Œè¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œå…³é—­Channel</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">isRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeForcibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿”å›æ³¨å†Œçš„Future</span>
    <span class="token keyword">return</span> regFuture<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯¹äº<code>channel = this.channelFactory.newChannel();</code>è¿™ä¸€è¡Œï¼Œæˆ‘ä»¬debugè¿›å»ï¼Œ<br>æœ€ç»ˆåœ¨<img src="/2024/10/01/34/ChannelFactory.png">æ‰¾åˆ°äº†å¦‚ä½•åˆå§‹åŒ–çš„ï¼Œ<img src="/2024/10/01/34/constructor.png"></p>
<blockquote>
<p>Constructor æ˜¯ Java åå°„æœºåˆ¶ä¸­çš„ä¸€ä¸ªç±»ï¼Œç”¨äºè¡¨ç¤ºç±»çš„æ„é€ æ–¹æ³•ã€‚é€šè¿‡ Constructor ç±»ï¼Œä½ å¯ä»¥åŠ¨æ€åœ°åˆ›å»ºç±»çš„å®ä¾‹ã€è·å–æ„é€ æ–¹æ³•çš„å‚æ•°ç±»å‹ã€è®¿é—®ä¿®é¥°ç¬¦ç­‰ä¿¡æ¯ã€‚</p>
</blockquote>
<p><img src="/2024/10/01/34/newInstance1.png"><br>è¿™é‡Œé€šè¿‡åå°„è·å¾—äº†io.netty.channel.ReflectiveChannelFactory<br><img src="/2024/10/01/34/delegeting.png"><br>è¿™é‡Œå¯ä»¥æ‰¾åˆ°ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡DelegatingConstructorAccessorImplæ¥å®ç°çš„ï¼Œä¸æ–­æ·±å…¥ï¼Œæœ€ååœ¨è¿™é‡Œæ‰¾åˆ°ç­”æ¡ˆ<img src="/2024/10/01/34/newInstance0.png"><br>å¥¥ï¼ŒåŸæ¥æ˜¯è°ƒç”¨äº†ä¸€ä¸ªæœ¬åœ°æ–¹æ³•æ¥å®ç°çš„æœåŠ¡æ³¨å†Œï¼</p>
<h3 id="ChannelFuture"><a href="#ChannelFuture" class="headerlink" title="ChannelFuture"></a>ChannelFuture</h3><p>è¡¥å……ä¸€ä¸‹ChannelFutureçš„å®šä¹‰</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//</span>
<span class="token comment">// Source code recreated from a .class file by IntelliJ IDEA</span>
<span class="token comment">// (powered by FernFlower decompiler)</span>
<span class="token comment">//</span>

<span class="token keyword">package</span> <span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Future</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">GenericFutureListener</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ChannelFuture</span> <span class="token keyword">extends</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * è¿”å›ä¸æ­¤Futureç›¸å…³è”çš„Channelã€‚
     * @return ç›¸å…³è”çš„Channel
     */</span>
    <span class="token class-name">Channel</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * æ·»åŠ ä¸€ä¸ªç›‘å¬å™¨ï¼Œå½“æ“ä½œå®Œæˆæ—¶ä¼šé€šçŸ¥è¯¥ç›‘å¬å™¨ã€‚
     * @param listener è¦æ·»åŠ çš„ç›‘å¬å™¨
     * @return å½“å‰çš„ChannelFutureå®ä¾‹
     */</span>
    <span class="token class-name">ChannelFuture</span> <span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">GenericFutureListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">Void</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * æ·»åŠ å¤šä¸ªç›‘å¬å™¨ï¼Œå½“æ“ä½œå®Œæˆæ—¶ä¼šé€šçŸ¥è¿™äº›ç›‘å¬å™¨ã€‚
     * @param listeners è¦æ·»åŠ çš„ç›‘å¬å™¨æ•°ç»„
     * @return å½“å‰çš„ChannelFutureå®ä¾‹
     */</span>
    <span class="token class-name">ChannelFuture</span> <span class="token function">addListeners</span><span class="token punctuation">(</span><span class="token class-name">GenericFutureListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">Void</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> listeners<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * ç§»é™¤ä¸€ä¸ªç›‘å¬å™¨ã€‚
     * @param listener è¦ç§»é™¤çš„ç›‘å¬å™¨
     * @return å½“å‰çš„ChannelFutureå®ä¾‹
     */</span>
    <span class="token class-name">ChannelFuture</span> <span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token class-name">GenericFutureListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">Void</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * ç§»é™¤å¤šä¸ªç›‘å¬å™¨ã€‚
     * @param listeners è¦ç§»é™¤çš„ç›‘å¬å™¨æ•°ç»„
     * @return å½“å‰çš„ChannelFutureå®ä¾‹
     */</span>
    <span class="token class-name">ChannelFuture</span> <span class="token function">removeListeners</span><span class="token punctuation">(</span><span class="token class-name">GenericFutureListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">Void</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> listeners<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * ç­‰å¾…æ“ä½œå®Œæˆå¹¶åŒæ­¥è¿”å›ç»“æœï¼Œå¦‚æœæ“ä½œè¢«ä¸­æ–­åˆ™æŠ›å‡ºInterruptedExceptionã€‚
     * @return å½“å‰çš„ChannelFutureå®ä¾‹
     * @throws InterruptedException å¦‚æœæ“ä½œè¢«ä¸­æ–­
     */</span>
    <span class="token class-name">ChannelFuture</span> <span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * ç­‰å¾…æ“ä½œå®Œæˆå¹¶åŒæ­¥è¿”å›ç»“æœï¼Œä¸ä¼šè¢«ä¸­æ–­ã€‚
     * @return å½“å‰çš„ChannelFutureå®ä¾‹
     */</span>
    <span class="token class-name">ChannelFuture</span> <span class="token function">syncUninterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * ç­‰å¾…æ“ä½œå®Œæˆã€‚
     * @return å½“å‰çš„ChannelFutureå®ä¾‹
     * @throws InterruptedException å¦‚æœæ“ä½œè¢«ä¸­æ–­
     */</span>
    <span class="token class-name">ChannelFuture</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * ç­‰å¾…æ“ä½œå®Œæˆï¼Œä¸ä¼šè¢«ä¸­æ–­ã€‚
     * @return å½“å‰çš„ChannelFutureå®ä¾‹
     */</span>
    <span class="token class-name">ChannelFuture</span> <span class="token function">awaitUninterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * æ£€æŸ¥æ­¤Futureæ˜¯å¦æ˜¯Voidç±»å‹ã€‚
     * @return å¦‚æœæ˜¯Voidç±»å‹åˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">isVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ChannelFutureå°±æ˜¯å®šä¹‰äº†ä¸€ç³»åˆ—çš„ç›‘å¬Channelè¡Œä¸ºçš„ç›‘å¬å™¨</p>
<h3 id="doBind"><a href="#doBind" class="headerlink" title="doBind"></a>doBind</h3><p>æ¥ç€é¡ºç€doBindå¾€ä¸‹çœ‹<br><img src="/2024/10/01/34/doBind.png"><br>åœ¨è¿™é‡Œå¦‚æœå‡ºç°å„ç§å¼‚å¸¸è¡Œä¸ºï¼Œä¼šç»™promiseè®¾ç½®å¼‚å¸¸ä¹‹åé€€å‡ºï¼Œå¦åˆ™åˆ™è°ƒç”¨doBind0</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">doBind0</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> regFuture<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åœ¨ channel çš„äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œç»‘å®šæ“ä½œ</span>
    channel<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ£€æŸ¥æ³¨å†Œæ“ä½œæ˜¯å¦æˆåŠŸ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœæ³¨å†ŒæˆåŠŸï¼Œç»‘å®šåˆ°æœ¬åœ°åœ°å€ï¼Œå¹¶åœ¨å¤±è´¥æ—¶å…³é—­ channel</span>
                channel<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span><span class="token constant">CLOSE_ON_FAILURE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœæ³¨å†Œå¤±è´¥ï¼Œè®¾ç½® promise çš„å¤±è´¥åŸå› </span>
                promise<span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€šè¿‡EventLoopçš„ç±»å…³ç³»å›¾å¯ä»¥çŸ¥é“ï¼ŒEventLoopå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå°è£…çš„Executorï¼Œæ‰€ä»¥å®é™…ä¸Šæ˜¯ä½¿ç”¨çš„Executoræ¥è·‘ä¸€ä¸ªçº¿ç¨‹æ¥è¿›è¡Œç»‘å®š<br>è‡³æ­¤ï¼ŒServerBootstrapçš„åˆå§‹åŒ–æˆ‘ä»¬å°±å·²ç»å®Œæ•´çš„æ¢ç©¶äº†ä¸€é</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zuofw.github.io/2024/09/30/01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QingQiu">
      <meta itemprop="description" content="ä¸ªäººç½‘ç«™ï¼Œå­¦ä¹ è®°å½•ï¼Œé¢è¯•è®°å½•å’Œç»éªŒæ€»ç»“ã€äº’è”ç½‘ä¸­ä¸€å—å±äºè‡ªå·±çš„å°çª">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QingQiu'Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/30/01/" class="post-title-link" itemprop="url">æ·±å…¥æµ…å‡ºfuture</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-09-30 23:16:01" itemprop="dateCreated datePublished" datetime="2024-09-30T23:16:01+08:00">2024-09-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">æ·±å…¥ç†è§£ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>7.5k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ä½¿ç”¨ç¤ºä¾‹"><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h1><h2 id="Callable-amp-FutureTask"><a href="#Callable-amp-FutureTask" class="headerlink" title="Callable &amp; FutureTask"></a>Callable &amp; FutureTask</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> callableTask <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> <span class="token string">"Callable Task Result"</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
  
<span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> futureTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>callableTask<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>futureTask<span class="token punctuation">)</span><span class="token punctuation">;</span>  
thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="CompletableFuture"><a href="#CompletableFuture" class="headerlink" title="CompletableFuture"></a>CompletableFuture</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> completableFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
    <span class="token keyword">try</span> <span class="token punctuation">{</span>  
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">return</span> <span class="token string">"CompletableFuture Result"</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="æ·±å…¥ä½¿ç”¨"><a href="#æ·±å…¥ä½¿ç”¨" class="headerlink" title="æ·±å…¥ä½¿ç”¨"></a>æ·±å…¥ä½¿ç”¨</h3><p>ä»¥ä¸‹ç¤ºä¾‹æ¥è‡ªï¼š<a target="_blank" rel="noopener" href="https://tech.meituan.com/2022/05/12/principles-and-practices-of-completablefuture.html#:~:text=%E6%9C%AC%E7%AB%A0%E8%8A%82%E4%B8%BAComple">CompletableFutureåŸç†ä¸å®è·µ-å¤–å–å•†å®¶ç«¯APIçš„å¼‚æ­¥åŒ– - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ (meituan.com)</a><br>CFçš„ä½¿ç”¨æ˜¯åŸºäºæ„é€ ä¾èµ–æ ‘çš„ï¼Œä¸€ä¸ªCompletableFutureçš„ä½¿ç”¨ä¼šè§¦å‘å¦å¤–ä¸€ç³»åˆ—ä¾èµ–å®ƒçš„CFæ‰§è¡Œ<br><img src="/2024/09/30/01/CF%E4%BE%9D%E8%B5%96.png"><br>æœåŠ¡ä¾èµ–</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// æ— ä¾èµ–</span>
<span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token comment">// ç›´æ¥å‘èµ·å¼‚æ­¥è°ƒç”¨  </span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cf1 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">"result1"</span><span class="token punctuation">,</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token comment">// ç›´æ¥è¿”å›ä¸€ä¸ªå·²ç»å®Œæˆçš„CompletableFuture  </span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cf2 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token string">"result2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å•ä¸ªä¾èµ–</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cf3 <span class="token operator">=</span> cf1<span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"result1: "</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> <span class="token string">"result3"</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cf4 <span class="token operator">=</span> cf1<span class="token punctuation">.</span><span class="token function">thenCombine</span><span class="token punctuation">(</span>cf2<span class="token punctuation">,</span> <span class="token punctuation">(</span>result1<span class="token punctuation">,</span> result2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
    <span class="token comment">//result1å’Œresult2åˆ†åˆ«ä¸ºcf1å’Œcf2çš„ç»“æœ  </span>
    <span class="token keyword">return</span> <span class="token string">"result4"</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å¤šä¾èµ–</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> cf6 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>cf3<span class="token punctuation">,</span> cf4<span class="token punctuation">,</span> cf5<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> cf6<span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>v <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
    <span class="token comment">//è¿™é‡Œçš„joinå¹¶ä¸ä¼šé˜»å¡ï¼Œå› ä¸ºä¼ ç»™thenApplyçš„å‡½æ•°æ˜¯åœ¨CF3ã€CF4ã€CF5å…¨éƒ¨å®Œæˆæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œ ã€‚  </span>
    result3 <span class="token operator">=</span> cf3<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    result4 <span class="token operator">=</span> cf4<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    result5 <span class="token operator">=</span> cf5<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">//æ ¹æ®result3ã€result4ã€result5ç»„è£…æœ€ç»ˆresult;  </span>
    <span class="token keyword">return</span> <span class="token string">"result"</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// æˆ–è€…ä½¿ç”¨anyOfï¼Œåªè¦æœ‰ä¸€ä¸ªä¾èµ–å®Œæˆå³å¯å®Œæˆ</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="æºç è§£è¯»-åŸºäºJDK1-8"><a href="#æºç è§£è¯»-åŸºäºJDK1-8" class="headerlink" title="æºç è§£è¯»(åŸºäºJDK1.8)"></a>æºç è§£è¯»(åŸºäºJDK1.8)</h1><h2 id="Callable"><a href="#Callable" class="headerlink" title="Callable"></a>Callable</h2><p>Callableæ˜¯ç”¨äºå®šä¹‰å’Œè¿”å›ç»“æœï¼Œå¹¶ä¸”å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„ä»»åŠ¡ï¼Œç±»ä¼¼äºRunnable</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FunctionalInterface</span>  
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>  
    <span class="token comment">/**  
     * call æ–¹æ³•æ˜¯ Callable æ¥å£ä¸­çš„å”¯ä¸€æ–¹æ³•ï¼Œç”¨äºæ‰§è¡Œä»»åŠ¡å¹¶è¿”å›ç»“æœã€‚å®ƒä¸ Runnable æ¥å£çš„ run æ–¹æ³•ç±»ä¼¼ï¼Œä½† call æ–¹æ³•å¯ä»¥è¿”å›ä¸€ä¸ªç»“æœå¹¶ä¸”å¯ä»¥æŠ›å‡ºå—æ£€å¼‚å¸¸
     */</span>    
     <span class="token class-name">V</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="FutureTask"><a href="#FutureTask" class="headerlink" title="FutureTask"></a>FutureTask</h2><p>å…ˆæ¢³ç†ä¸€ä¸‹ç»§æ‰¿å…³ç³»ï¼ŒFutureæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰äº†ä¸€äº›å±æ€§ï¼Œç„¶å</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Runnable</span><span class="token punctuation">,</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Sets this Future to the result of its computation
     * unless it has been cancelled.
     */</span>
    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‰€ä»¥FutureTaskå°±æ˜¯ä¸€ä¸ªFutureçš„å®é™…å®ç°ï¼Œæ˜¯åŸºäºRunnableå®ç°çš„</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token comment">// ä»»åŠ¡çš„è¿è¡ŒçŠ¶æ€ï¼Œåˆå§‹ä¸º NEWã€‚çŠ¶æ€åªåœ¨ setã€setException å’Œ cancel æ–¹æ³•ä¸­è½¬æ¢ä¸ºç»ˆæ­¢çŠ¶æ€ã€‚</span>
	<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NEW</span>          <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COMPLETING</span>   <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NORMAL</span>       <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">EXCEPTIONAL</span>  <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CANCELLED</span>    <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERRUPTING</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERRUPTED</span>  <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>

	<span class="token comment">// é‡è¦çš„å±æ€§</span>
	<span class="token comment">// åº•å±‚çš„callableï¼Œè¿è¡Œåç½®ä¸ºnull</span>
	<span class="token keyword">private</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> callable<span class="token punctuation">;</span>
	<span class="token comment">// get()æ–¹æ³•è¿”å›çš„ç»“æœæˆ–è€…æŠ›å‡ºçš„å¼‚å¸¸</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> outcome<span class="token punctuation">;</span> <span class="token comment">// non-volatile, protected by state reads/writes</span>
	<span class="token comment">// è¿è¡Œcallableçš„çº¿ç¨‹,åœ¨run()æœŸé—´CASè®¾ç½®</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Thread</span> runner<span class="token punctuation">;</span>
	<span class="token comment">// ç­‰å¾…çº¿ç¨‹çš„Triberæ ˆ</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">WaitNode</span> waiters<span class="token punctuation">;</span>
	<span class="token comment">// è¿”å›ç»“æœæˆ–è€…è¿”å›å¼‚å¸¸ </span>
	<span class="token keyword">private</span> <span class="token class-name">V</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> x <span class="token operator">=</span> outcome<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NORMAL</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">V</span><span class="token punctuation">)</span>x<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;=</span> <span class="token constant">CANCELLED</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CancellationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">)</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ„é€ å‡½æ•°ï¼Œæ¥æ”¶callableä½œä¸ºå‚æ•°æ¥æ‰§è¡Œä»»åŠ¡</span>
    <span class="token keyword">public</span> <span class="token class-name">FutureTask</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> callable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callable <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>callable <span class="token operator">=</span> callable<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">NEW</span><span class="token punctuation">;</span>       <span class="token comment">// ensure visibility of callable</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è·å–æ‰§è¡Œç»“æœ</span>
    <span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> s <span class="token operator">=</span> state<span class="token punctuation">;</span>
		<span class="token comment">// å¦‚æœè¿˜å¤„äºæœªå®Œæˆçš„çŠ¶æ€åˆ™è°ƒç”¨awaitDone</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&lt;=</span> <span class="token constant">COMPLETING</span><span class="token punctuation">)</span>
            s <span class="token operator">=</span> <span class="token function">awaitDone</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// è¿”å›æ‰§è¡Œç»“æœæˆ–è€…å¼‚å¸¸</span>
        <span class="token keyword">return</span> <span class="token function">report</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ ¸å¿ƒæ‰§è¡Œ</span>
    <span class="token comment">// å› ä¸ºå°è£…äº†Runnableæ¥å£ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ‰§è¡Œä½¿ç”¨ä¸»çº¿ç¨‹</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token comment">// å¦‚æœä»»åŠ¡çŠ¶æ€ä¸æ˜¯NEWæˆ–è€…ä½¿ç”¨CASæ— æ³•å°†runnerè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ï¼Œç›´æ¥è¿”å›</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token constant">NEW</span> <span class="token operator">||</span>
            <span class="token operator">!</span><span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> runnerOffset<span class="token punctuation">,</span>
                                         <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> callable<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> state <span class="token operator">==</span> <span class="token constant">NEW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">V</span> result<span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> ran<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
					<span class="token comment">// è°ƒç”¨callableçš„callæ–¹æ³•å»æ‰§è¡Œcallableå°è£…çš„ä»»åŠ¡</span>
                    result <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ran <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    ran <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token function">setException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ran<span class="token punctuation">)</span>
					<span class="token comment">// è®¾ç½®è¿”å›ç»“æœ</span>
                    <span class="token function">set</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// runner must be non-null until state is settled to</span>
            <span class="token comment">// prevent concurrent calls to run()</span>
			<span class="token comment">// çº¿ç¨‹ç½®ä¸ºnull,é˜²æ­¢å¹¶å‘è°ƒç”¨çº¿ç¨‹</span>
            runner <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// state must be re-read after nulling runner to prevent</span>
            <span class="token comment">// leaked interrupts</span>
            <span class="token keyword">int</span> s <span class="token operator">=</span> state<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;=</span> <span class="token constant">INTERRUPTING</span><span class="token punctuation">)</span>
                <span class="token function">handlePossibleCancellationInterrupt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// åœæ­¢æ‰§è¡Œä»»åŠ¡å®é™…ä¸Šå°±æ˜¯å°†æ‰§è¡Œä»»åŠ¡çš„å†™çº¿ç¨‹ä»runnerå±æ€§ä¸­å–å‡ºç„¶åè°ƒç”¨interuptä¿¡å·ï¼Œè¿™é‡Œçœç•¥</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// </span>
    
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€šè¿‡åˆ†ææºç ï¼Œæˆ‘ä»¬å‘ç°Futureè·å–ç»“æœçš„æ–¹å¼æ˜¯é€šè¿‡é˜»å¡å®ç°çš„ï¼Œä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚ä½•é¿å…é˜»å¡å‘¢ï¼Ÿ</p>
<h2 id="CompletableFuture-ä»¥ä¸‹ç®€ç§°CF"><a href="#CompletableFuture-ä»¥ä¸‹ç®€ç§°CF" class="headerlink" title="CompletableFuture(ä»¥ä¸‹ç®€ç§°CF)"></a>CompletableFuture(ä»¥ä¸‹ç®€ç§°CF)</h2><h3 id="ä¸ºä½•ä¼šé€‰æ‹©CFå‘¢ï¼Ÿ"><a href="#ä¸ºä½•ä¼šé€‰æ‹©CFå‘¢ï¼Ÿ" class="headerlink" title="ä¸ºä½•ä¼šé€‰æ‹©CFå‘¢ï¼Ÿ"></a>ä¸ºä½•ä¼šé€‰æ‹©CFå‘¢ï¼Ÿ</h3><ul>
<li>å¯ç»„åˆï¼šå¯ä»¥å°†å¤šä¸ªä¾èµ–æ“ä½œé€šè¿‡ä¸åŒçš„æ–¹å¼è¿›è¡Œç¼–æ’</li>
<li>æ“ä½œèåˆï¼šå°†æ•°æ®æµä¸­ä½¿ç”¨çš„å¤šä¸ªæ“ä½œç¬¦ä»¥æŸä¸­æ–¹å¼ç»„åˆèµ·æ¥ä»è€Œé™ä½å¼€é”€</li>
<li>å»¶è¿Ÿæ‰§è¡Œ</li>
<li>å­¦ä¹ æˆæœ¬ä½</li>
<li>ç›¸æ¯”äºåªèƒ½é€šè¿‡é˜»å¡æˆ–è€…è½®è¯¢è·å¾—ç»“æœè€Œä¸”ä¸æ”¯æŒå›è°ƒæ–¹æ³•çš„Futureï¼ŒCFæ”¯æŒå›è°ƒçš„æ–¹å¼è¿›è¡Œå¤„ç†ç»“æœï¼ŒåŒæ—¶æ”¯æŒç»„åˆæ“ä½œæ”¯æŒè¿›ä¸€æ­¥çš„ç¼–æ’</li>
</ul>
<h4 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h4><p>è®©æˆ‘ä»¬é¦–å…ˆå…³æ³¨å®ƒçš„å®šä¹‰</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥å‘ç°å¥¥ç§˜å°±åœ¨<code>CompletionStage</code>è¿™ä¸ªæ¥å£ä¸­ï¼Œ<code>CompletionStage</code>ç”¨äºæ ‡è¯†æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ­¥éª¤(Stage)ï¼Œä»è€Œå®ç°äº†æœåŠ¡ç¼–æ’</p>
<h4 id="CompletionStage"><a href="#CompletionStage" class="headerlink" title="CompletionStage"></a>CompletionStage</h4><p>å®šä¹‰äº†ä¸€ç³»åˆ—ä»»åŠ¡çš„æ­¥éª¤ï¼Œå…·ä½“å®ç°çœ‹CompletableFutureæ˜¯å¦‚ä½•å®ç°çš„</p>
<h4 id="åŸºæœ¬å±æ€§"><a href="#åŸºæœ¬å±æ€§" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token comment">// ç”¨äºå­˜å‚¨å½“å‰CFçš„ç»“æœ	</span>
	<span class="token keyword">volatile</span> <span class="token class-name">Object</span> result<span class="token punctuation">;</span>      
	<span class="token comment">// stackç”¨äºè¡¨ç¤ºå½“å‰CFå®Œæˆåéœ€è¦è§¦å‘çš„ä¾èµ–åŠ¨ä½œ</span>
    <span class="token keyword">volatile</span> <span class="token class-name">Completion</span> stack<span class="token punctuation">;</span>    
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»è¿™é‡Œæˆ‘ä»¬çœ‹å‡ºï¼Œä½¿ç”¨äº†ç±»ä¼¼äºâ€è§‚å¯Ÿè€…â€æ¨¡å¼è®¾è®¡æ€æƒ³ï¼Œè¢«è§‚å¯Ÿè€…æ˜¯CompletableFutureï¼Œè€Œè§‚å¯Ÿè€…æ˜¯è¿™äº›éœ€è¦å›è°ƒçš„ä¾èµ–åŠ¨ä½œ</p>
<h4 id="Completionçš„å®šä¹‰"><a href="#Completionçš„å®šä¹‰" class="headerlink" title="Completionçš„å®šä¹‰"></a>Completionçš„å®šä¹‰</h4><p>Completionæ˜¯å®šä¹‰åœ¨CompletableFutureé‡Œçš„</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Completion</span> <span class="token keyword">extends</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span>
       <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">,</span> <span class="token class-name">AsynchronousCompletionTask</span> <span class="token punctuation">{</span>
       <span class="token keyword">volatile</span> <span class="token class-name">Completion</span> next<span class="token punctuation">;</span>      <span class="token comment">// Treiber stack link</span>

       <span class="token comment">/**
        * Performs completion action if triggered, returning a
        * dependent that may need propagation, if one exists.
        *
        * @param mode SYNC, ASYNC, or NESTED
        */</span>
       <span class="token keyword">abstract</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryFire</span><span class="token punctuation">(</span><span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">/** Returns true if possibly still triggerable. Used by cleanStack. */</span>
       <span class="token keyword">abstract</span> <span class="token keyword">boolean</span> <span class="token function">isLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">{</span> <span class="token function">tryFire</span><span class="token punctuation">(</span><span class="token constant">ASYNC</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
       <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span> <span class="token function">tryFire</span><span class="token punctuation">(</span><span class="token constant">ASYNC</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
       <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Void</span> <span class="token function">getRawResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
       <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setRawResult</span><span class="token punctuation">(</span><span class="token class-name">Void</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="ä¾èµ–çš„æµç¨‹"><a href="#ä¾èµ–çš„æµç¨‹" class="headerlink" title="ä¾èµ–çš„æµç¨‹"></a>ä¾èµ–çš„æµç¨‹</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token function">thenApply</span><span class="token punctuation">(</span>  
    <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token function">uniApplyStage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">uniApplyStage</span><span class="token punctuation">(</span>  
    <span class="token class-name">Executor</span> e<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">Object</span> r<span class="token punctuation">;</span>  
    <span class="token comment">// å¦‚æœå·²ç»ä»»åŠ¡å·²ç»å®Œæˆäº†ï¼Œç›´æ¥è°ƒç”¨uniApplyNow</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> result<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>  
        <span class="token keyword">return</span> <span class="token function">uniApplyNow</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> e<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„æœªå®ŒæˆCompletableFuture</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> d <span class="token operator">=</span> <span class="token function">newIncompleteFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token comment">// å°†è¿™ä¸ªæ–°çš„UniApplyå‹æ ˆ </span>
    <span class="token function">unipush</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UniApply</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> d<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">uniApplyNow</span><span class="token punctuation">(</span>  
    <span class="token class-name">Object</span> r<span class="token punctuation">,</span> <span class="token class-name">Executor</span> e<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token class-name">Throwable</span> x<span class="token punctuation">;</span>  
	<span class="token comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„CompletableFuture</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> d <span class="token operator">=</span> <span class="token function">newIncompleteFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token keyword">instanceof</span> <span class="token class-name">AltResult</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AltResult</span><span class="token punctuation">)</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span>ex<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            d<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token function">encodeThrowable</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">return</span> d<span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>        r <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
			<span class="token comment">// ä¸æ˜¯å¼‚å¸¸å°±æ‰§è¡Œæ–°çš„UniApplyä»»åŠ¡</span>
            e<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UniApply</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span> <span class="token class-name">T</span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> r<span class="token punctuation">;</span>  
            d<span class="token punctuation">.</span>result <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">encodeValue</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        d<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token function">encodeThrowable</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>    <span class="token keyword">return</span> d<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

 <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">unipush</span><span class="token punctuation">(</span><span class="token class-name">Completion</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// å°è¯•å°†cå‹æ ˆï¼ŒçŸ¥é“æˆåŠŸæˆ–è€…ä»»åŠ¡å®Œæˆä¸ºæ­¢</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryPushStack</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token constant">NEXT</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                c<span class="token punctuation">.</span><span class="token function">tryFire</span><span class="token punctuation">(</span><span class="token constant">SYNC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>ç®€å•ç†è§£ä¸€ä¸‹å°±æ˜¯ï¼Œåœ¨CFå®Œæˆä»»åŠ¡æ—¶ï¼Œä¼šå»è§‚å¯Ÿè€…é“¾ä¸­å‡ºæ ˆä¸€ä¸ªï¼Œç„¶åæ‰§è¡Œï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªæ–°çš„CompletableFutureï¼Œç„¶ååç»­ç»§ç»­å»å®Œæˆåç»­ä¾èµ–ä»»åŠ¡</li>
<li>å¦‚æœåŸå§‹ä»»åŠ¡è¿˜æ²¡å®Œæˆï¼Œé‚£ä¹ˆå°±ä¼šå°†æ–°çš„ä»»åŠ¡æ¨å…¥æ ˆä¸­ï¼Œç­‰å¾…åŸå§‹ä»»åŠ¡å®Œæˆ</li>
</ul>
<h4 id="æ‰§è¡Œè¿‡ç¨‹"><a href="#æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="æ‰§è¡Œè¿‡ç¨‹"></a>æ‰§è¡Œè¿‡ç¨‹</h4><p>ä»¥ supplyAsyncä¸ºä¾‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// æœ‰è‡ªå®šä¹‰çº¿ç¨‹æ± çš„è°ƒç”¨å‡½æ•°</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> supplier<span class="token punctuation">,</span>  
                                                   <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token function">asyncSupplyStage</span><span class="token punctuation">(</span><span class="token function">screenExecutor</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">,</span> supplier<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

<span class="token comment">// æ²¡æœ‰è‡ªå®šä¹‰çº¿ç¨‹æ± ä¼šä½¿ç”¨è‡ªå¸¦çš„çº¿ç¨‹æ± </span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Executor</span> <span class="token constant">ASYNC_POOL</span> <span class="token operator">=</span> <span class="token constant">USE_COMMON_POOL</span> <span class="token operator">?</span>  
    <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span><span class="token function">commonPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPerTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> supplier<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token function">asyncSupplyStage</span><span class="token punctuation">(</span><span class="token constant">ASYNC_POOL</span><span class="token punctuation">,</span> supplier<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
<span class="token comment">// å®é™…æ‰§è¡Œè€…</span>
<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token function">asyncSupplyStage</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> e<span class="token punctuation">,</span>  
                                                 <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// è°ƒç”¨çº¿ç¨‹æ± å»æ‰§è¡Œ</span>
    e<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AsyncSupply</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> d<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€šè¿‡é˜…è¯»æºç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼ŒåŸæ¥CompletableFutureæ‰§è¡Œä»»åŠ¡æ˜¯ä¼šä½¿ç”¨æˆ‘ä»¬æäº¤ç»™å®ƒçš„çº¿ç¨‹æ± æˆ–è€…å®ƒè‡ªå·±é»˜è®¤å»ç”Ÿæˆä¸€ä¸ªçº¿ç¨‹æ± å»æ‰§è¡Œçš„ï¼Œç›¸æ¯”FutureTaské€šè¿‡é˜»å¡å»ç­‰å¾…ç»“æœï¼Œç¡®å®æ˜¯æå‡äº†æ€§èƒ½ã€‚<br><strong>å…³äºçº¿ç¨‹æ± çš„æºç å’ŒåŸç†è§£æï¼Œä»¥åŠä¸€äº›å…«è‚¡çŸ¥è¯†ï¼Œæ¬¢è¿ç¿»çœ‹é„™äººçš„å¦ä¸€ç¯‡ã€Šæ·±å…¥æµ…å‡ºçº¿ç¨‹æ± ã€‹åšå®¢è§‚çœ‹</strong></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">QingQiu</p>
  <div class="site-description" itemprop="description">ä¸ªäººç½‘ç«™ï¼Œå­¦ä¹ è®°å½•ï¼Œé¢è¯•è®°å½•å’Œç»éªŒæ€»ç»“ã€äº’è”ç½‘ä¸­ä¸€å—å±äºè‡ªå·±çš„å°çª</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">57</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Zuofw/zuofw-rpc" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;Zuofw&#x2F;zuofw-rpc" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2022 â€“ 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">QingQiu</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">468k</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  















  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
